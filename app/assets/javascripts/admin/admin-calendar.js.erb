var statusIcon = [" blocked", " reserved", " confirmed", " completed", " payed", " cancelled", " noshow", " break"];
var backColors = ["#cacaca", "#77d0fa", "#fbe09f", "#fab5fb", "#adf0d1", "#FAFCAF", "#fbc1b3", "#a6a5a5"];
var textColors = ["#707070", "#0b587d", "#a78a47", "#8e508f", "#4c8b6e", "#505205", "#a15240", "#737373"];
var resourcesColors = [];
var servicesJSON;

var dragInProgress = false;
var dragUi = null;

var bookingBuffer = []

function showErrors (xhr) {
  var errors = $.parseJSON(xhr.responseText).errors;
  var errores = '';
  for (i in errors) {
    errores += '*' + errors[i] + '\n';
  }
  swal({
    title: "Error",
    text: "Se produjeron los siguientes errores:\n" + errors,
    type: "error"
  });
}

function loadProviders () {
  if (parseInt($('#locals-selector').val()) > 0) {
    var localId = parseInt($('#locals-selector').val());
    $('#providers-div').empty();
    $.getJSON('/location_services', {location: localId}, function (services) {
      servicesJSON = services;
      var resources = [];
      var count = 0;
      $.getJSON('/local_providers', {location: localId}, function (providersArray) {

        if (providersArray.length > 0) {
          $('#provider_break_service_provider_id').find('option').remove().end();
          $('#booking_service_provider_id').find('option').remove().end();
          $('#providers-div').append('<select class="form-control" id="providers-selector"></select>');
          if (providersArray.length > 1) {
            $('#providers-selector').append('<option value="0" data-resources="' + '' + '">Todos</option>');
            $('#provider_break_service_provider_id').append('<option value="0" data-block="' + $('#calendar-data').data('calendar-duration') + '">Todos</option>');
          }
          var provider_groups = $('#groups_data').data('provider-groups');
          if ($.grep(provider_groups, function(e) { return e.location_id == localId }).length > 1) {
            $('#providers-selector').append('<option disabled role=separator>--------</option>');
          }
          $.each(provider_groups, function (key, group) {
            if (group.location_id == localId) {
              $('#providers-selector').append('<option value="0" data-resources=\'[' + JSON.stringify(group.resources) + ']\'>' + group.name + '</option>');
            }
          });
          $('#providers-selector').append('<option disabled role=separator>--------</option>');
          $.each(providersArray, function (key, provider) {
            $('#providers-selector').append('<option name="providerRadio" value="'+provider.id+'" data-block="' + provider.block_length + '">'+provider.public_name+'</option>');
            resources.push({id: provider.id, name: provider.public_name});
            count += 1;
            $('#booking_service_provider_id')
            .append('<option value="'+ provider.id +'">'+ provider.public_name +'</option>')
            ;
            $('#provider_break_service_provider_id')
            .append('<option value="'+ provider.id +'">'+ provider.public_name +'</option>')
            ;
          });
          $('#providers-selector').change(function() {
            providerId = parseInt($('#providers-selector').val());
            if (providerId == 0) {
              if ( $('#providers-selector option:selected').data('resources').length > 0 ) {
                loadLocationTime (localId, $('#providers-selector option:selected').data('resources'));
              }
              else {
                loadLocationTime (localId, resources);
              }
            }
            else {
              loadProviderTime(providerId);
            }

          });
          if (providersArray.length > 1) {
            loadLocationTime (localId, resources);
          }
          else {
            loadProviderTime(parseInt($('#providers-selector').val()));
          }
          return true;
        }
        else {
          $('#providers-selector').append('<option value="0">Todos</option>');
        }
        loadWeekCalendar(0,24,[],[],0);
        return true;
      });
      return false;
    });
  }
  return false;
}

function getHour(str) {
  var index = str.indexOf('T'); //2000-1-1T08:00:00Z
  str = str.substring(index + 1, index + 6); //08:00
  return str;
}

function loadLocationTime (locationId, resources) {
  var extended_schedule_bool = $('#calendar-data').data('extended-schedule');
  if (extended_schedule_bool) {
    var extended_min_hour = $('#calendar-data').data('extended-min-hour');
    var extended_max_hour = $('#calendar-data').data('extended-max-hour');
    loadResourcesCalendar(extended_min_hour, extended_max_hour, [], resources, 0);
  }
  else {
    var min_hour = $('#locals-selector').find(':selected').data('minhour');
    var max_hour = $('#locals-selector').find(':selected').data('maxhour');
    loadResourcesCalendar(min_hour, max_hour, [], resources, 0);
  }
}

function loadProviderTime (providerId) {
  var extended_schedule_bool = $('#calendar-data').data('extended-schedule');
  if (extended_schedule_bool) {
    var extended_min_hour = $('#calendar-data').data('extended-min-hour');
    var extended_max_hour = $('#calendar-data').data('extended-max-hour');
    loadWeekCalendar(extended_min_hour, extended_max_hour, [], [], providerId);
  }
  else {
    var min_hour = $('#locals-selector').find(':selected').data('minhour');
    var max_hour = $('#locals-selector').find(':selected').data('maxhour');
    loadWeekCalendar(min_hour, max_hour, [], [], providerId);
  }
}

function setAspectRatio() {
  var calendarWidth = $('#calendar').outerWidth();
  var calendarHeader = 38; //Altura del header del calendario
  var headerHeight = $('.navbar-admin').outerHeight();
  var selectsHeight = $('.background-grey').outerHeight();
  var margin = 5; //Margen entre el calendario y la barra

  var height = window.innerHeight - headerHeight - calendarHeader - selectsHeight - margin;
  return calendarWidth / height;
}

var bookingModalOpen = false;
var duration = $('#calendar-data').data('calendar-duration');
function loadResourcesCalendar (startTime, endTime, hiddenDays, resourcesArray, providerId) {
  //Default values
  startTime = startTime || 0;
  endTime = endTime || 24;
  // var startHour = startTime || 9;
  hiddenDays = [];

  $('#calendar').fullCalendar('removeEvents');
  $('#calendar').empty();
  $('#calendar').fullCalendar({
    header: {
      left: 'title',
      center: 'prev,today,next',
      right: ''
    },
    hiddenDays: hiddenDays,
    resources: resourcesArray,
    eventClick: function(event) {
      if (!bookingModalOpen) {
        bookingModalOpen = true;
        editBookingModal(event.id);
      };
    },
    dayClick: function(date, allDay, jsEvent, view) {
      var p = $('#popover').parent();
      $('#popover').empty();
      $('#popover').removeClass('popover-right').removeClass('popover-left');
      $('#popover').html('<a id="closePopover" class="closePopover"><i class="fa fa-times"></i></a><br /><a id="bookingPopover" class="actionPopover">Agregar Reserva</a><br /><a id="breakPopover" class="actionPopover">Bloquear Horario</a>');
      var offX  = (jsEvent.offsetX || jsEvent.clientX - $(jsEvent.target).offset().left);

      if (offX + 75 > p.width() - 150) {
        $('#popover').addClass('popover-left');
        offX = offX - 150;
      }
      else {
        $('#popover').addClass('popover-right');
      }

      $('#popover').css('left', offX + 75 + 'px');
      $('#popover').css('top', jsEvent.pageY - p.offset().top - 35 + 'px');


      var column_click = $(this).context.cellIndex;
      var resourceId = view.resources[column_click - 1].id
      $('#closePopover').click(function() {
        $('#popover').hide();
      });
      $('#bookingPopover').click(function() {
        if (!bookingModalOpen) {
          bookingModalOpen = true;
          createBookingModal(date, resourceId);

        };
        $('#popover').hide();
      });
      $('#breakPopover').click(function() {
        createBreakModal(date, resourceId);
        $('#popover').hide();
      });
      $('#popover').show();
    },

    eventRender: function(event, element) {
      if ($.isNumeric(event.id)) {
        var prepayed = event.prepayed_qtip;
          if (prepayed === undefined)
          {
            prepayed = "No";
          }
          var is_event_session = event.is_session_qtip;
          if (is_event_session === undefined)
          {
            is_event_session = false;
          }
          if (is_event_session)
          {
            element.qtip({
             content: {
              button: true,
              title: event.title_qtip,
              text: 'Horario: ' + event.time_qtip + '<br/>' +
              'Servicio: ' + event.service_qtip + '<br/>' +
              'Teléfono: ' + event.phone_qtip + '<br/>' +
              'E-mail: ' + event.email_qtip + '<br/>' +
              'CI: ' + event.identification_number_qtip + '<br/>' +
              'Comentario: ' + event.comment_qtip + '<br />' +
              'Pagado: ' + prepayed + '<br />' +
              event.sessions_ratio_qtip
             },
             position: {
              my: 'bottom center',  // el triángulo sale de abajo al medio
              at: 'top center' // se ubica arriba del elemento en cuestión
             },
             style: {
              classes: 'qtip-bootstrap'
             },
             hide: {
              event: 'click mouseleave unfocus',
              leave: true,
              fixed: true
            },
            events: {
                  show: function(event, api) {
                    if(dragInProgress)
                    {
                        event.preventDefault();
                      }
                  }
              }
            });
          }
          else
          {
            element.qtip({
             content: {
              button: true,
              title: event.title_qtip,
              text: 'Horario: ' + event.time_qtip + '<br/>' +
              'Servicio: ' + event.service_qtip + '<br/>' +
              'Teléfono: ' + event.phone_qtip + '<br/>' +
              'E-mail: ' + event.email_qtip + '<br/>' +
              'CI: ' + event.identification_number_qtip + '<br/>' +
              'Comentario: ' + event.comment_qtip + '<br />' +
              'Pagado: ' + prepayed
             },
             position: {
              my: 'bottom center',  // el triángulo sale de abajo al medio
              at: 'top center' // se ubica arriba del elemento en cuestión
             },
             style: {
              classes: 'qtip-bootstrap'
             },
             hide: {
              event: 'click mouseleave unfocus',
              leave: true,
              fixed: true
            },
            events: {
                  show: function(event, api) {
                    if(dragInProgress)
                    {
                        event.preventDefault();
                      }
                  }
              }
            });
          }
      }
    },
    firstDay: 1,  //Lunes
    defaultView: 'resourceDay',
    allDaySlot: false,
    axisFormat: 'HH:mm',
    timeFormat: 'HH:mm{ - HH:mm}',
    columnFormat: {
      week: 'ddd d/M',
      day: 'dddd d/M'
    },
    titleFormat: {
      week: 'MMM d[ yyyy]{ &#8212;[ MMM] d yyyy}',
      day: 'dddd, d MMM yyyy'
    },
    buttonText: {
      prev:     '&lsaquo;', // <
      next:     '&rsaquo;', // >
      today:    'Hoy',
      week:     '<i class="fa fa-calendar"></i>  Semana',
      day:      '<i class="fa fa-calendar"></i>  Día',
      resourceDay: '<i class="fa fa-calendar"></i>  Día'
    },
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    minTime: startTime,
    maxTime: endTime,
    // firstHour: startHour,
    defaultEventMinutes: duration,
    editable: true,
    disableResizing: true,
    eventDragStart: function(event, jsEvent, ui, view){
      ui.helper.qtip('hide');
      dragInProgress = true;
      dragUi = ui;
    },
    eventDragStop: function(event, jsEvent, ui, view){
      dragInProgress = false;
      dragUi = null;
    },
    eventDrop: function (event) {
      editDrag(event);
      dragInProgress = false;
      dragUi = null;
    },
    slotMinutes: duration,
    aspectRatio: setAspectRatio(),
    windowResize: function(view) {
      $('#calendar').fullCalendar('option', 'aspectRatio', setAspectRatio());
    }
  });
  $('.fc-button').click(function (event) {
    var providerId = parseInt($('#providers-selector').val());
    loadProviderEvents(providerId);
  });
  loadProviderEvents(providerId);
}

function loadWeekCalendar (startTime, endTime, hiddenDays, resourcesArray, providerId) {
  //Default values

  startTime = startTime || 0;
  endTime = endTime || 24;
  // var startHour = startTime || 9;
  // hiddenDays = $('#locals-selector').find(':selected').data('closed-days');
  hiddenDays = []

  $('#calendar').fullCalendar('removeEvents');
  $('#calendar').empty();
  $('#calendar').fullCalendar({
    header: {
      left: 'title',
      center: 'prev,today,next',
      right: ''
    },
    hiddenDays: [ 2, 4 ] ,
    resources: resourcesArray,
    eventClick: function(event) {
      if (!bookingModalOpen) {
        bookingModalOpen = true;
        editBookingModal(event.id);
      };
    },
    dayClick: function(date, allDay, jsEvent, view) {
      var p = $('.popover').parent();
      $('.popover').empty();
      $('#popover').removeClass('popover-right').removeClass('popover-left');
      $('.popover').html('<a id="closePopover" class="closePopover"><i class="fa fa-times"></i></a><br /><a id="bookingPopover" class="actionPopover">Agregar Reserva</a><br /><a id="breakPopover" class="actionPopover">Bloquear Horario</a>');
      var offX  = (jsEvent.offsetX || jsEvent.clientX - $(jsEvent.target).offset().left);

      if (offX + 75 > p.width() - 150) {
        $('#popover').addClass('popover-left');
        offX = offX - 150;
      }
      else {
        $('#popover').addClass('popover-right');
      }

      $('.popover').css('left', offX + 60 + 'px');
      $('.popover').css('top', jsEvent.pageY - p.offset().top - 40 + 'px');
      $('#closePopover').click(function() {
        $('.popover').hide();
      });
      $('#bookingPopover').click(function() {
        if (!bookingModalOpen) {
          bookingModalOpen = true;
          createBookingModal(date);
        };
        $('.popover').hide();
      });
      $('#breakPopover').click(function() {
        createBreakModal(date);
        $('.popover').hide();
      });
      $('.popover').show();
    },

    eventRender: function(event, element) {
       if ($.isNumeric(event.id)) {
         if ($.isNumeric(event.id)) {
            var prepayed = event.prepayed_qtip;
            if (prepayed === undefined)
            {
              prepayed = "No";
            }
            var prepayed = event.prepayed_qtip;
            if (prepayed === undefined)
            {
              prepayed = "No";
            }
            var is_event_session = event.is_session_qtip;
            if (is_event_session === undefined)
            {
              is_event_session = false;
            }
            if(is_event_session)
            {
              element.qtip({
               content: {
                 button: true,
                 title: event.title_qtip,
                 text: 'Horario: ' + event.time_qtip + '<br/>' +
                     'Servicio: ' + event.service_qtip + '<br/>' +
                     'Teléfono: ' + event.phone_qtip + '<br/>' +
                     'E-mail: ' + event.email_qtip + '<br/>' +
                     'CI: ' + event.identification_number_qtip + '<br/>' +
                     'Comentario: ' + event.comment_qtip + '<br />' +
                     'Pagado: ' + prepayed + '<br />' +
                     event.sessions_ratio_qtip
               },
               position: {
                 my: 'bottom center',  // el triángulo sale de abajo al medio
                 at: 'top center' // se ubica arriba del elemento en cuestión
               },
               style: {
                 classes: 'qtip-bootstrap'
               },
               hide: {
                 event: 'click mouseleave unfocus',
                 leave: true,
                 fixed: true
               },
               events: {
                    show: function(event, api) {
                      if(dragInProgress)
                      {
                          event.preventDefault();
                        }
                    }
                }
              });
            }
            else
            {
              element.qtip({
               content: {
                 button: true,
                 title: event.title_qtip,
                 text: 'Horario: ' + event.time_qtip + '<br/>' +
                     'Servicio: ' + event.service_qtip + '<br/>' +
                     'Teléfono: ' + event.phone_qtip + '<br/>' +
                     'E-mail: ' + event.email_qtip + '<br/>' +
                     'CI: ' + event.identification_number_qtip + '<br/>' +
                     'Comentario: ' + event.comment_qtip + '<br />' +
                     'Pagado: ' + prepayed
               },
               position: {
                 my: 'bottom center',  // el triángulo sale de abajo al medio
                 at: 'top center' // se ubica arriba del elemento en cuestión
               },
               style: {
                 classes: 'qtip-bootstrap'
               },
               hide: {
                 event: 'click mouseleave unfocus',
                 leave: true,
                 fixed: true
               },
               events: {
                    show: function(event, api) {
                      if(dragInProgress)
                      {
                          event.preventDefault();
                        }
                    }
                }
              });
          }
         }
      }
    },
    firstDay: 1,  //Lunes
    defaultView: 'agendaWeek',
    allDaySlot: false,
    axisFormat: 'HH:mm',
    timeFormat: 'HH:mm{ - HH:mm}',
    columnFormat: {
      week: 'ddd d/M',
      day: 'dddd d/M'
    },
    titleFormat: {
      week: 'MMM d[ yyyy]{ &#8212;[ MMM] d yyyy}',
      day: 'dddd, d MMM yyyy'
    },
    buttonText: {
      prev:     '&lsaquo;', // <
      next:     '&rsaquo;', // >
      today:    'Hoy',
      week:     '<i class="fa fa-calendar"></i>  Semana',
      day:      '<i class="fa fa-calendar"></i>  Día'
    },
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    minTime: startTime,
    maxTime: endTime,
    // firstHour: startHour,
    defaultEventMinutes: $('#providers-selector option:selected').data("block"),
    editable: true,
    disableResizing: true,
    eventDragStart: function(event, jsEvent, ui, view){
      ui.helper.qtip('hide');
      dragInProgress = true;
      dragUi = ui;
    },
    eventDragStop: function(event, jsEvent, ui, view){
      dragInProgress = false;
      dragUi = null;
    },
    eventDrop: function (event) {
      editDrag(event);
      dragInProgress = false;
      dragUi = null;
    },
    slotMinutes: $('#providers-selector option:selected').data("block"),
    aspectRatio: setAspectRatio(),
    windowResize: function(view) {
      $('#calendar').fullCalendar('option', 'aspectRatio', setAspectRatio());
    }
  });
  $('.fc-button').click(function () {
    var providerId = parseInt($('#providers-selector').val());
    loadProviderEvents(providerId);
  });
  loadProviderEvents(providerId);
}

var ajaxRequest;
function loadProviderEvents(providerId) {
  $('#small_loader_header').remove();
  $(".fc-button").css("display", "none");
  $(".fc-header-center").append('<span id="small_loader_header"><i class="fa fa-spinner fa-spin"></i> </span>');
  var localId = parseInt($('#locals-selector').val());
  var start = $('#calendar').fullCalendar('getView').visStart;
  var end = $('#calendar').fullCalendar('getView').visEnd;
  var startParam = start.getFullYear()+'-'+(start.getMonth()+1)+'-'+start.getDate();
  var endParam = end.getFullYear()+'-'+(end.getMonth()+1)+'-'+end.getDate();
  $('#calendar').fullCalendar('removeEvents');

  if (ajaxRequest != null) {
    ajaxRequest.abort();
  }

  ajaxRequest = $.getJSON('/booking', {location: localId, provider: providerId, start: startParam, end: endParam}, function (events_list) {
    $('#calendar').fullCalendar('addEventSource', events_list);
    $('#small_loader_header').remove();
    $(".fc-button").css("display", "inline-block");
    $(".hours-optimizer-button").show();
  });
  return false;
}

function editBookingModal(eventId) {

  $("#treatment_price_div").hide();
  $("#treatment_price").text("");

  $("#is_edit_modal").val("1");
  $("#full_name").attr("disabled", false);
  $("#xButton").attr("disabled", false);
  if (eventId.toString().indexOf('b') >= 0) {
    editBreakModal(eventId.split('b')[1]);
  }
  else if (eventId.toString().indexOf('p') >= 0) {
    bookingModalOpen = false;
    return false;
  }
  else {
    $.getJSON('/bookings/'+eventId, function (booking) {
      var start = booking.start || 0;
      var end = booking.end || 0;
      if (start != 0) {
        dateArray = start.toString().split('T');
        date = new Date(start)

        month = date.getMonth()+1;
        day = date.getDate();

        output = (day<10 ? '0' : '') + day + '/' + (month<10 ? '0' : '') + month + '/' + date.getFullYear();

        $('#datePicker').val(output);
        $('#bookingStartHour option[value="'+dateArray[1].split(':')[0]+'"]').attr("selected",true);
        $('#bookingStartMinute option[value="'+dateArray[1].split(':')[1]+'"]').attr("selected",true);
      }
      else {
        $('#datePicker').val('');
        $('#bookingStartHour').val('');
        $('#bookingStartMinute').val('');
      }
      if (end != 0) {
        dateArray = end.toString().split('T');
        $('#bookingEndHour option[value="'+dateArray[1].split(':')[0]+'"]').attr("selected",true);
        $('#bookingEndMinute option[value="'+dateArray[1].split(':')[1]+'"]').attr("selected",true);
      }
      else {
        $('#bookingEndHour').val('');
        $('#bookingEndMinute').val('');
      }
      $('#booking_service_provider_id option[value="'+booking.service_provider_id+'"]').attr("selected",true);
      $('#booking_status_id option[value="'+booking.status_id+'"]').attr("selected",true);
      $('#booking_price').val(booking.price);
      $('#booking_client_id').val(booking.client_id);
      loadClientHistory(eventId);
      $('#booking_client_first_name').val(booking.first_name);
      $('#booking_client_last_name').val(booking.last_name);
      $('#booking_client_identification_number').val(booking.identification_number);
      $('#full_name').val(booking.first_name+' '+booking.last_name);
      $("#full_name").prop('disabled', true);
      $('#xButton').prop('disabled', false);
      $('#booking_client_email').val(booking.email);
      $('#booking_client_phone').val(booking.phone);
      $('#booking_client_address').val(booking.address);
      $('#booking_client_district').val(booking.district);
      $('#booking_client_city').val(booking.city);
      $('#booking_client_birth_day option[value=""]').prop('selected', true);
      $('#booking_client_birth_month option[value=""]').prop('selected', true);
      $('#booking_client_birth_year option[value=""]').prop('selected', true);
      $('#booking_client_birth_day option[value="'+booking.birth_day+'"]').attr("selected",true);
      $('#booking_client_birth_month option[value="'+booking.birth_month+'"]').attr("selected",true);
      $('#booking_client_birth_year option[value="'+booking.birth_year+'"]').attr("selected",true);
      $('#booking_client_age').val(booking.age);
      $('#booking_client_second_phone').val(booking.second_phone);
      $('#booking_client_record').val(booking.record);
      $('.client_link').attr('href','/clients/' + booking.client_id + '/edit');
      $('.client_link').html('Ir a la ficha del cliente...');
      $('#booking_client_gender option[value="'+booking.gender+'"]').attr("selected",true);
      $('#booking_notes').val(booking.notes);
      $('#booking_company_comment').val(booking.company_comment);
      $('#booking_staff_code').val('');
      $('#booking_deal_code').val(booking.deal_code);
      if (booking.provider_lock) {
        $('#booking_provider_lock').prop('checked', true);
        $('#booking_service_provider_id').prop('disabled', true);
      }
      else {
        $('#booking_provider_lock').prop('checked', false);
        $('#booking_service_provider_id').prop('disabled', false);
      }
      if (booking.send_mail) {
        $('#booking_send_mail').val(1);
        $('#booking_send_mail').prop('checked', true);
        $('input[name="booking[send_mail]"]:first').val(1);
      }
      else {
        $('#booking_send_mail').val(0);
        $('#booking_send_mail').prop('checked', false);
        $('input[name="booking[send_mail]"]:first').val(0);
      };
      if (validEmail(booking.email)) {
        $('#booking_send_mail').prop('disabled', false);
        $('label[for=booking_send_mail]').removeClass('disabled');
      }

      else {
        $('#booking_send_mail').prop('disabled', true);
        $('label[for=booking_send_mail]').addClass('disabled');
      }

      if(booking.payed)
      {
        $("#is_prepayed").empty();
        $("#is_prepayed").append("Sí");
      }
      else
      {
        $("#is_prepayed").empty();
        $("#is_prepayed").append("No");
      }

      $('.booking-modal-title').empty();
      $('.booking-modal-footer').empty();
      $('.booking-modal-title').append('Editando Reserva');
      $('.booking-modal-footer').append(
        '<a class="btn btn-white pull-left" href="/bookings/' + eventId + '.pdf">Imprimir</a>' +
        '<button type="button" class="btn btn-default btn-close booking-button" data-dismiss="modal">Cerrar</button>' +
        '<button type="button" id="save_booking_button" class="btn btn-green booking-button" onclick="editBooking('+eventId+')">Guardar</button>'
      );
      $('#cancelBookingDiv').remove();
      $('#booking_status_id').closest('.col-md-6').append(
        '<div class="form-group" id="cancelBookingDiv">' +
        '<div class="col-sm-offset-4 col-sm-8">' +
        '<button type="button" class="btn btn-red btn-ss btn-block booking-button" onclick="deleteBooking('+eventId+')" id="cancelBookingButton">Cancelar Reserva</button>' +
        '</div>' +
        '</div>'
      );

      if ( booking.service_provider_id > 0) {
        $.getJSON('/provider_services', {id: booking.service_provider_id}, function (services) {
          $('#booking_service_id').empty();
          $.each(services, function (key, service) {
            $('#booking_service_id').append(
              '<option value="' + service.id + '">' + service.name + '</option>'
            );
          });
          $('#booking_service_id option[value="'+booking.service_id+'"]').attr("selected",true);

          if(!booking.is_session)
          {
            $('#booking_service_id').removeAttr('disabled');
          }

          if (!booking.service_provider_active) {
            if ($('#booking_service_provider_id option[value="' + booking.service_provider_id + '"]').length == 0) {
              $('#booking_service_provider_id').append('<option value="' + booking.service_provider_id + '">' + booking.service_provider_name + '</option>');
            }
            $('#booking_service_provider_id option[value="'+booking.service_provider_id+'"]').attr("selected",true);
          }
          if (!booking.service_active) {
            if ($('#booking_service_id option[value="' + booking.service_id + '"]').length == 0) {
              $('#booking_service_id').append('<option value="' + booking.service_id + '">' + booking.service_name + '</option>');
            }
            $('#booking_service_id option[value="'+booking.service_id+'"]').attr("selected",true);
          }

        });
      }
      setAge();

      $("#sessions-row").hide();
      $("#has_sessions").val("0");

      if(booking.is_session)
      {

        $("#sessions-info").empty();
        $("#sessions-info").append("Esta reserva corresponde a la " + booking.sessions_ratio + " del servicio.");
        $("#sessions-row").show();

        checkTreatmentPrice(booking.service_id, booking.session_booking_id);
        //$("#xButton").attr("disabled", true);
      }

      $('#bookingModal #myTab').show();
      $('#bookingModal .booking-modal-footer').show();
      $('#bookingModal #payment_client_group').hide();
      $('#booking-tab').tab('show');
      $('#payments-li, #payments-li > a[data-toggle=tab]').removeClass('disabled');
      $('#bookingModal').modal('show');

      /*
      * Fill payment options
      */

      if(booking.payed_state)
      {
        $('#booking_payed_state').val("1");
        if(booking.payment_id)
        {
          $('#payed_state_fixed').text("Sí (Pago asociado)");
          $('#payed_state_select_div').hide();
          $('#payed_state_fixed_div').show();
        }
        else if(booking.payed_booking_id)
        {
          $('#payed_state_fixed').text("Sí (Pago en línea)");
          $('#payed_state_select_div').hide();
          $('#payed_state_fixed_div').show();
        }
        else
        {
          $('#payed_state_select_div').show();
          $('#payed_state_fixed_div').hide();
        }
      }
      else
      {
        $('#booking_payed_state').val("0");
        $('#payed_state_select_div').show();
        $('#payed_state_fixed_div').hide();
      }

      if($('#editable_payment_prices').val() == "0" && $('#is_admin_role').val() == "0")
      {
        $('#booking_price').attr("disabled", true);
      }
      else
      {
        $('#booking_price').attr("disabled", false);
      }

      checkBookingPayment(booking.id);

    });
  }
}

function createBookingModal(date, provider_id) {
  bookingBuffer = []
  var localId = parseInt($('#locals-selector').val());
  var date = date || 0;
  var provider_id = provider_id || 0;
  $("#sessions-row").hide();
  $("#is_edit_modal").val("0");
  $('#booking_service_id').empty();
  $("#treatment_price_div").hide();
  $("#treatment_price").text("");
  $('#payed_state_fixed_div').hide();
  $('#payed_state_select_div').show();
  $('#booking_payed_state').val("0");
  $('#is_prepayed').text("No");

  $.getJSON('/local_providers', {location: localId}, function (providersArray) {
    if (providersArray.length > 0) {
      if (date != 0) {
        dateArray = date.toString().split(' ');
        //Falta revisar el tema de las fechas, deberían ser contantes en la app
        $('#datePicker').val(dateArray[2]+'/'+dateArray[1]+'/'+dateArray[3]);
        $('#bookingStartHour option[value="'+dateArray[4].split(':')[0]+'"]').attr("selected",true);
        $('#bookingStartMinute option[value="'+dateArray[4].split(':')[1]+'"]').attr("selected",true);
        modalChange();
      }
      else {
        $('#datePicker').val('');
        $('#bookingStartHour').val('');
        $('#bookingStartMinute').val('');
      }
      if (parseInt($('#providers-selector').val()) > 0) {
        $('#booking_service_provider_id option[value="'+parseInt($('#providers-selector').val())+'"]').attr("selected",true);
        $.getJSON('/provider_services', {id: parseInt($('#providers-selector').val())}, function (services) {
          $('#booking_service_id').empty();
          $.each(services, function (key, service) {
            $('#booking_service_id').append(
              '<option value="' + service.id + '">' + service.name + '</option>'
              );
          });
          $('#booking_service_id').removeAttr('disabled');
          $('#booking_service_id option').first().attr("selected", true);
          modalChange();
          checkClientSessions(true);
        });
      }
      else {
        $('#booking_service_provider_id').val('');
      }
      $('#booking_status_id').val('1');
      $('#booking_price').val('');
      $('#booking_client_id').val('');
      $('#booking_client_first_name').val('');
      $('#booking_client_last_name').val('');
      $('#full_name').val('');
      $("#full_name").prop('disabled', false);
      $('#xButton').prop('disabled', true);
      $('#booking_client_identification_number').val('');
      $('#booking_client_email').val('');
      $('#booking_client_phone').val('');
      $('#booking_client_addrress').val('');
      $('#booking_client_district').val('');
      $('#booking_client_city').val('');
      $('#booking_client_birth_day option[value=""]').prop('selected', true);
      $('#booking_client_birth_month option[value=""]').prop('selected', true);
      $('#booking_client_birth_year option[value=""]').prop('selected', true);
      $('#booking_client_age').val('');
      $('#booking_client_second_phone').val('');
      $('#booking_client_record').val('');
      $('.client_link').attr('href','/clients');
      $('.client_link').html('Ir a fichas de clientes...');
      $('#booking_client_gender option[value="0"]').prop('selected', true);
      $('#booking_notes').val($('#calendar-data').data('preset-notes'));
      $('#booking_company_comment').val('');
      $('#booking_provider_lock').prop('checked', false);
      $('#booking_service_provider_id').prop('disabled', false);
      $('#booking_send_mail').val(0);
      $('#booking_send_mail').prop('checked', false);
      $('#booking_send_mail').prop('disabled', true);
      $('#booking_staff_code').val('');
      $('#booking_deal_code').val('');
      if (!$('label[for=booking_send_mail]').hasClass('disabled')) {
        $('label[for=booking_send_mail]').addClass('disabled');
      }
      $('.booking-modal-title').empty();
      $('.booking-modal-footer').empty();
      $('.booking-modal-title').append('Nueva Reserva');
        // '<button type="button" class="btn btn-agendapro-claro booking-button pull-left" data-toggle="modal" data-target="#hoursOptimizer">Buscador de Horas</button>' +
        $('.booking-modal-footer').append(
          '<button type="button" class="btn btn-default btn-close booking-button" data-dismiss="modal">Cerrar</button>' +
          '<button type="button" class="btn btn-orange booking-button" id="add-service-btn" onclick="addNewService()">Agregar Otro Servicio</button>' +
          '<button type="button" id="save_booking_button" class="btn btn-green booking-button" onclick="createBooking()">Guardar</button>'
          );

        if (provider_id) {
          $('#booking_service_provider_id').val(provider_id);
          $.getJSON('/provider_services', {id: provider_id}, function (services) {
            $('#booking_service_id').empty();
            $.each(services, function (key, service) {
              $('#booking_service_id').append(
                '<option value="' + service.id + '">' + service.name + '</option>'
                );
            });
            $('#booking_service_id').removeAttr('disabled');
            $('#booking_service_id option').first().attr("selected", true);
            modalChange();
            checkClientSessions(true);
          });
        };

        if($('#editable_payment_prices').val() == "0" && $('#is_admin_role').val() == "0")
        {
          $('#booking_price').attr("disabled", true);
        }
        else
        {
          $('#booking_price').attr("disabled", false);
        }

        $('#client-history-tbody').html('<tr><td colspan="6">El cliente no tiene historial...</td></tr>');
        $('#bookingModal #myTab').show();
        $('#bookingModal .booking-modal-footer').show();
        $('#booking-tab').tab('show');
        $('#payments-li, #payments-li > a[data-toggle=tab]').addClass('disabled');
        $('#bookingModal #payment_client_group').hide();
        $('#bookingModal').modal('show');
      }
      else {
        swal({
          title: "Este local no tiene prestadores o servicios",
          text: "Por favor completa los datos necesarios para poder generar reservas en este local.",
          type: "error"
        });
        bookingModalOpen = false;
      }
    });
}

function editBooking(eventId) {
  if ($('#new_booking').valid()) {
    $('.booking-button').attr("disabled", "disabled");
    $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );
    saveBooking('PATCH','/'+eventId);
  };
}

function createBooking() {
  if ($('#new_booking').valid()) {
    var strict_booking = $('#calendar-data').data('strict-booking');
    var client_email = $.trim($('#booking_client_email').val());
    var client_phone = $.trim($('#booking_client_phone').val());
    if (strict_booking && (client_email == null || client_email == "") && (client_phone == null || client_phone == "")) {
      swal({
        title: "Datos Incompletos",
        text: "Por favor completa el email o teléfono del Cliente.",
        type: "error"
      });
    } else{
      $('.booking-button').attr("disabled", "disabled");
      $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );
      saveBooking('POST','');
    };
  };
}

function addNewService () {
  if ($('#new_booking').valid()) {
    $('.booking-button').prop('disabled', true);
    $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );

    var booking = jsonBooking();
    booking_valid(booking);
  };
}

function booking_valid (booking) {
  $.ajax({
    type: 'POST',
    url: '/booking_valid.json',
    data: { "booking": booking },
    dataType: 'json',
    success: function (result) {
      bookingBuffer.push(booking);

      $('#bookingStartHour').val($('#bookingEndHour').val());
      $('#bookingStartMinute').val($('#bookingEndMinute').val());
      $('#bookingEndHour').val('');
      $('#bookingEndMinute').val('');
      $('#booking_provider_lock').prop('checked', false);
      $('#booking_service_id').val('');
      $('#booking_price').val(0);
      $('#booking_notes').val('');
      $('#booking_company_comment').val('');

      validator.resetForm();
      $('.has-feedback').removeClass('has-success has-error');
      $('.form-control-feedback').removeClass('fa fa-check fa-times');

      $('.booking-button').prop("disabled", false);
      $('#small_loader').remove();
    },
    error: function (xhr) {
      showErrors(xhr);
      $('.booking-button').prop("disabled", false);
      $('#small_loader').remove();
    },
  });
}

function deleteBooking(eventId) {
  // Staff code
  var confirmation = false;
  var isFirefox = navigator.userAgent.search("Firefox") >= 0;
  var defaultTop = $('#bookingModal').css('top');

  if ($('#calendar-data').data('staff-code')) {
    if( isFirefox ) {
      // TempFix for firefox input Modal Over Modal swal
      $('#bookingModal').css('top', '-180px');
    }

    swal({
      title: "¿Estás seguro que quieres cancelar esta reserva?",
      text: "Esta acción no se puede revertir.\nIngrese el código de Empleado:",
      type: "input",
      inputType: "password",
      showCancelButton: true,
      closeOnConfirm: false
    },
    function (inputValue) {
      if (inputValue === false) {
        $('#bookingModal').css('top', defaultTop);
        return false;
      }
      if (inputValue === "") {
        swal.showInputError("El código no puede estar en blanco.");
        return false;
      };
      $('#booking_staff_code').val(inputValue);
      $('.booking-button').attr("disabled", "disabled");
      $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );
      saveBooking('DELETE','/'+eventId);
      if( isFirefox ) { $('#bookingModal').css('top', defaultTop); }
    });
  } else{
    swal({
      title: "¿Estás seguro que quieres cancelar esta reserva?",
      text: "Esta acción no se puede revertir.",
      type: "warning",
      showCancelButton: true
    },
    function(isConfirm) {
      if (isConfirm) {
        $('.booking-button').attr("disabled", "disabled");
        $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );
        saveBooking('DELETE','/'+eventId);
      }
    });
  };
}

function jsonBooking() {
  var jsBooking = {
    "start": $('#datePicker').val() +"T"+ $('#bookingStartHour').val() +":"+ $('#bookingStartMinute').val() +":00Z",
    "end":$('#datePicker').val() +"T"+ $('#bookingEndHour').val() +":"+ $('#bookingEndMinute').val() +":00Z",
    "service_provider_id": parseInt($('#booking_service_provider_id').val()),
    "service_id": parseInt($('#booking_service_id').val()),
    "status_id": parseInt($('#booking_status_id').val()),
    "client_id": $('#booking_client_id').val(),
    "price": $('#booking_price').val(),
    "client_first_name": $('#booking_client_first_name').val(),
    "client_last_name": $('#booking_client_last_name').val(),
    "client_email": $('#booking_client_email').val(),
    "client_phone": $('#booking_client_phone').val(),
    "client_address": $('#booking_client_address').val(),
    "client_district": $('#booking_client_district').val(),
    "client_city": $('#booking_client_city').val(),
    "client_birth_day": parseInt($('#booking_client_birth_day').val()) > 0 ? parseInt($('#booking_client_birth_day').val()) : "",
    "client_birth_month": parseInt($('#booking_client_birth_month').val()) > 0 ? parseInt($('#booking_client_birth_month').val()) : "",
    "client_birth_year": parseInt($('#booking_client_birth_year').val()) > 0 ? parseInt($('#booking_client_birth_year').val()) : "",
    "client_age": $('#booking_client_age').val(),
    "client_record": $('#booking_client_record').val(),
    "client_second_phone": $('#booking_client_second_phone').val(),
    "client_gender": parseInt($('#booking_client_gender').val()) > 0 ? parseInt($('#booking_client_gender').val()) : "",
    "client_identification_number": $('#booking_client_identification_number').val(),
    "notes": $('#booking_notes').val(),
    "company_comment": $('#booking_company_comment').val(),
    "send_mail": $('#booking_send_mail').prop('checked'),
    "provider_lock": $('#booking_provider_lock').prop('checked'),
    "staff_code": $('#booking_staff_code').val(),
    "deal_code": $('#booking_deal_code').val(),
    "payed_state": $('#booking_payed_state').val()
  };
  if($("#has_sessions").val() == "1")
  {
    jsBooking["session_booking_id"] = $('[name="sessions-choice"]:checked').val();
  }
  else
  {
    delete jsBooking["session_booking_id"];
  }
  return jsBooking;
}

function editDrag(event) {
  var startDate = new Date(event.start);
  var endDate = new Date(event.end);
  var startString = startDate.getFullYear()+"-"+("0"+(startDate.getMonth()+1)).slice(-2)+"-"+("0"+startDate.getDate()).slice(-2)+"T"+startDate.getHours()+":"+startDate.getMinutes()+":00Z";
  var endString = endDate.getFullYear()+"-"+("0"+(endDate.getMonth()+1)).slice(-2)+"-"+("0"+endDate.getDate()).slice(-2)+"T"+endDate.getHours()+":"+endDate.getMinutes()+":00Z";

  var eventJSON = {start: startString, end: endString};
  if (event.resourceId) {
    $.extend(eventJSON, {service_provider_id: event.resourceId, provider_lock: false});
  }
  if (event.id.toString().charAt(0) === 'b') {
    var break_service_providers_ids = new Array();
    break_service_providers_ids.push(event.resourceId)
    $.extend(eventJSON, {service_provider_id: break_service_providers_ids, provider_lock: false});

    swal({
      title: "¿Estás seguro que deseas modificar el bloqueo de horario?",
      type: "warning",
      showCancelButton: true,
      closeOnConfirm: false
    },
    function (isConfirm) {
      if (isConfirm) {
        $.ajax({
          type: 'PATCH',
          url: '/provider_breaks/'+ event.id.substring(1) +'.json',
          data: { "provider_break": eventJSON },
          dataType: 'json',
          success: function(){
            swal({
              title: "Bloqueo actualizado exitosamente",
              type: "success"
            });
          },
          error: function(xhr){
            swal.close();
            showErrors(xhr);
            $.getJSON('/provider_breaks/'+event.id.substring(1), function (provider_break_json) {
              event.start = provider_break_json.provider_break.start;
              event.end = provider_break_json.provider_break.end;
              event.resourceId = provider_break_json.provider_break.service_provider_id;
              $('#calendar').fullCalendar('updateEvent', event);
            });
          }
        });
      } else{
        $.getJSON('/provider_breaks/'+event.id.substring(1), function (provider_break_json) {
          event.start = provider_break_json.provider_break.start;
          event.end = provider_break_json.provider_break.end;
          event.resourceId = provider_break_json.provider_break.service_provider_id;
          $('#calendar').fullCalendar('updateEvent', event);
        });
      };
    });
  } else {
    var text = '';
    if (event.resourceId) {
      text = 'Si la reserva tenía una preferencia de prestador, esta se perderá.\n';
    };
    // Staff code
    var confirmation = false;
    if ($('#calendar-data').data('staff-code')) {
      swal({
        title: "¿Estás seguro que deseas modificar la reserva?",
        text: text + "Ingrese el código de Empleado:",
        type: "input",
        inputType: "password",
        showCancelButton: true,
        closeOnConfirm: false
      },
      function (inputValue) {
        if (inputValue === false) {
          $.getJSON('/bookings/'+event.id, function (booking) {
            event.start = booking.start;
            event.end = booking.end;
            event.resourceId = booking.service_provider_id;
            $('#calendar').fullCalendar('updateEvent', event);
          });
          return false;
        }
        if (inputValue === "") {
          swal.showInputError("El código no puede estar en blanco.");
          return false;
        };
        $.extend(eventJSON, {staff_code: inputValue});
        $.ajax({
          type: 'PATCH',
          url: '/bookings/'+ event.id +'.json',
          data: { "booking": eventJSON },
          dataType: 'json',
          success: function(booking){
            var providerLock = '-unlock';
            if (booking.provider_lock) {
              providerLock = '-lock';
            };
            var originClass = 'origin-manual';
            if (booking.web_origin) {
              originClass = 'origin-web';
            };

            var payedState = '';
            if (booking.payed_state)
            {
              payedState = ' payed';
            }

            var backColor = backColors[booking.status_id];
            var textColor = textColors[booking.status_id];
            if (booking.is_session && !booking.user_session_confirmed)
            {
              backColor = "#105E82";
              textColor = "#DFDBDB";
            }

            originClass += providerLock + statusIcon[booking.status_id] + payedState;
            event.className = originClass;
            event.title = booking.first_name+' '+booking.last_name+' - '+booking.service_name;
            event.start = booking.start;
            event.end = booking.end;
            event.resourceId = booking.service_provider_id;
            event.textColor = textColor;
            event.borderColor = textColor;
            event.backgroundColor = backColor;
            event.className = originClass;
            event.title_qtip = booking.first_name+' '+booking.last_name;
            event.time_qtip = booking.start.substring(11,16) + ' - ' + booking.end.substring(11,16);
            event.service_qtip = booking.service_name;
            event.phone_qtip = booking.phone;
            event.email_qtip = booking.email;
            event.prepayed_qtip = booking.prepayed;
            event.comment_qtip = booking.company_comment;
            event.is_session_qtip = booking.is_session_booked;
            event.sessions_ratio_qtip = booking.sessions_ratio;
            $('#calendar').fullCalendar('updateEvent', event);
            if(!booking.is_session || (booking.is_session && booking.user_session_confirmed))
            {
              swal("Reserva actualizada exitosamente.");
            }
            else
            {
              swal("Se ha enviado un correo al cliente para que valide la sesión agendada.");
            }
            $('#bookingAlerts').hide();
            if (booking.warnings.length > 0) {
              $('#bookingWarnings').empty();
              var warnings = '';
              for (i in booking.warnings) {
                warnings += booking.warnings[i] + '. ';
              }
              $('#bookingWarnings').append(warnings);
              $('#bookingAlerts').show();
            }
          },
          error: function(xhr){
            showErrors(xhr);
            $.getJSON('/bookings/'+event.id, function (booking) {
              event.start = booking.start;
              event.end = booking.end;
              event.resourceId = booking.service_provider_id;
              $('#calendar').fullCalendar('updateEvent', event);
            });
          }
        });
      });
    } else {
      swal({
        title: "¿Estás seguro que deseas modificar la reserva?",
        text: text,
        type: "warning",
        showCancelButton: true,
        closeOnConfirm: false
      },
      function(isConfirm) {
        if(isConfirm) {
          $.ajax({
            type: 'PATCH',
            url: '/bookings/'+ event.id +'.json',
            data: { "booking": eventJSON },
            dataType: 'json',
            success: function(booking){
              var providerLock = '-unlock';
              if (booking.provider_lock) {
                providerLock = '-lock';
              };
              var originClass = 'origin-manual';
              if (booking.web_origin) {
                originClass = 'origin-web';
              };

              var payedState = '';
              if (booking.payed_state)
              {
                payedState = ' payed';
              }

              var backColor = backColors[booking.status_id];
              var textColor = textColors[booking.status_id];
              if (booking.is_session && !booking.user_session_confirmed)
              {
                backColor = "#105E82";
                textColor = "#DFDBDB";
              }

              originClass += providerLock + statusIcon[booking.status_id] + payedState;
              event.className = originClass;
              event.title = booking.first_name+' '+booking.last_name+' - '+booking.service_name;
              event.start = booking.start;
              event.end = booking.end;
              event.resourceId = booking.service_provider_id;
              event.textColor = textColor;
              event.borderColor = textColor;
              event.backgroundColor = backColor;
              event.className = originClass;
              event.title_qtip = booking.first_name+' '+booking.last_name;
              event.time_qtip = booking.start.substring(11,16) + ' - ' + booking.end.substring(11,16);
              event.service_qtip = booking.service_name;
              event.phone_qtip = booking.phone;
              event.email_qtip = booking.email;
              event.prepayed_qtip = booking.prepayed;
              event.comment_qtip = booking.company_comment;
              event.is_session_qtip = booking.is_session_booked;
              event.sessions_ratio_qtip = booking.sessions_ratio;
              $('#calendar').fullCalendar('updateEvent', event);
              if(!booking.is_session || (booking.is_session && booking.user_session_confirmed))
              {
                swal("Reserva actualizada exitosamente.");
              }
              else
              {
                swal("Se ha enviado un correo al cliente para que valide la sesión agendada.");
              }
              $('#bookingAlerts').hide();
              if (booking.warnings.length > 0) {
                $('#bookingWarnings').empty();
                var warnings = '';
                for (i in booking.warnings) {
                  warnings += booking.warnings[i] + '. ';
                }
                $('#bookingWarnings').append(warnings);
                $('#bookingAlerts').show();
              }
            },
            error: function(xhr){
              showErrors(xhr);
              $.getJSON('/bookings/'+event.id, function (booking) {
                event.start = booking.start;
                event.end = booking.end;
                event.resourceId = booking.service_provider_id;
                $('#calendar').fullCalendar('updateEvent', event);
              });
            }
          });
        } else {
          $.getJSON('/bookings/'+event.id, function (booking) {
            event.start = booking.start;
            event.end = booking.end;
            event.resourceId = booking.service_provider_id;
            $('#calendar').fullCalendar('updateEvent', event);
          });
        }
      });
    };
  }
}

function saveBooking(typeURL, extraURL) {
  var bookingJSON = jsonBooking();
  if (typeURL == 'POST') {
    $.ajax({
      type: 'POST',
      url: '/booking_valid.json',
      data: { "booking": bookingJSON },
      dataType: 'json',
      success: function (result) {
        bookingBuffer.push(bookingJSON);
        saveBookingBuffer();
      },
      error: function (xhr) {
        showErrors(xhr);
        $('.booking-button').prop("disabled", false);
        $('#small_loader').remove();
      },
    });
  } else {
    $.ajax({
      type: typeURL,
      url: '/bookings'+ extraURL +'.json',
      data: { "booking": bookingJSON },
      dataType: 'json',
      success: function(booking){
        switch(typeURL) {
          case 'PATCH':
          event = $('#calendar').fullCalendar('clientEvents', booking.id)[0];
          if (booking.status_id != 5) {
            var providerLock = '-unlock';
            if (booking.provider_lock) {
              providerLock = '-lock';
            };
            var originClass = 'origin-manual';
            if (booking.web_origin) {
              originClass = 'origin-web';
            };
            var backColor = backColors[booking.status_id];
            var textColor = textColors[booking.status_id];
            if (booking.is_session && !booking.user_session_confirmed)
            {
              backColor = "#105E82";
              textColor = "#DFDBDB";
            }

            var payedState = '';
            if (booking.payed_state)
            {
              payedState = ' payed';
            }

            originClass += providerLock + statusIcon[booking.status_id] + payedState;
            event.title = booking.first_name+' '+booking.last_name+' - '+booking.service_name;
            event.start = booking.start;
            event.end = booking.end;
            event.resourceId = booking.service_provider_id;
            event.textColor = textColor;
            event.borderColor = textColor;
            event.backgroundColor = backColor;
            event.className = originClass;
            event.title_qtip = booking.first_name+' '+booking.last_name;
            event.time_qtip = booking.start.substring(11,16) + ' - ' + booking.end.substring(11,16);
            event.service_qtip = booking.service_name;
            event.phone_qtip = booking.phone;
            event.email_qtip = booking.email;
            event.comment_qtip = booking.company_comment;
            event.prepayed_qtip = booking.prepayed;
            event.is_session_qtip = booking.is_session_booked;
            event.sessions_ratio_qtip = booking.sessions_ratio;

            var selectedProvider = parseInt($("#providers-selector option:selected").val());
            var eventProvider = parseInt(booking.service_provider_id);


            if(booking.is_session)
            {
              if(booking.is_session_booked)
              {
                if(selectedProvider == 0 || (selectedProvider == eventProvider))
                {
                  $('#calendar').fullCalendar('updateEvent', event);
                }
                else
                {
                  $('#calendar').fullCalendar('removeEvents',booking.id);
                }
              }
              else
              {
                $('#calendar').fullCalendar('removeEvents',booking.id);
              }
            }
            else
            {
              if(selectedProvider == 0 || (selectedProvider == eventProvider))
              {
                $('#calendar').fullCalendar('updateEvent', event);
              }
              else
              {
                $('#calendar').fullCalendar('removeEvents',booking.id);
              }
            }
            if(booking.is_session && !booking.user_session_confirmed)
            {
              swal("Se ha enviado un correo al cliente para que valide la sesión agendada.");
            }
          }
          else {
            $('#calendar').fullCalendar('removeEvents',booking.id);
          }
          $('#bookingAlerts').hide();
          if (booking.warnings.length > 0) {
            $('#bookingWarnings').empty();
            var warnings = '';
            for (i in booking.warnings) {
              warnings += booking.warnings[i] + '. ';
            }
            $('#bookingWarnings').append(warnings);
            $('#bookingAlerts').show();
          }
          break;
          case 'DELETE':
          $('#calendar').fullCalendar('removeEvents',booking.id);
          swal.close();
          break;
        }
        $('#bookingModal').modal('hide');
      },
      error: function(xhr){
        showErrors(xhr);
        $('.booking-button').removeAttr("disabled");
        $('#small_loader').remove();
      }
    });
};
}

function saveBookingBuffer () {
  $.ajax({
    type: 'POST',
    url: '/bookings.json',
    data: { "bookings": bookingBuffer },
    dataType: 'json',
    success: function(bookings){
      $('#bookingAlerts').hide();
      $('#bookingWarnings').empty();
      var warning = false;
      $.each(bookings, function (pos, booking) {
        if (booking.status_id != 5) {
          var providerLock = '-unlock';
          if (booking.provider_lock) {
            providerLock = '-lock';
          };
          var originClass = 'origin-manual';

          var payedState = '';
          if (booking.payed_state)
          {
            payedState = ' payed';
          }

          originClass += providerLock + statusIcon[booking.status_id] + payedState;
          var backColor = backColors[booking.status_id];
          var textColor = textColors[booking.status_id];
          if (booking.is_session && !booking.user_session_confirmed)
          {
            backColor = "#174F69";
            textColor = "#DFDBDB";
          }
          var events = {
            id: booking.id,
            title: booking.first_name+' '+booking.last_name+' - '+booking.service_name,
            allDay: false,
            start: booking.start,
            end: booking.end,
            resourceId: booking.service_provider_id,
            textColor: textColor,
            borderColor: textColor,
            backgroundColor: backColor,
            className: originClass,
            title_qtip: booking.first_name+' '+booking.last_name,
            time_qtip: booking.start.substring(11,16) + ' - ' + booking.end.substring(11,16),
            service_qtip: booking.service_name,
            phone_qtip: booking.phone,
            email_qtip: booking.email,
            comment_qtip: booking.company_comment,
            is_session_qtip: booking.is_session_booked,
            sessions_ratio_qtip: booking.sessions_ratio
          };

          $('#calendar').fullCalendar('renderEvent', events, true);
          if(booking.is_session && !booking.user_session_confirmed)
          {
            swal("Se ha enviado un correo al cliente para que valide la sesión agendada.");
          }
        }
        if (booking.warnings.length > 0) {
          var warnings = '';
          for (i in booking.warnings) {
            warnings += booking.warnings[i] + '. ';
          }
          $('#bookingWarnings').append(warnings);
          warning = true;
        }
      });
      if (warning) {
        $('#bookingAlerts').show();
      };
      $('#bookingModal').modal('hide');
    },
    error: function(xhr){
      var errors = $.parseJSON(xhr.responseText).errors;
      var errores = '';
      $.each(errors, function (booking, error) {
        errores += 'Servicio ' + error.booking + '\n';
        for (i in error.errors) {
          errores += ' * ' + error.errors[i] + '\n';
        }
      });
      errores += '\n¿Guardar de todos modos?'
      $('.booking-button').removeAttr("disabled");
      $('#small_loader').remove();
      swal({
        title: "No se pudo guardar todos los servicios",
        text: errores,
        type: "warning"
      },
      function (isConfirm) {
        if (isConfirm) {
          $.post('/force_create.json', { "bookings": bookingBuffer }, function (bookings) {
            $('#bookingAlerts').hide();
            $('#bookingWarnings').empty();
            var warning = false;
            $.each(bookings, function (pos, booking) {
              if (booking.status_id != 5) {
                var providerLock = '-unlock';
                if (booking.provider_lock) {
                  providerLock = '-lock';
                };

                var payedState = '';
                if (booking.payed_state)
                {
                  payedState = ' payed';
                }

                var originClass = 'origin-manual';
                originClass += providerLock + statusIcon[booking.status_id] + payedState;
                var backColor = backColors[booking.status_id];
                var textColor = textColors[booking.status_id];
                if (booking.is_session && !booking.user_session_confirmed)
                {
                  backColor = "#105E82";
                  textColor = "#DFDBDB";
                }
                var events = {
                  id: booking.id,
                  title: booking.first_name+' '+booking.last_name+' - '+booking.service_name,
                  allDay: false,
                  start: booking.start,
                  end: booking.end,
                  resourceId: booking.service_provider_id,
                  textColor: textColor,
                  borderColor: textColor,
                  backgroundColor: backColor,
                  className: originClass,
                  title_qtip: booking.first_name+' '+booking.last_name,
                  time_qtip: booking.start.substring(11,16) + ' - ' + booking.end.substring(11,16),
                  service_qtip: booking.service_name,
                  phone_qtip: booking.phone,
                  email_qtip: booking.email,
                  comment_qtip: booking.company_comment,
                  is_session_qtip: booking.is_session_booked,
                  sessions_ratio_qtip: booking.sessions_ratio
                };
                $('#calendar').fullCalendar('renderEvent', events, true);
                if(booking.is_session && !booking.user_session_confirmed)
                {
                  swal("Se ha enviado un correo al cliente para que valide la sesión agendada.");
                }
              }
              if (booking.warnings.length > 0) {
                var warnings = '';
                for (i in booking.warnings) {
                  warnings += booking.warnings[i] + '. ';
                }
                $('#bookingWarnings').append(warnings);
                warning = true;
              }
            });
            if (warning) {
              $('#bookingAlerts').show();
            };
            $('#bookingModal').modal('hide');
          });
        } else{
          $('#bookingModal').modal('hide');
        };
      });
    }
  });
}

function saveBreak (typeURL, extraURL) {
  var break_service_providers_ids = new Array();
  $(".providers_check_boxes").each(function(){
    if($(this).prop("checked"))
    {
      break_service_providers_ids.push($(this).val());
    }
  });

  var startDate = new Date(parseInt($('#provider_break_start_1i').val()), parseInt($('#provider_break_start_2i').val())-1, parseInt($('#provider_break_start_3i').val()), parseInt($('#provider_break_start_4i').val()), parseInt($('#provider_break_start_5i').val()), 0);

  var endDate = new Date(parseInt($('#provider_break_end_1i').val()), parseInt($('#provider_break_end_2i').val())-1, parseInt($('#provider_break_end_3i').val()), parseInt($('#provider_break_end_4i').val()), parseInt($('#provider_break_end_5i').val()), 0);

  if (startDate.getTime() >= endDate.getTime())
  {
    swal("La fecha de fin no puede ser anterior o igual a la de inicio.");
    return false;
  }

  var breakJSON = {
    "service_provider_id": break_service_providers_ids,
    "name": $('#provider_break_name').val(),
    "start": $('#provider_break_start_1i').val() +"-"+ $('#provider_break_start_2i').val() +"-"+ $('#provider_break_start_3i').val() +"T"+ $('#provider_break_start_4i').val() +":"+ $('#provider_break_start_5i').val() +":00Z",
    "end": $('#provider_break_end_1i').val() +"-"+ $('#provider_break_end_2i').val() +"-"+ $('#provider_break_end_3i').val() +"T"+ $('#provider_break_end_4i').val() +":"+ $('#provider_break_end_5i').val() +":00Z",
    "local": $('#locals-selector').val(),
    "repeat": $('#break_repeat').val(),
    "repeat_end": $('#provider_break_repeat_repeat_end_1i').val() +"-"+ $('#provider_break_repeat_repeat_end_2i').val() +"-"+ $('#provider_break_repeat_repeat_end_3i').val() +"T"+ $('#provider_break_repeat_repeat_end_4i').val() +":"+ $('#provider_break_repeat_repeat_end_5i').val() +":00Z",
    "times": $("#break_times").val(),
    "repeat_option": $('input[name="repeat_option"]:checked').val()
  };
  $("#break-loader").show();
  $("#new_provider_break").hide();
  $(".break-modal-footer").hide();
  $.ajax({
    type: typeURL,
    url: '/provider_breaks'+extraURL+'.json',
    data: { "provider_break": breakJSON },
    dataType: 'json',
    success: function(provider_breaks){
      switch(typeURL) {
        case 'POST':
          $('.break-button').attr("disabled", "disabled");
          $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );
          var warnings = '';

          if($("#providers-selector").val() == "0")
          {
            $.each(provider_breaks, function (key, provider_break) {
              var label = provider_break.name;
              if (label == null) {
                label = 'Hora Bloqueada';
              };
              var events = {
                id: 'b'+provider_break.id,
                title: label,
                allDay: false,
                start: provider_break.start,
                end: provider_break.end,
                resourceId: parseInt(provider_break.service_provider_id),
                textColor: textColors[7],
                borderColor: textColors[7],
                backgroundColor: backColors[7]
              };
              if (provider_break.warnings && provider_break.warnings.length > 0) {
                for (i in provider_break.warnings) {
                  warnings += provider_break.warnings[i] + '. ';
                }
              }
              $('#calendar').fullCalendar('renderEvent', events, true);

            });
          }
          else
          {
            $.each(provider_breaks, function (key, provider_break) {
              if ($("#providers-selector").val() == provider_break.service_provider_id)
              {
                var label = provider_break.name;
                if (label == null) {
                  label = 'Hora Bloqueada';
                };
                var events = {
                  id: 'b'+provider_break.id,
                  title: label,
                  allDay: false,
                  start: provider_break.start,
                  end: provider_break.end,
                  resourceId: parseInt(provider_break.service_provider_id),
                  textColor: textColors[7],
                  borderColor: textColors[7],
                  backgroundColor: backColors[7]
                };
                if (provider_break.warnings && provider_break.warnings.length > 0) {
                  for (i in provider_break.warnings) {
                    warnings += provider_break.warnings[i] + '. ';
                  }
                }
                $('#calendar').fullCalendar('renderEvent', events, true);
              }
            });
          }

          $("#break-loader").hide();
          $("#new_provider_break").show();
          $(".break-modal-footer").show();
          $('#breakModal').modal('hide');

          if (warnings.length > 0) {
            $('#bookingAlerts').hide();
            $('#bookingWarnings').empty();
            $('#bookingWarnings').append(warnings);
            $('#bookingAlerts').show();
          };
          break;
        case 'PATCH':
          var newProviderId = "0";
          $('.break-button').attr("disabled", "disabled");
          $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );
          var warnings = '';

          $.each(provider_breaks, function (key, provider_break) {
            var label = provider_break.name;
            if (label == null) {
              label = 'Hora Bloqueada';
            }
            event = $('#calendar').fullCalendar('clientEvents', 'b'+provider_break.id)[0];
            if (event) {
              event.title = label;
              event.start = provider_break.start;
              event.end = provider_break.end;
              event.resourceId = parseInt(provider_break.service_provider_id);
              newProviderId = provider_break.service_provider_id;
              $('#calendar').fullCalendar('updateEvent', event);
            } else {
              var events = {
                id: 'b'+provider_break.id,
                title: label,
                allDay: false,
                start: provider_break.start,
                end: provider_break.end,
                resourceId: parseInt(provider_break.service_provider_id),
                textColor: textColors[7],
                borderColor: textColors[7],
                backgroundColor: backColors[7]
              };
              $('#calendar').fullCalendar('renderEvent', events, true);
            };
            if (provider_break.warnings && provider_break.warnings.length > 0) {
              for (i in provider_break.warnings) {
                warnings += provider_break.warnings[i] + '. ';
              };
            }
          });

          selProviderId = parseInt($('#providers-selector').val())
          if (selProviderId == 0) {
            //loadLocationTime (resources);
          }
          else {
            $('#providers-selector option[value="'+newProviderId+'"]').attr("selected", "selected")
            loadProviderTime(newProviderId);
          }
          if (warnings.length > 0) {
            $('#bookingWarnings').empty();
            $('#bookingWarnings').append(warnings);
            $('#bookingAlerts').show();
          }
          break;
        case 'DELETE':
          $('.break-button').attr("disabled", "disabled");
          $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );

          $.each(provider_breaks, function (key, provider_break) {
            $('#calendar').fullCalendar('removeEvents','b'+provider_break.id);
          });

          break;
      }
      $("#break-loader").hide();
      $("#new_provider_break").show();
      $(".break-modal-footer").show();
      $('#breakModal').modal('hide');
    },
    error: function(xhr){
      showErrors(xhr);
      $("#break-loader").hide();
      $("#new_provider_break").show();
      $(".break-modal-footer").show();
      $('#breakModal').modal('hide');
    }
  });
}

function editRepeatBreak(breakId) {
  var break_service_providers_ids = new Array();
  $(".providers_check_boxes").each(function(){
    if($(this).prop("checked"))
    {
      break_service_providers_ids.push($(this).val());
    }
  });

  var startDate = new Date(parseInt($('#provider_break_start_1i').val()), parseInt($('#provider_break_start_2i').val())-1, parseInt($('#provider_break_start_3i').val()), parseInt($('#provider_break_start_4i').val()), parseInt($('#provider_break_start_5i').val()), 0);

  var endDate = new Date(parseInt($('#provider_break_end_1i').val()), parseInt($('#provider_break_end_2i').val())-1, parseInt($('#provider_break_end_3i').val()), parseInt($('#provider_break_end_4i').val()), parseInt($('#provider_break_end_5i').val()), 0);

  if (startDate.getTime() >= endDate.getTime())
  {
    swal("La fecha de fin no puede ser anterior o igual a la de inicio.");
    return false;
  }

  var breakJSON = {
    "service_provider_id": break_service_providers_ids,
    "name": $('#provider_break_name').val(),
    "start": $('#provider_break_start_1i').val() +"-"+ $('#provider_break_start_2i').val() +"-"+ $('#provider_break_start_3i').val() +"T"+ $('#provider_break_start_4i').val() +":"+ $('#provider_break_start_5i').val() +":00Z",
    "end": $('#provider_break_end_1i').val() +"-"+ $('#provider_break_end_2i').val() +"-"+ $('#provider_break_end_3i').val() +"T"+ $('#provider_break_end_4i').val() +":"+ $('#provider_break_end_5i').val() +":00Z",
    "local": $('#locals-selector').val(),
    "repeat_id" : $("#provider_break_repeat_id").val(),
    "id" : breakId,
    "repeat": $('#break_repeat').val(),
    "repeat_end": $('#provider_break_repeat_repeat_end_1i').val() +"-"+ $('#provider_break_repeat_repeat_end_2i').val() +"-"+ $('#provider_break_repeat_repeat_end_3i').val() +"T"+ $('#provider_break_repeat_repeat_end_4i').val() +":"+ $('#provider_break_repeat_repeat_end_5i').val() +":00Z",
    "times": $("#break_times").val(),
    "repeat_option": $('input[name="repeat_option"]:checked').val()
  };
  $("#break-loader").show();
  $("#new_provider_break").hide();
  $(".break-modal-footer").hide();
  $.ajax({
    type: "post",
    url: '/provider_breaks/update_repeat_break.json',
    data: { "provider_break": breakJSON },
    dataType: 'json',
    success: function(provider_break_json){
      var warnings = "";
      var newProviderId = "0";
      var provider_break = provider_break_json[0]
      var break_deletes = provider_break_json[1]

      $.each(break_deletes, function (key, break_delete) {
        $('#calendar').fullCalendar('removeEvents','b'+break_delete.id);
      });

      $.each(provider_break, function (key, provider_break) {
        var label = provider_break.name;
        newProviderId = provider_break.service_provider_id;
        if (label == null) {
          label = 'Hora Bloqueada';
        }
        event = $('#calendar').fullCalendar('clientEvents', 'b'+provider_break.id)[0];
        if (event) {
          event.title = label;
          event.start = provider_break.start;
          event.end = provider_break.end;
          event.resourceId = parseInt(provider_break.service_provider_id);
          $('#calendar').fullCalendar('updateEvent', event);
        } else {
          var events = {
            id: 'b'+provider_break.id,
            title: label,
            allDay: false,
            start: provider_break.start,
            end: provider_break.end,
            resourceId: parseInt(provider_break.service_provider_id),
            textColor: textColors[7],
            borderColor: textColors[7],
            backgroundColor: backColors[7]
          };
          $('#calendar').fullCalendar('renderEvent', events, true);
        };
        if (provider_break.warnings.length > 0) {
          for (i in provider_break.warnings) {
            warnings += provider_break.warnings[i] + '. ';
          };
        }

      });
      selProviderId = parseInt($('#providers-selector').val())
      if (selProviderId == 0) {
        //loadLocationTime (localId, resources);
      }
      else {
        $('#providers-selector option[value="'+newProviderId+'"]').attr("selected", "selected")
        loadProviderTime(newProviderId);
      }
      if (warnings.length > 0) {
        $('#bookingWarnings').empty();
        $('#bookingWarnings').append(warnings);
        $('#bookingAlerts').show();
      }
      $("#break-loader").hide();
      $("#new_provider_break").show();
      $(".break-modal-footer").show();
      $("#breakModal").modal('hide');
    }
  });
}

function deleteRepeatBreak(breakId) {
  var break_service_providers_ids = new Array();
  $(".providers_check_boxes").each(function(){
    if($(this).prop("checked"))
    {
      break_service_providers_ids.push($(this).val());
    }
  });
  var breakJSON = {
    "service_provider_id": break_service_providers_ids,
    "name": $('#provider_break_name').val(),
    "start": $('#provider_break_start_1i').val() +"-"+ $('#provider_break_start_2i').val() +"-"+ $('#provider_break_start_3i').val() +"T"+ $('#provider_break_start_4i').val() +":"+ $('#provider_break_start_5i').val() +":00Z",
    "end": $('#provider_break_end_1i').val() +"-"+ $('#provider_break_end_2i').val() +"-"+ $('#provider_break_end_3i').val() +"T"+ $('#provider_break_end_4i').val() +":"+ $('#provider_break_end_5i').val() +":00Z",
    "local": $('#locals-selector').val(),
    "repeat_id" : $("#provider_break_repeat_id").val(),
    "id" : breakId
  };
  $("#break-loader").show();
  $("#new_provider_break").hide();
  $(".break-modal-footer").hide();
  $.ajax({
    type: "post",
    url: '/provider_breaks/destroy_repeat_break.json',
    data: { "provider_break": breakJSON },
    dataType: 'json',
    success: function(provider_break){
      $('.break-button').attr("disabled", "disabled");
      $( '<span id="small_loader"><i class="fa fa-spinner fa-spin"></i> </span>' ).insertBefore( $( ".btn-close" ) );
      $.each(provider_break, function (key, provider_break) {
        $('#calendar').fullCalendar('removeEvents','b'+provider_break.id);
      });
      $("#break-loader").hide();
      $("#new_provider_break").show();
      $(".break-modal-footer").show();
      $("#breakModal").modal('hide');
    }
  });
}

function getAvailableProviders() {
  if (parseInt($('#locals-selector').val()) > 0) {
    if (parseInt($('#providers-selector').val()) == 0) {
      queryJSON = { "start": $('#datePicker').val() +"T"+ $('#bookingStartHour').val() +":"+ $('#bookingStartMinute').val() +":00Z","end":$('#datePicker').val() +"T"+ $('#bookingEnd').text() +":00Z", "location_id": parseInt($('#locals-selector').val()) }
      $.getJSON('/available_providers', queryJSON, function (providersArray) {
        $(function(){
          $('#booking_service_provider_id option').filter(function () {
            return $.inArray(this.value(), providersArray) == -1;
          }).remove();
        });
      });
    }
  }
}

function createBreakModal(date, providerId) {
  var providerId = providerId || 0;

  var date = date || 0;
  if (date != 0) {
    dateArray = date.toString().split(' ');
    $('#provider_break_start_3i option[value="'+parseInt(dateArray[2])+'"]').attr("selected",true);
    $('#provider_break_start_2i option[value="'+(date.getMonth()+1)+'"]').attr("selected",true);
    $('#provider_break_start_1i option[value="'+dateArray[3]+'"]').attr("selected",true);
    $('#provider_break_start_4i option[value="'+dateArray[4].split(':')[0]+'"]').attr("selected",true);
    $('#provider_break_start_5i option[value="'+dateArray[4].split(':')[1]+'"]').attr("selected",true);

    $('#provider_break_end_3i option[value="'+parseInt(dateArray[2])+'"]').attr("selected",true);
    $('#provider_break_end_2i option[value="'+(date.getMonth()+1)+'"]').attr("selected",true);
    $('#provider_break_end_1i option[value="'+dateArray[3]+'"]').attr("selected",true);
    $('#provider_break_end_4i option[value="'+dateArray[4].split(':')[0]+'"]').attr("selected",true);
    $('#provider_break_end_5i option[value="'+dateArray[4].split(':')[1]+'"]').attr("selected",true);

    $('#provider_break_repeat_repeat_end_3i option[value="'+parseInt(dateArray[2])+'"]').attr("selected",true);
    $('#provider_break_repeat_repeat_end_2i option[value="'+(date.getMonth()+1)+'"]').attr("selected",true);
    $('#provider_break_repeat_repeat_end_1i option[value="'+dateArray[3]+'"]').attr("selected",true);
    $('#provider_break_repeat_repeat_end_4i option[value="'+dateArray[4].split(':')[0]+'"]').attr("selected",true);
    $('#provider_break_repeat_repeat_end_5i option[value="'+dateArray[4].split(':')[1]+'"]').attr("selected",true);
  }
  else {
    $('#provider_break_start_5i option[value="00"]').attr("selected",true);
    $('#provider_break_end_5i option[value="00"]').attr("selected",true);
    $('#provider_break_repeat_repeat_end_5i option[value="00"]').attr("selected",true);
  }

  $('#break_repeat option[value="never"]').prop("selected", true);
  $("#break_times").val('');
  $("#repeat_option_times").prop("checked", true);
  $(".form-repeat-div").show();

  var localId = parseInt($('#locals-selector').val());
  $.ajax('/local_providers.json', {
    async: false,
    data: {
      location: localId
    },
    dataType: 'json',
    success: function (providersArray, status, jqXHR) {
      var checkboxes_selector = $("#providers_checkboxes");
      checkboxes_selector.empty();

      $.each(providersArray, function (key, provider){
        checkboxes_selector.append(
          '<div class="checkbox"><label>' +
          '<input class="check_boxes providers_check_boxes" id="provider_break_service_provider_id_' + provider.id + '" name="provider_break[service_provider_id][]" type="checkbox" value="' + provider.id + '"> ' + provider.public_name + ' ' +
          '</label></div>'
          );
      });

    }
  });

  if (parseInt($('#providers-selector').val()) > 0) {
    $("#provider_break_service_provider_id_" + parseInt($('#providers-selector').val())).prop("checked", true);

  }
  if (providerId > 0) {

    $("#provider_break_service_provider_id_" + providerId).prop("checked", true);
  }

  var end_minutes = parseInt($('#provider_break_end_5i').val()) + $('#calendar-data').data('calendar-duration');
  if (end_minutes >= 60) {
    $('#provider_break_end_4i option[value="'+(parseInt($('#provider_break_end_4i').val())+1)+'"]').attr("selected",true);
    end_minutes = end_minutes - 60;
  }
  if (end_minutes < 10) {
    $('#provider_break_end_5i option[value="0'+end_minutes+'"]').attr("selected",true);
  }
  else {
    $('#provider_break_end_5i option[value="'+end_minutes+'"]').attr("selected",true);
  }

  $('#provider_break_name').val('');
  $("#provider_break_repeat_id").val('');
  //$("#provider_break_service_provider_id").attr("disabled", false);
  //$('#provider_break_service_provider_id option[value="0"]').attr("hidden", false);
  $('.break-modal-footer').empty();
  $('.break-modal-footer').append(
    '<button type="button" class="btn btn-default btn-close break-button" data-dismiss="modal">Cerrar</button>' +
    '<button type="button" class="btn btn-green break-button" id="save_break" onClick="saveBreak(\'POST\',\'\')">Guardar</button>'
    );
  $('#breakModal').modal('show');
}

function editBreakModal(breakId) {
  $.getJSON('/provider_breaks/'+breakId, function (provider_break_json) {

    var provider_break = provider_break_json.provider_break
    var provider_break_repeat = provider_break_json.provider_break_repeat
    var break_service_providers = provider_break_json.service_providers
    var group_service_providers = provider_break_json.group_service_providers
    var start = provider_break.start || 0;
    var end = provider_break.end || 0;
    if (start != 0) {
      dateArray = start.toString().split('T');
      date = new Date(start)
      month = date.getMonth()+1;
      day = date.getDate();
      $('#provider_break_start_1i option[value="'+date.getFullYear()+'"]').attr("selected",true);
      $('#provider_break_start_2i option[value="'+month+'"]').attr("selected",true);
      $('#provider_break_start_3i option[value="'+day+'"]').attr("selected",true);
      $('#provider_break_start_4i option[value="'+dateArray[1].split(':')[0]+'"]').attr("selected",true);
      $('#provider_break_start_5i option[value="'+dateArray[1].split(':')[1]+'"]').attr("selected",true);
    }
    if (end != 0) {
      dateArray = end.toString().split('T');
      date = new Date(end)
      month = date.getMonth()+1;
      day = date.getDate();
      $('#provider_break_end_1i option[value="'+date.getFullYear()+'"]').attr("selected",true);
      $('#provider_break_end_2i option[value="'+month+'"]').attr("selected",true);
      $('#provider_break_end_3i option[value="'+day+'"]').attr("selected",true);
      $('#provider_break_end_4i option[value="'+dateArray[1].split(':')[0]+'"]').attr("selected",true);
      $('#provider_break_end_5i option[value="'+dateArray[1].split(':')[1]+'"]').attr("selected",true);
    }

    $(".form-repeat-div").hide();

    var localId = parseInt($('#locals-selector').val());
    $.ajax('/local_providers.json', {
      async: false,
      data: {
        location: localId
      },
      dataType: 'json',
      success: function (providersArray, status, jqXHR) {
        var selector = $('#provider_break_service_provider_id');
        selector.empty();

        var checkboxes_selector = $("#providers_checkboxes");
        checkboxes_selector.empty();

        $.each(providersArray, function(key, provider){

          checkboxes_selector.append(
            '<div class="checkbox"><label>' +
            '<input class="check_boxes providers_check_boxes" id="provider_break_service_provider_id_' + provider.id + '" name="provider_break[service_provider_id][]" type="checkbox" value="' + provider.id + '"> ' + provider.public_name + ' ' +
            '</label></div>'
            );

        });


        if(break_service_providers != null && break_service_providers.length > 0)
        {
          for(i = 0; i < break_service_providers.length; i++)
          {
            $("#provider_break_service_provider_id_" + parseInt(break_service_providers[i].id)).prop("checked", true);
          }
        }
        else if(group_service_providers != null && group_service_providers.length > 0)
        {
          for(i = 0; i < group_service_providers.length; i++)
          {
            $("#provider_break_service_provider_id_" + parseInt(group_service_providers[i].id)).prop("checked", true);
          }
        }
        else
        {
          $("#provider_break_service_provider_id_" + parseInt(provider_break.service_provider_id)).prop("checked", true);
        }

      }
    });

    $('#provider_break_name').val(provider_break.name);

    if(provider_break.break_repeat_id != null)
    {
      $("#provider_break_repeat_id").val(provider_break.break_repeat_id);
    }
    $('.break-modal-footer').empty();


    if(provider_break.break_repeat_id == null)
    {
      $('.break-modal-footer').append(
        '<button type="button" class="btn btn-default btn-close" data-dismiss="modal">Cerrar</button>' +
        '<button type="button" class="btn btn-danger" id="destroy_break" onClick="saveBreak(\'DELETE\',\'/'+breakId+'\')">Eliminar</button>' +
        '<button type="button" class="btn btn-green" id="edit_break" onClick="saveBreak(\'PATCH\',\'/'+breakId+'\')">Guardar</button>'
        );
    }
    else
    {
      $(".form-repeat-div").show();

      $('#break_repeat option[value="' + provider_break_repeat.repeat_type + '"]').prop("selected", true);

      $('[name="repeat_option"][value="' + provider_break_repeat.repeat_option + '"]').prop("checked", true);


      if(provider_break_repeat.repeat_option == "times")
      {
        $("#break_times").val(provider_break_repeat.times);
      }
      else
      {
        $("#break_times").val("");
      }


      repeat_dateArray = provider_break_repeat.end_date.toString().split('T');
      repeat_date = new Date(provider_break_repeat.end_date)
      repeat_month = repeat_date.getMonth()+1;
      repeat_day = repeat_date.getDate();
      $('#provider_break_repeat_repeat_end_1i option[value="'+repeat_date.getFullYear()+'"]').attr("selected",true);
      $('#provider_break_repeat_repeat_end_2i option[value="'+repeat_month+'"]').attr("selected",true);
      $('#provider_break_repeat_repeat_end_3i option[value="'+repeat_day+'"]').attr("selected",true);
      $('#provider_break_repeat_repeat_end_4i option[value="'+repeat_dateArray[1].split(':')[0]+'"]').attr("selected",true);
      $('#provider_break_repeat_repeat_end_5i option[value="'+repeat_dateArray[1].split(':')[1]+'"]').attr("selected",true);


      $('.break-modal-footer').append(
        '<div class="row"><div class="col-md-2"></div><div class="col-md-4 pull-l"><span class="custom-span-popover" style="cursor: pointer;" data-toggle="popover" data-placement="top" title="Edición" data-content="Eliminar: Sólo se eliminará este bloqueo para todos los prestadores seleccionados, quedando el resto de la serie de repetición intacta. Guardar: Sólo se editará este bloqueo para los prestadores seleccionados y será removido de la serie de repetición a la que pertencía.">¿Qué estoy editando?&nbsp;<i class="fa fa-question-circle"></i></span></div><div class="col-md-6"><span class="custom-span-popover" style="cursor: pointer;" data-toggle="popover" data-placement="top" title="Edición de serie" data-content="Eliminar: Se eliminará la serie de repetición completa para los prestadores seleccionados. Los otros prestadores mantendrán la serie de bloqueos si la tenían. Guardar: Se guardarán los cambios de la serie de repetición para los prestadores seleccionados. Si se seleccionan menos prestadores que los originales, se separará en dos series: una para los elegidos, y otra para los no elegidos. En cambio, si se agregan prestadores, se crearán bloqueos para ese prestador y serán incluidos en la serie original.">¿Qué estoy editando?&nbsp;<i class="fa fa-question-circle"></i></span></div></div>' +
        '<div class="row"><div class="col-md-2">'+
        '<button type="button" class="btn btn-default btn-close pull-left" data-dismiss="modal">Cerrar</button>' +
        '</div><div class="col-md-4">' +
        '<button title="Sólo se eliminará este bloqueo para los prestadores seleccionados, quedando el resto de la serie de repetición intacta." type="button" class="btn btn-danger" id="destroy_break" onClick="saveBreak(\'DELETE\',\'/'+breakId+'\')">Eliminar</button>' +
        '<button title="Sólo se editará este bloqueo para los prestadores seleccionados y será removido de la serie de repetición a la que pertencía." type="button" class="btn btn-green" id="edit_break" onClick="saveBreak(\'PATCH\',\'/'+breakId+'\')">Guardar</button>' +
        '</div><div class="col-md-6">' +
        '<button title="Se eliminará la serie de repetición completa para los prestadores seleccionados. Los otros prestadores mantendrán la serie de bloqueos si la tenían." type="button" class="btn btn-danger" id="destroy_repeat_break" onClick="deleteRepeatBreak(' + breakId +')">Eliminar serie</button>' +
        '<button title="Se guardarán los cambios de la serie de repetición para los prestadores seleccionados. Si se seleccionan menos prestadores que los originales, se separará en dos series: una para los elegidos, y otra para los no elegidos. En cambio, si se agregan prestadores, se crearán bloqueos para ese prestador y serán incluidos en la serie original." type="button" class="btn btn-dark-green" id="edit_repeat_break" onClick="editRepeatBreak(' + breakId +')">Guardar serie</button>' +
        '</div></div>'
      );

      $('[data-toggle="tooltip"]').tooltip({
        placement: "top"
      });

      $('.custom-span-popover').popover({
        placement: 'top',
        template: '<div class="popover custom-popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'
      });
      $(".custom-popover").css("width", "350px !important");


    }
    $('#breakModal').modal('show');
  });
}

function validEmail(email) {
  if (email != null) {
    var atpos = email.indexOf("@");
    var dotpos = email.lastIndexOf(".");
    if (atpos < 1 || dotpos < atpos+2 || dotpos+2 >= email.length) {
      return false;
    }
    return true;
  }
  else {
    return false;
  }
}

function splitFullName() {
  if ($('#full_name').val() == '') {
    $('#xButton').prop('disabled', true);
  }
  else {
    $('#xButton').prop('disabled', false);
    var nameArray = $('#full_name').val().split(' ');
    if (nameArray.length == 0) {

    }
    else if (nameArray.length == 1) {
      $('#booking_client_first_name').val(nameArray[0]);
    }
    else if (nameArray.length == 2) {
      $('#booking_client_first_name').val(nameArray[0]);
      $('#booking_client_last_name').val(nameArray[1]);
    }
    else if (nameArray.length == 3) {
      $('#booking_client_first_name').val(nameArray[0]);
      $('#booking_client_last_name').val(nameArray[1]+' '+nameArray[2]);
    }
    else {
      $('#booking_client_first_name').val(nameArray[0]+' '+nameArray[1]);
      var last_name = '';
      for (var i = 2; i < nameArray.length; i++) {
        last_name += nameArray[i]+' ';
      }
      var strLen = last_name.length;
      last_name = last_name.slice(0,strLen-1)
      $('#booking_client_last_name').val(last_name);
    }
  }
}

function modalChange() {
  if ($("#booking_service_id").val() != '') {
    var price = 0;
    for (i in servicesJSON) {
      if ($("#booking_service_id").val() == servicesJSON[i].id) {
        price = servicesJSON[i].price;
      }
    }
    $('#booking_price').val(price);
  }
  if ($("#bookingStartHour").val() != '' && $("#bookingStartMinute").val() != '' && $("#booking_service_id").val() != '') {
    var duration = 0;
    for (i in servicesJSON) {
      if ($("#booking_service_id").val() == servicesJSON[i].id) {
        duration = servicesJSON[i].duration;
      }
    }
    var extraCharH = '';
    var extraCharM = '';
    var hours = parseInt($("#bookingStartHour").val());
    var minutes = parseInt($("#bookingStartMinute").val()) + duration;
    if (minutes >= 60) {
      hours += Math.floor(minutes/60);
      minutes = minutes%60;
    }
    if (hours < 10) {
      extraCharH = '0';
    }
    if (minutes < 10) {
      extraCharM = '0';
    }
    $('#bookingEndHour option[value="'+extraCharH+hours+'"]').attr("selected",true);
    $('#bookingEndMinute option[value="'+extraCharM+minutes+'"]').attr("selected",true);
  }
  else {
    $('#bookingEndHour option[value="'+$("#bookingStartHour").val()+'"]').attr("selected",true);
    $('#bookingEndMinute option[value="'+$("#bookingStartMinute").val()+'"]').attr("selected",true);
  }
}

function setAge() {

  if ($('#booking_client_birth_day').val() != '' && $('#booking_client_birth_month').val() != '' && $('#booking_client_birth_year').val() != '')
  {
    var day = $('#booking_client_birth_day').val();
    var month = $('#booking_client_birth_month').val() - 1;
    var year = $('#booking_client_birth_year').val();

    var date1 = new Date(year,month,day);
    //hoy
    var date2 = new Date();

    var milli = date2 - date1;
    var milliPerYear = 1000 * 60 * 60 * 24 * 365.26;

    var yearsApart = milli/milliPerYear;
    $('#booking_client_age').val(yearsApart | 0);

  }
  return false;
}

function checkClientSessions(service_change) {

  modalChange();
  if($("#is_edit_modal").val() == "0")
  {

    $("#sessions-info").empty();
    $("#sessions-row").hide();
    $("#add-service-btn").show();
    $("#has_sessions").val("0");

    if (parseInt($('#booking_client_id').val()) > 0)
    {
      if(parseInt($("#booking_service_id").val()) > 0)
      {
        $.ajax({
          type: "get",
          url: "/clients_check_sessions?id=" + $('#booking_client_id').val() + "&service_id=" + $("#booking_service_id").val(),
          success: function(response)
          {
            var service = response[0]
            var sessions_bookings = response[1]

            if (service.has_sessions)
            {
              if (sessions_bookings.length > 0)
              {
                $("#sessions-info").append('<div session_booking_id="0"><input type="radio" name="sessions-choice" value="0" />&nbsp;Generar una nueva reserva y agendar la primera sesión.');
              }
              else
              {
                $("#sessions-info").append('<div session_booking_id="0"><input type="radio" name="sessions-choice" value="0" checked>&nbsp;Generar una nueva reserva y agendar la primera sesión.');
              }
              $("#sessions-row").show();
              $("#add-service-btn").hide();
              $("#has_sessions").val("1");
              if(sessions_bookings.length > 0)
              {
                var index = 0;
                $.each(sessions_bookings, function (key, session_booking) {
                  var nextSession = session_booking.sessions_taken + 1;
                  if(index == 0)
                  {
                    $("#sessions-info").append('<div session_booking_id="' + session_booking.id + '"><input type="radio" name="sessions-choice" value="' + session_booking.id + '" checked />&nbsp;El cliente ha agendado ' + session_booking.sessions_taken + ' de un total de ' + session_booking.sessions_total +'. Agendar la sesión ' + nextSession + '.');
                  }
                  else
                  {
                    $("#sessions-info").append('<div session_booking_id="' + session_booking.id + '"><input type="radio" name="sessions-choice" value="' + session_booking.id + '">&nbsp;El cliente ha agendado ' + session_booking.sessions_taken + ' de un total de ' + session_booking.sessions_total +'. Agendar la sesión ' + nextSession + '.');
                  }
                  index = index + 1;
                });
              }
              session_price = service.price/service.sessions_amount;
              $("#booking_price").val(session_price);
              $("#treatment_price_div").show();
              $("#treatment_price").text("$ " + service.price);
            }
            else
            {
              $("#treatment_price_div").hide();
              $("#treatment_price").text("");
              $("#has_sessions").val("0");
            }
          }
        });
      }
    }
    else
    {
      if(parseInt($("#booking_service_id").val()) > 0)
      {

        $.ajax({
          type: "get",
          url: "services/" + $("#booking_service_id").val() + ".json",
          success: function(service)
          {
            if(service.has_sessions)
            {
              $("#sessions-info").append('<div session_booking_id="0"><input type="radio" name="sessions-choice" value="0" checked>&nbsp;Este servicio es por sesiones. Generar una nueva reserva y agendar la primera sesión.');
              $("#sessions-row").show();
              $("#add-service-btn").hide();
              $("#has_sessions").val("1");
              session_price = service.price/service.sessions_amount;
              $("#booking_price").val(session_price);
              $("#treatment_price_div").show();
              $("#treatment_price").text("$ " + service.price);
            }
            else
            {
              $("#has_sessions").val("0");
              $("#treatment_price_div").hide();
              $("#treatment_price").text("");
            }
          }
        });
      }
    }
  }
  else
  {
    /*if(parseInt($("#booking_service_id").val()) > 0)
    {
      $.ajax({
        type: "get",
        url: "services/" + $("#booking_service_id").val() + ".json",
        success: function(service)
        {
          if(service.has_sessions)
          {
            $("#sessions-info").empty();
            $("#sessions-info").append("Esta reserva corresponde a una sesión de un servicio.");
            $("#sessions-row").show();
          }
          else
          {
            $("#sessions-info").empty();
            $("#sessions-row").hide();
          }
        }
      });
    }*/
    if(service_change)
    {
      $("#sessions-info").empty();
      $("#sessions-row").hide();
      $("#add-service-btn").show();
      $("#has_sessions").val("0");

      if (parseInt($('#booking_client_id').val()) > 0)
      {
        if(parseInt($("#booking_service_id").val()) > 0)
        {
          $.ajax({
            type: "get",
            url: "/clients_check_sessions?id=" + $('#booking_client_id').val() + "&service_id=" + $("#booking_service_id").val(),
            success: function(response)
            {
              var service = response[0]
              var sessions_bookings = response[1]

              if (service.has_sessions)
              {
                if (sessions_bookings.length > 0)
                {
                  $("#sessions-info").append('<div session_booking_id="0"><input type="radio" name="sessions-choice" value="0" />&nbsp;Generar una nueva reserva y agendar la primera sesión.');
                }
                else
                {
                  $("#sessions-info").append('<div session_booking_id="0"><input type="radio" name="sessions-choice" value="0" checked>&nbsp;Generar una nueva reserva y agendar la primera sesión.');
                }
                $("#sessions-row").show();
                $("#add-service-btn").hide();
                $("#has_sessions").val("1");
                if(sessions_bookings.length > 0)
                {
                  var index = 0;
                  $.each(sessions_bookings, function (key, session_booking) {
                    var nextSession = session_booking.sessions_taken + 1;
                    if(index == 0)
                    {
                      $("#sessions-info").append('<div session_booking_id="' + session_booking.id + '"><input type="radio" name="sessions-choice" value="' + session_booking.id + '" checked />&nbsp;El cliente ha agendado ' + session_booking.sessions_taken + ' de un total de ' + session_booking.sessions_total +'. Agendar la sesión ' + nextSession + '.');
                    }
                    else
                    {
                      $("#sessions-info").append('<div session_booking_id="' + session_booking.id + '"><input type="radio" name="sessions-choice" value="' + session_booking.id + '">&nbsp;El cliente ha agendado ' + session_booking.sessions_taken + ' de un total de ' + session_booking.sessions_total +'. Agendar la sesión ' + nextSession + '.');
                    }
                    index = index + 1;
                  });
                }
                $("#treatment_price_div").show();
                $("#treatment_price").text("$ " + service.price);
              }
              else
              {
                $("#has_sessions").val("0");
                $("#treatment_price_div").hide();
                $("#treatment_price").text("");
              }
            }
          });
        }
      }
      else
      {
        if(parseInt($("#booking_service_id").val()) > 0)
        {
          $.ajax({
            type: "get",
            url: "services/" + $("#booking_service_id").val() + ".json",
            success: function(service)
            {
              if(service.has_sessions)
              {
                $("#sessions-info").append('<div session_booking_id="0"><input type="radio" name="sessions-choice" value="0" checked>&nbsp;Este servicio es por sesiones. Generar una nueva reserva y agendar la primera sesión.');
                $("#sessions-row").show();
                $("#add-service-btn").hide();
                $("#has_sessions").val("1");
                $("#treatment_price_div").show();
                $("#treatment_price").text("$ " + service.price);
              }
              else
              {
                $("#has_sessions").val("0");
                $("#treatment_price_div").hide();
                $("#treatment_price").text("");
              }
            }
          });
        }
      }
    }
  }
}

function loadClientHistory(booking_id) {
  if (parseInt($('#booking_client_id').val()) > 0) {
    $('#client-history-tbody').empty();
    $.getJSON('/clients_bookings_history', {id: parseInt($('#booking_client_id').val())}, function (bookings_history) {
      if (bookings_history.length > 0) {
        $.each(bookings_history, function (key, booking_history) {
          var date = new Date(booking_history.start);
          $('#client-history-tbody').append('<tr><td>'+dateToLocal(date)+'</td><td>'+booking_history.service+'</td><td>'+booking_history.provider+'</td><td>'+booking_history.status+'</td><td>'+booking_history.notes+'</td><td>'+booking_history.comment+'</td></tr>');
        });
      }
      else {
        $('#client-history-tbody').append('<tr><td colspan="6">El cliente no tiene reservas anteriores...</td></tr>');
      }
    });
  }
  if (parseInt(booking_id) > 0) {
    $('#booking-history-tbody').empty();
    $.getJSON('/booking_history', {booking_id: parseInt(booking_id)}, function (bookings_history) {
      if (bookings_history.length > 0) {
        $.each(bookings_history, function (key, booking_history) {
          var staffCode = '';
          if ($('#calendar-data').data('staff-code')) {
            staffCode = '<td>'+booking_history.staff_code+'</td>';
          }
          var created = new Date(booking_history.created);
          created.setHours(created.getHours() - <%= ENV["TIME_ZONE_OFFSET"].split('.')[0] %>);
          var date = new Date(booking_history.start);
          $('#booking-history-tbody').append('<tr><td>'+booking_history.action+'</td><td>'+dateToLocal(created)+'</td><td>'+dateToLocal(date)+'</td><td>'+booking_history.service+'</td><td>'+booking_history.provider+'</td><td>'+booking_history.status+'</td><td>'+booking_history.notes+'</td><td>'+booking_history.company_comment+'</td><td>'+booking_history.user+'</td>'+staffCode+'</tr>');
        });
      }
      else {
        $('#booking-history-tbody').append('<tr><td colspan="8">No hay modificaciones para esta reserva...</td></tr>');
      }
    });
  }
  return false;
}

function checkTreatmentPrice(service_id, session_booking_id) {
  $.ajax({
    url: '/get_treatment_price',
    method: 'get',
    data: {service_id: service_id, session_booking_id: session_booking_id},
    dataType: 'json',
    error: function(response){

    },
    success: function(response){
      if(response[0] == "ok")
      {
        $("#treatment_price_div").show();
        $("#treatment_price").text("$ " + response[1]);
      }
      else
      {
        swal(response[1]);
      }
    }
  });
}

var meses = new Array ("Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre");
var diasSemana = new Array("Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado");
function dateToLocal(date) {
  var hours = date.getUTCHours() < 10 ? '0'+date.getUTCHours() : date.getUTCHours();
  var minutes =  date.getUTCMinutes() < 10 ? '0'+date.getUTCMinutes() : date.getUTCMinutes();
  return date.getUTCDate() + "/" + (date.getUTCMonth()+1) + "/" + date.getUTCFullYear() + ' - ' + hours + ':' + minutes;
}

function dateFullToLocal(date) {
  var hours = date.getUTCHours() < 10 ? '0'+date.getUTCHours() : date.getUTCHours();
  var minutes =  date.getUTCMinutes() < 10 ? '0'+date.getUTCMinutes() : date.getUTCMinutes();
  return diasSemana[date.getUTCDay()] + ", " + date.getUTCDate() + " de " + meses[date.getUTCMonth()] + " de " + date.getUTCFullYear() + ' - ' + hours + ':' + minutes;
}

$(function() {
  clearTimeout(alertDismiss);

  $('form input, form select').bind('keypress keydown keyup', function(e){
    if(e.keyCode == 13) {
      e.preventDefault();
    }
  });

  $('#createBooking').click(function() {
    createBookingModal();
    return false;
  });
  $('#createBreak').click(function() {
    createBreakModal();
    return false;
  });
  if (parseInt($('#locals-selector').val()) > 0) {
    loadProviders();
  }
  $('#locals-selector').change(function() {
    if (parseInt($('#locals-selector').val()) > 0) {
      loadProviders();
    }
  });
  $('#datePicker').datepicker({
    dateFormat: 'dd-mm-yy',
    autoSize: true,
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
    prevText: 'Atrás',
    nextText: 'Adelante',
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    dayNamesMin: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    today: 'Hoy',
    clear: '',
  });
  $("#bookingStartHour").on("change", function() {
    modalChange();
  });
  $("#bookingStartMinute").on("change", function() {
    modalChange();
  });
  $("#booking_service_id").on("change", function() {
    modalChange();
    checkClientSessions(true);
  });

  $("#dp").datepicker({
    dateFormat: 'dd-mm-yy',
    autoSize: true,
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
    prevText: 'Atrás',
    nextText: 'Adelante',
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    dayNamesMin: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    today: 'Hoy',
    clear: '',
    onSelect: function(dateText, inst) {
      var d = new Date(parseInt(dateText.split('-')[2]), parseInt(dateText.split('-')[1]) - 1, parseInt(dateText.split('-')[0]));
      $('#calendar').fullCalendar('gotoDate', d);
      var providerId = parseInt($('#providers-selector').val());
      loadProviderEvents(providerId);
    }
  });

  $("#set-date").datepicker({
    dateFormat: 'dd-mm-yy',
    autoSize: true,
    firstDay: 1,
    changeMonth: true,
    changeYear: true,
    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
    prevText: 'Atrás',
    nextText: 'Adelante',
    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    dayNamesMin: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
    today: 'Hoy',
    clear: '',
    onSelect: function(dateText, inst) {
      var d = new Date(parseInt(dateText.split('-')[2]), parseInt(dateText.split('-')[1]) - 1, parseInt(dateText.split('-')[0]));
      $('#calendar').fullCalendar('gotoDate', d);
      var providerId = parseInt($('#providers-selector').val());
      loadProviderEvents(providerId);
    }
  });

  $('#set-date-button').click(function(){
    if ($('#ui-datepicker-div').css('display') == 'none') {
      $('#set-date').datepicker('show');
    }
    else {
      $('#set-date').datepicker('hide');
    }
  });

  $(".ui-datepicker-trigger").addClass("btn");

  $("#full_name").on('input',function(e){
    splitFullName();
  });

    $("#full_name").autocomplete({
      source: '/clients_name_suggestion',
      appendTo: '#full_name_suggestions',
      autoFocus: false,
      minLength: 3,
      select: function( event, ui ) {
        event.preventDefault();
        var client = eval("(" + ui.item.value + ")");
        $('#booking_client_first_name').val(client.first_name);
        $('#booking_client_last_name').val(client.last_name);
        $('#booking_client_phone').val(client.phone);
        $('#booking_client_email').val(client.email);
        $('#booking_client_id').val(client.id);
        $('#booking_client_identification_number').val(client.identification_number);
        $('#booking_client_address').val(client.address);
        $('#booking_client_district').val(client.district);
        $('#booking_client_city').val(client.city);
        $('#booking_client_birth_day option[value="'+client.birth_day+'"]').prop('selected', true);
        $('#booking_client_birth_month option[value="'+client.birth_month+'"]').prop('selected', true);
        $('#booking_client_birth_year option[value="'+client.birth_year+'"]').prop('selected', true);
        $('#booking_client_age').val(client.age);
        $('#booking_client_second_phone').val(client.second_phone);
        $('#booking_client_record').val(client.record);
        $('.client_link').attr('href','/clients/' + client.id + '/edit');
        $('.client_link').html('Ir a la ficha del cliente...');
        $('#booking_client_gender option[value="'+client.gender+'"]').attr("selected",true);
        $("#full_name").val(client.first_name+' '+client.last_name);
        if (validEmail($("#booking_client_email").val())) {
          $('#booking_send_mail').prop('disabled', false);
          $('#booking_send_mail').val(1);
          $('#booking_send_mail').prop('checked', true);
          $('label[for=booking_send_mail]').removeClass('disabled');
        }
        else {
          $('#booking_send_mail').val(0);
          $('#booking_send_mail').prop('checked', false);
          $('#booking_send_mail').prop('disabled', true);
          $('label[for=booking_send_mail]').addClass('disabled');
        }
        $('#xButton').prop('disabled', false);
        $("#full_name").prop('disabled', true);
        loadClientHistory(0);
        checkClientSessions(false);
      },
      focus: function (event, ui) {
        event.preventDefault();
        $("#full_name").val(ui.item.label);
      }
    }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
      return $( '<li>' ).append( '<a>' + item.label + '<br><span class="auto-desc">' + item.desc + '</span></a>' ).appendTo( ul );
    };

    $("#booking_client_email").autocomplete({
      source: '/clients_suggestion',
      appendTo: '#email_suggestions',
      autoFocus: false,
      minLength: 3,
      select: function( event, ui ) {
        event.preventDefault();
        var client = eval("(" + ui.item.value + ")");
        $('#booking_client_first_name').val(client.first_name);
        $('#booking_client_last_name').val(client.last_name);
        $('#booking_client_phone').val(client.phone);
        $('#booking_client_email').val(client.email);
        $('#booking_client_id').val(client.id);
        $('#booking_client_identification_number').val(client.identification_number);
        $('#booking_client_address').val(client.address);
        $('#booking_client_district').val(client.district);
        $('#booking_client_city').val(client.city);
        $('#booking_client_birth_day option[value="'+client.birth_day+'"]').prop('selected', true);
        $('#booking_client_birth_month option[value="'+client.birth_month+'"]').prop('selected', true);
        $('#booking_client_birth_year option[value="'+client.birth_year+'"]').prop('selected', true);
        $('#booking_client_age').val(client.age);
        $('#booking_client_second_phone').val(client.second_phone);
        $('#booking_client_record').val(client.record);
        $('.client_link').attr('href','/clients/' + client.id + '/edit');
        $('.client_link').html('Ir a la ficha del cliente...');
        $('#booking_client_gender option[value="'+client.gender+'"]').attr("selected",true);
        $("#full_name").val(client.first_name+' '+client.last_name);
        if (validEmail($("#booking_client_email").val())) {
          $('#booking_send_mail').prop('disabled', false);
          $('#booking_send_mail').val(1);
          $('#booking_send_mail').prop('checked', true);
          $('label[for=booking_send_mail]').removeClass('disabled');
        }
        else {
          $('#booking_send_mail').val(0);
          $('#booking_send_mail').prop('checked', false);
          $('#booking_send_mail').prop('disabled', true);
          $('label[for=booking_send_mail]').addClass('disabled');
        }
        $('#xButton').prop('disabled', false);
        $("#full_name").prop('disabled', true);
        loadClientHistory(0);
        checkClientSessions(false);
      },
      focus: function (event, ui) {
        event.preventDefault();
        var client = eval("(" + ui.item.value + ")");
        $("#booking_client_email").val(client.email);
      }
    }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
      return $( '<li>' ).append( '<a>' + item.label + '<br><span class="auto-desc">' + item.desc + '</span></a>' ).appendTo( ul );
    };

    $("#booking_client_identification_number").autocomplete({
      source: '/clients_rut_suggestion',
      appendTo: '#rut_suggestions',
      autoFocus: false,
      minLength: 3,
      select: function( event, ui ) {
        event.preventDefault();
        var client = eval("(" + ui.item.value + ")");
        $('#booking_client_first_name').val(client.first_name);
        $('#booking_client_last_name').val(client.last_name);
        $('#booking_client_phone').val(client.phone);
        $('#booking_client_email').val(client.email);
        $('#booking_client_id').val(client.id);
        $('#booking_client_identification_number').val(client.identification_number);
        $('#booking_client_address').val(client.address);
        $('#booking_client_district').val(client.district);
        $('#booking_client_city').val(client.city);
        $('#booking_client_birth_day option[value="'+client.birth_day+'"]').prop('selected', true);
        $('#booking_client_birth_month option[value="'+client.birth_month+'"]').prop('selected', true);
        $('#booking_client_birth_year option[value="'+client.birth_year+'"]').prop('selected', true);
        $('#booking_client_age').val(client.age);
        $('#booking_client_second_phone').val(client.second_phone);
        $('#booking_client_record').val(client.record);
        $('.client_link').attr('href','/clients/' + client.id + '/edit');
        $('.client_link').html('Ir a la ficha del cliente...');
        $('#booking_client_gender option[value="'+client.gender+'"]').attr("selected",true);
        if (validEmail($("#booking_client_email").val())) {
          $('#booking_send_mail').prop('disabled', false);
          $('#booking_send_mail').val(1);
          $('#booking_send_mail').prop('checked', true);
          $('label[for=booking_send_mail]').removeClass('disabled');
        }
        else {
          $('#booking_send_mail').val(0);
          $('#booking_send_mail').prop('checked', false);
          $('#booking_send_mail').prop('disabled', true);
          $('label[for=booking_send_mail]').addClass('disabled');
        }
        $('#xButton').prop('disabled', false);
        $('#full_name').prop('disabled', true);
        $('#full_name').val(client.first_name+' '+client.last_name);
        loadClientHistory(0);
        checkClientSessions(false);
      },
      focus: function (event, ui) {
        event.preventDefault();
        var client = eval("(" + ui.item.value + ")");
        $("#booking_client_email").val(client.email);
      }
    }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
      return $( '<li>' ).append( '<a>' + item.label + '<br><span class="auto-desc">' + item.desc + '</span></a>' ).appendTo( ul );
    };

    $("#booking_client_email").on('input',function(e){
      if (validEmail($("#booking_client_email").val())) {
        $('#booking_send_mail').attr('disabled', false);
        $('#booking_send_mail').val(1);
        $('#booking_send_mail').attr('checked', true);
        $('label[for=booking_send_mail]').removeClass('disabled');
      }
      else {
        $('#booking_send_mail').val(0);
        $('#booking_send_mail').attr('checked', false);
        $('#booking_send_mail').attr('disabled', true);
        $('label[for=booking_send_mail]').addClass('disabled');
      }
    });

    $('#booking_service_provider_id').change(function (event) {
      var selectedService =  $('#booking_service_id').val();
      $.getJSON('/provider_services', {id: event.target.value}, function (services) {
        $('#booking_service_id').empty();
        $.each(services, function (key, service) {
          $('#booking_service_id').append(
            '<option value="' + service.id + '">' + service.name + '</option>'
            );
        });
        $('#booking_service_id').removeAttr('disabled');
        $('#booking_service_id option[value="' + selectedService + '"]').prop('selected', true);
        modalChange();
        checkClientSessions(true);
      });
      if ($('#booking_provider_lock').prop('checked')) {
        $('#booking_service_provider_id').prop('disabled', true);
      }
      else {
        $('#booking_service_provider_id').prop('disabled', false);
      }
    });

    $('#bookingModal').on('hidden.bs.modal', function (e) {
      $('#booking_service_id').attr('disabled', true);
      $('#booking_status_id').parent().parent().next().remove();
      bookingModalOpen = false;
      validator.resetForm();
      $('.has-success').removeClass('has-success');
      $('.fa.fa-check').removeClass('fa fa-check');
      $('.has-error').removeClass('has-error');
      $('#bookingModal').find('.fa.fa-times').removeClass('fa fa-times');
    });

    $('#breakModal').on('hidden.bs.modal', function (e) {
      $('#booking_service_id').attr('disabled', true);
      bookingModalOpen = false;
    });

    $('#xButton').click(function() {
      $('#booking_client_first_name').val('');
      $('#booking_client_last_name').val('');
      $('#booking_client_phone').val('');
      $('#booking_client_email').val('');
      $('#booking_client_id').val('');
      $('#booking_client_identification_number').val('');
      $('#booking_client_address').val('');
      $('#booking_client_district').val('');
      $('#booking_client_city').val('');
      $('#booking_client_birth_day option[value=""]').prop('selected', true);
      $('#booking_client_birth_month option[value=""]').prop('selected', true);
      $('#booking_client_birth_year option[value=""]').prop('selected', true);
      $('#booking_client_age').val('');
      $('#booking_client_second_phone').val('');
      $('#booking_client_record').val('');
      $('.client_link').attr('href','/clients');
      $('.client_link').html('Ir a fichas de clientes...');
      $('#booking_client_gender option[value="0"]').prop('selected', true);
      $("#full_name").val('');
      $("#full_name").prop('disabled', false);
      $('#booking_send_mail').val(0);
      $('#booking_send_mail').prop('checked', false);
      $('#booking_send_mail').prop('disabled', true);
      $('label[for=booking_send_mail]').addClass('disabled');
      $('#client-history-tbody').empty();
      $('#client-history-tbody').append('<tr><td colspan="6">No hay un cliente seleccionado...</td></tr>');
      checkClientSessions(false);
      $('#xButton').prop('disabled', true);
    });

    $('#booking_provider_lock').change(function() {
      if ($('#booking_provider_lock').prop('checked')) {
        if ($('#booking_service_provider_id').val() == null) {
          $('#booking_service_provider_id').prop('disabled', false);
        }
        else {
          $('#booking_service_provider_id').prop('disabled', true);
        }
      }
      else {
        $('#booking_service_provider_id').prop('disabled', false);
      }
    });
    $('#booking_client_birth_day').change(function() {
      setAge();
    });
    $('#booking_client_birth_month').change(function() {
      setAge();
    });
    $('#booking_client_birth_year').change(function() {
      setAge();
    });

    $('#bookingAlertsClose').click(function() {
      $('#bookingAlerts').hide();
    });

    $('#provider_break_service_provider_id').append(
      '<option value="0">Todos</option>'
      );

    $(".nav-tabs > li > a[data-toggle=tab]").on("click", function(e) {
      if ($(this).hasClass("disabled")) {
        e.preventDefault();
        return false;
      }
    });

    $('.modal.in a').on("click", function(e){
      setTimeout( function () {
        $('.modal.in').modal('handleUpdate');
      } , 100 );
    });

    $('body').on('change', '[name="sessions-choice"]', function(){

      var service_id = $("#booking_service_id").val();
      var session_booking_id = $('[name="sessions-choice"]:checked').val();

      checkTreatmentPrice(service_id, session_booking_id);

    });


});
