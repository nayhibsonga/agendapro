$.validator.addMethod('mp_check', function(value, element, params) {
	
	var is_selected = $("input:radio[name='mp']").is(":checked");


	if(is_selected)
	{
		$('#payment_title').closest('.form-group').addClass('has-success');
		$('#payment_title').closest('.form-group').removeClass('has-error');
		$("#payment_title").closest('.form-group').children('.form-control-feedback').removeClass('fa fa-times').addClass('fa fa-check');
		$("#payment_title").closest('.form-group').children('.help-block').empty();
	}
	else
	{
		$('#payment_title').closest('.form-group').removeClass('has-success');
		$('#payment_title').closest('.form-group').addClass('has-error');
		$("#payment_title").closest('.form-group').children('.form-control-feedback').removeClass('fa fa-check').addClass('fa fa-times');
		$("#payment_title").closest('.form-group').children('.help-block').append("Debes elegir un medio de pago.");
	}

	return is_selected;

}, 'Debes elegir un medio de pago.');


$(function() {
	$('#bookingForm').validate({
		errorPlacement: function(error, element) {
			error.appendTo(element.next());
		},
		rules: {
			'user[full_name]': {
				required: true
			},
			phone: {
				rangelength: [8, 15]
			},
			email: {
				required: true,
				email: true
			},
			'mp': {
				mp_check: true
			},
			identification_number: {
				required: true,
				rut:true,
				minlength: 2
			},
			deal_code: {
				required: $('#dealCode').data('deal-required'),
				rut: $('#dealCode').data('deal-identification-number')
			},
			address: {
				minlength: 3
			}
		},
		highlight: function(element) {
			$(element).closest('.form-group').removeClass('has-success').addClass('has-error');
			$(element).parent().children('.form-control-feedback').removeClass('fa fa-check').addClass('fa fa-times');
		},
		success: function(element) {
			$(element).closest('.form-group').removeClass('has-error').addClass('has-success');
			$(element).parent().parent().children('.form-control-feedback').removeClass('fa fa-times').addClass('fa fa-check');
			$(element).parent().empty()
		},
		submitHandler: function(form) {
			window.console.log("entro incial");
			$('#submitBtn').attr("disabled", "disabled");
			$('#submitBtn').html('Cargando...');
			if($("#payment").val()=="1")
			{
				$('#select-medio').attr("disabled", "disabled");
				$('#select-medio').html('Cargando...');
				var is_selected = false;
				$('.mp_radio').each(function(){
				if($(this).prop('checked'))
					{
						is_selected = true;
						console.log(is_selected);
					}
				});
				if(is_selected)
				{
					$('.modal-pay').attr("disabled", "disabled");
					$('.submitBtn').attr("disabled", "disabled");
					$('.payBtn').attr("disabled", "disabled");
					form.submit();
				}
				else
				{
					$("#medio-de-pago").modal('show');
					$('#select-medio').attr("disabled", false);
					$('#select-medio').html('Pagar');
					$('#submitBtn').attr("disabled", false);
					$('#submitBtn').html('Reservar');
				}
		  	}
		  	else
		  	{	
		  		$('.modal-pay').attr("disabled", "disabled");
				$('.submitBtn').attr("disabled", "disabled");
				$('.payBtn').attr("disabled", "disabled");
		  		form.submit();
		  	}
		}
	});
	$('#identification_number').change(function() {
		var rut_string = $('#identification_number').val()
		if (rut_string != '') {	
			$('#identification_number').val(rut_format(rut_string));
			$.getJSON('/client_loader', {term: $('#identification_number').val(), company_id: $('#selectedLocal').data('local').company_id}, function (client) {
				if (client != null){	
					$('#full_name').val(client.first_name+' '+client.last_name);
					$('#firstName').val(client.first_name);
					$('#lastName').val(client.last_name);
				}
				else {
					$('#full_name').val('');
					$('#firstName').val('');
					$('#lastName').val('');
				}
			});
		}
		else {
			$('#full_name').val('');
			$('#firstName').val('');
			$('#lastName').val('');
		}
	});
});