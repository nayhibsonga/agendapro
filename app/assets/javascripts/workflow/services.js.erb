//====== Load Steps ======//

function loadStep1 () {
	stepClick(1);
	if ($('[name="localRadio"]').is(':checked')) {
		$('#services-description').empty();
		$('#services-selector').html('<%= image_tag "ajax-loader.gif", :alt => "Loader" %>');
		var localId = $('input[name=localRadio]:checked').val();
		$.getJSON('/local_services', {location: localId}, function (servicesArray) {
			var categories = new Array();	//Todos los servicios ordenados por categoria
			var services = new Array();		//Los servicios de una categoria especifica
			var category = 0;				//La categoria actual

			//====== Separacion de servicios por categoria
			$.each(servicesArray, function (key, service) {
				if (service.service_category_id != category) {
					if (category != 0) {
						categories.push(services);
					}
					services = new Array();
					category = service.service_category_id;
				}
				services.push(service);
			});
			categories.push(services);

			$('#services-selector').empty();
			
			//====== Escribiendo los servicios
			$.each(categories, function (key, service_category) {
				var category_id = service_category[key].id
				//====== Insertando acordeon
				$('#services-selector').append(
					'<div class="panel panel-default">' +
						'<div class="panel-heading">' +
							'<h4 class="panel-title">' +
								'<a data-toggle="collapse" data-parent="#services-selector" href="#collapse' + category_id + '" id="title' + category_id + '">Categoria</a>' +
							'</h4>' +
						'</div>' +
						'<div id="collapse' + category_id + '" class="panel-collapse collapse in">' +
							'<div class="panel-body">' +
								'<div id="services-selector' + category_id + '" class="radio">' +
									'<%= image_tag "ajax-loader.gif", :alt => "Loader" %>' +
								'</div>' +
							'</div>' +
						'</div>' +
					'</div>'
				);

				//====== Insertando nombre de la categoria
				$.getJSON('/category_name', {id: category_id}, function (category_name) {
					$('#title' + category_id).text(category_name.name);
				});

				//====== Insertando radiobuttons de servicios
				$.each(service_category, function (key, service) {
					if (key == 0) {
						$('#services-selector' + category_id).empty();
					}
					$('#services-selector' + category_id).append('<label>' +
							'<input type="radio" name="serviceRadio" value="' + service.id + '">' +
							'<p>' + service.name + '</p>' +
						'</label>'
					);
				});
			});

			$('[name="serviceRadio"]').on('click', function(event) {
				var serviceId = event.target.getAttribute('value');
				loadDescription(serviceId);
			});
		});
		return true;
	}
	return false;
}

function loadStep2 () {
	if($('[name="serviceRadio"]').is(':checked')){
		$('#staff-selector').html('<%= image_tag "ajax-loader.gif", :alt => "Loader" %>');
		// $('#calendar').fullCalendar('removeEvents');
		// $('#calendar').empty();
		// $('#calendar').html('Seleccione un staff para ver el horario');
		var serviceId = $('input[name=serviceRadio]:checked').val();
		// var minHour = 23;
		// var minMinuts = 59;
		// var maxHour = 00;
		// var maxMinuts = 00;
		$.getJSON('/providers_services', {id: serviceId}, function (providers) {
			$('#staff-selector').empty();
			$.each(providers, function (key, provider) {
				$('#staff-selector').append('<label>' +
						'<input type="radio" name="staffRadio" value="' + provider.id + '">' +
						'<p>' + provider.public_name + '</p>' +
					'</label>'
				);
			});
			$('[name="staffRadio"]').on('click', function(event) {
				$('#message').hide();
				$('.horario').show();
				// var providerId = event.target.getAttribute('value');
				var data = {
					provider: event.target.getAttribute('value'),
					local: $('input[name=localRadio]:checked').val(),
					service: $('input[name="serviceRadio"]:checked').val()
				}
				var calendar = new Calendar('/locations/get_available_time.json', data);
				// loadProviderTime(providerId);
			});
		});
		return true;
	}
	myAlert.showAlert(
      '<h3>Seleccione un Servicio</h3>' +
      '<p>Debe elegir un servicio antes de poder continuar.</p>'
    );
	return false;
}

function loadStep3 () {
	if ($('[name="staffRadio"]').is(':checked')){
		// var booking = $('#calendar').fullCalendar('clientEvents', 'newBooking');
		// if (booking.length) {
		// 	$('#start').val(booking[0].start);
		// 	$('#end').val(booking[0].end);
		// 	$('#provider').val($('input[name=staffRadio]:checked').val());
		// 	$('#service').val($('input[name=serviceRadio]:checked').val());
		// 	$('#location').val($('input[name=localRadio]:checked').val());
		// 	return true;
		// }
		myAlert.showAlert(
	      '<h3>Seleccione un Horario</h3>' +
	      '<p>Debe elegir un horario antes de poder continuar.</p>'
	    );
		return false;
	}
	myAlert.showAlert(
      '<h3>Seleccione un Staff</h3>' +
      '<p>Debe elegir un staff para poder agendar un horario.</p>'
    );
	return false;
}

function finalize () {
	$('#submitBtn').click();
	return true;
}

//====== Load Info ======//

function loadDescription (serviceId) {
	$('#services-description').html('<%= image_tag "ajax-loader.gif", :alt => "Loader" %>');
	$.getJSON('/service', {id: serviceId}, function (service) {
		$('#services-description').html('');
		$('#services-description').html('<dl class="dl-horizontal"></dl>');
		$('.dl-horizontal').append('<dt>' + "Nombre" + '</dt><dd>' + service.name + '</dd>');
		$('.dl-horizontal').append('<dt>' + "Precio" + '</dt><dd>$' + service.price + '</dd>');
		$('.dl-horizontal').append('<dt>' + "Duración" + '</dt><dd>' + service.duration + ' Minutos</dd>');
		if(service.description) {
			$('.dl-horizontal').append('<dt>' + "Descripción" + '</dt><dd>' + service.description + '</dd>');
		}
	});
}

//====== Manage Calendar ======//

var duration = 30;
function loadCalendar (startTime, endTime, hiddenDays) {
	//Default values
	startTime = startTime || 0;
	endTime = endTime || 24;
	hiddenDays = hiddenDays || [];

	var serviceId = $('input[name="serviceRadio"]:checked').val();
	$.getJSON('/service', {id: serviceId}, function (service) {
		duration = service.duration;
		$('#calendar').fullCalendar('removeEvents');
		$('#calendar').empty();
		$('#calendar').fullCalendar({
		    header: {
		    	left: 'title',
		    	center: 'agendaWeek,agendaDay',
		    	right: 'prev,today,next'
		    },
		    firstDay: 1,	//Lunes
		    defaultView: 'agendaWeek',
		    allDaySlot: false,
		    axisFormat: 'HH:mm',
		    timeFormat: 'HH:mm{ - HH:mm}',
		    columnFormat: {
		    	week: 'ddd d/M',
		    	day: 'dddd d/M' 
		    },
		    titleFormat: {
		    	week: 'MMM d[ yyyy]{ &#8212;[ MMM] d yyyy}',
		    	day: 'dddd, d MMM yyyy'  
		    },
		    buttonText: {
			    prev:     '&lsaquo;', // <
			    next:     '&rsaquo;', // >
			    today:    'Hoy',
			    week:     'Semana',
			    day:      'Día'
		    },
		    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
		    monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
		    dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
		    dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
		    minTime: startTime,
		    maxTime: endTime,
		    dayClick: function (date) {
		    	addBooking(date);
		    },
		    defaultEventMinutes: duration,
		    /*eventDrop: function (event, dayDelta, minuteDelta, allDay, revertFunc) {
		    	moveBooking(event, revertFunc);
		    },*/
		    slotMinutes: duration,
		    eventColor: '#ff0000',
		    hiddenDays: hiddenDays
		});
	});
}

function loadProviderTime (providerId) {
	$('#calendar').html('<%= image_tag "ajax-loader.gif", :alt => "Loader" %>');
	$.getJSON('/provider_time', {id: providerId}, function (times) {
		var minHour = 23;
		var minMinuts = 59;
		var maxHour = 00;
		var maxMinuts = 00;
		$.each(times, function (key, time) {
				var openHour = parseInt(getHour(time.open).substr(0, getHour(time.open).indexOf(':')));
				var openMinuts = parseInt(getHour(time.open).substr(getHour(time.open).indexOf(':') + 1));
				var closeHour = parseInt(getHour(time.close).substr(0, getHour(time.close).indexOf(':')));
				var closeMinuts = parseInt(getHour(time.close).substr(getHour(time.close).indexOf(':') + 1));
				if(openHour < minHour) {
					minHour = openHour;
					minMinuts = openMinuts;
				}
				else if (openHour == minHour) {
					if(openMinuts < minMinuts) {
						minMinuts = openMinuts;
					}
				}
				if(closeHour > maxHour) {
					maxHour = closeHour;
					maxMinuts = closeMinuts;
				}
				else if (closeHour == maxHour) {
					if(closeMinuts > maxMinuts) {
						maxMinuts = closeMinuts;
					}
				}
		});
		$.getJSON('/schedule', {local: $('input[name=localRadio]:checked').val()}, function (schedule) {
			hiddenDays = new Array();
			if (!schedule.domingo.length) {
				hiddenDays.push(0);
			}
			if (!schedule.lunes.length) {
				hiddenDays.push(1);
			}
			if (!schedule.martes.length) {
				hiddenDays.push(2);
			}
			if (!schedule.miercoles.length) {
				hiddenDays.push(3);
			}
			if (!schedule.jueves.length) {
				hiddenDays.push(4);
			}
			if (!schedule.viernes.length) {
				hiddenDays.push(5);
			}
			if (!schedule.sabado.length) {
				hiddenDays.push(6);
			}
			loadCalendar(minHour + ':' + minMinuts, maxHour + ':' + maxMinuts, hiddenDays);
			loadProviderBooking(providerId);
		  });
	});
}

function loadProviderBooking (providerId) {
	var localId = $('input[name=localRadio]:checked').val();
	var serviceId = $('input[name=serviceRadio]:checked').val();
	$('#calendar').fullCalendar('removeEvents');
	$.getJSON('/booking', {location: localId, provider: providerId}, function (bookings) {
		$.each(bookings, function (key, booking) {
			var events = {
				title: 'Ocupado',
				allDay: false,
				start: booking.start,
				end: booking.end,
			}
			$('#calendar').fullCalendar('renderEvent', events, true);
		});
	});
}

//====== Manage Booking ======//

function addBooking (date) {
	if (validateBooking(date)) {
		var endDate = new Date(date.getTime() + duration * 60 * 1000);
		$('#calendar').fullCalendar('removeEvents', 'newBooking');
		$('#calendar').fullCalendar('renderEvent',
			{
				id: 'newBooking',
				title: 'Nueva cita',
				allDay: false,
				start: date,
				end: endDate,
				// startEditable: true,
				color: '#1e8584'
			},
			true);
	}
}

function validateBooking (startDate) {
	var valid = true;
	var now = new Date();
	var endDate = new Date(startDate.getTime() + duration * 60 * 1000);
	if (startDate <= now) {
		valid = false;
		myAlert.showAlert(
	      '<h3>Horario Invalido</h3>' +
	      '<p>La fecha/hora elegida es anterior a la fecha/hora actual.</p>'
	    );
	}
	else {
		var localId = $('input[name=localRadio]:checked').val();
		var serviceId = $('input[name=serviceRadio]:checked').val();
		var providerId = $('input[name=staffRadio]:checked').val();
		$.getJSON('/booking', {location: localId, provider: providerId}, function (bookings) {
			$.each(bookings, function (key, booking) {
				var startBooking = $.fullCalendar.parseDate(booking.start);
				var endBooking = $.fullCalendar.parseDate(booking.end);
				if ((endDate > startBooking && endDate < endBooking) || (startDate < endBooking && startDate > startBooking) || (startDate > startBooking && endDate < endBooking)) {
					valid = false;
					myAlert.showAlert(
				      '<h3>Horario Invalido</h3>' +
				      '<p>No se puede agendar con esta persona debido a que ya se encuentra ocupado.</p>'
				    );					alertMessage('No pueden topar los horarios.');
					$('#calendar').fullCalendar('removeEvents', 'newBooking');
				}
			});
		});
	}
	return valid;
}