var booking_buffer = [];
var actual_booking = null;

var current_service;

//====== Load Steps ======//
function loadStep1 (service_id) {
	$('#services-description').empty();
	$('#services-selector').html('<p class="text-center" style="color: #ccc;"><i class="fa fa-spinner fa-spin fa-lg"></i></p>');
	var localId = $('#selectedLocal').data('local').id;
	var categoryCount = 0;
	$.getJSON('/local_services', {location: localId}, function (categorized_services) {
		$('#services-selector').empty();
		$.each(categorized_services, function (key, service_hash) {
			if (service_hash.services.length > 0) {
				var servicesHTML = '';
				categoryCount = categoryCount + 1;
				$.each(service_hash.services, function (key, service) {
					//====== Generando Radios
					servicesHTML +=
						'<li class="list-group-item">' +
							'<div class="radio">' +
								'<label>' +
									'<input type="radio" name="serviceRadio" value="' + service.id + '" data-outcall="'+service.outcall+'">' +
									'<p>' + service.name_with_small_outcall + '</p>' +
								'</label>' +
							'</div>' +
						'</li>';
				});

				//====== Insertando acordeon
				$('#services-selector').append(
					'<div class="panel panel-default">' +
						'<div class="panel-heading dark-gray">' +
							'<h3 class="panel-title minus collapsed" data-toggle="collapse" data-parent="#services-selector" href="#body' + service_hash.id + '">' +
								'<a >' + service_hash.category + '</a>' +
							'</h3>' +
						'</div>' +
						'<div id="body' + service_hash.id + '" class="panel-collapse collapse light-gray">' +
							'<ul class="list-group" id="services-selector' + service_hash.id + '">' +
								servicesHTML +
							'</ul>' +
						'</div>' +
					'</div>'
				);
			};
		});

		var radios = $('input[name=serviceRadio]');
		radios.on('change', function(e) {
			radios.each(function() {
				var radio = $(this);
				radio.closest('.list-group-item')[radio.is(':checked') ? 'addClass' : 'removeClass']('selected-wf-option');
			});
		});

		$('[name="serviceRadio"]').on('click', function(event) {
			//event.preventDefault();
			var serviceId = event.target.getAttribute('value');
			if ($(event.target).data('outcall') == true) {
				$('#outcallAddress').show();
        var settings = $('#bookingForm').validate().settings;
        settings.rules.address = {required: true}
			}
			else {
				$('#outcallAddress').hide();
        var settings = $('#bookingForm').validate().settings;
        delete settings.rules.address;
			}
			var oldTop = $(document).scrollTop();
			$('#foo4').trigger('updateSizes');
			$(document).scrollTop(oldTop);
			loadDescription(serviceId);
		});

		var oldTop = $(document).scrollTop();
		$('#foo4').trigger('updateSizes');
		$(document).scrollTop(oldTop);

		$('.panel-group .panel-default').on('shown.bs.collapse', function (event) {
			var oldTop = $(document).scrollTop();
			$('#foo4').trigger('updateSizes');
			$(document).scrollTop(oldTop);
		});
	 	if (categoryCount == 1) {
	 		$('.panel-collapse').addClass('in');
	 	}

	 	if (service_id != 0) {
	 		$('input[name="serviceRadio"][value="' + service_id + '"]').click();
	 		$('#foo4').trigger('next');
	 		$('input[name="serviceRadio"][value="' + service_id + '"]').closest('.panel-collapse').addClass('in');
	 		$('input[name="serviceRadio"][value="' + service_id + '"]').closest('.panel-collapse').prev().children('.panel-title').removeClass('collapsed');
	 	};
	});

}

var calendar;
var staffSelected;
function loadStep2 () {

	if($('[name="serviceRadio"]').is(':checked')){
		$('#staff-selector').html('<p class="text-center" style="color: #ccc;"><i class="fa fa-spinner fa-spin fa-lg"></i></p>');
		$('.horario').hide();
		selected = false;
		var serviceId = $('input[name=serviceRadio]:checked').val();

		$.getJSON('/providers_services', {id: serviceId, local: $('#selectedLocal').data('local').id}, function (providers) {
			$('#staff-selector').empty();
			if ($('#providerPreference').data('provider-preference') != 1) {
				if (providers.length > 1) {
					$('#staff-selector').append(
						'<li class="list-group-item">' +
							'<div class="radio">' +
								'<label>' +
									'<input type="radio" name="staffRadio" value="0">' +
									'<p>Sin Preferencia</p>' +
								'</label>' +
							'</div>' +
						'</li>'
					);
				}
			}
			if ($('#providerPreference').data('provider-preference') != 2) {
				$.each(providers, function (key, provider) {
					$('#staff-selector').append(
						'<li class="list-group-item">' +
							'<div class="radio">' +
								'<label>' +
									'<input type="radio" name="staffRadio" value="' + provider.id + '">' +
									'<p>' + provider.public_name + '</p>' +
								'</label>' +
							'</div>' +
						'</li>'
					);
				});
			}


			$('[name="staffRadio"]').on('click', function(event) {
				$('.horario').show();

				// if (event.target.getAttribute('value') == 0) {
				// 	$('#provider_lock').val(false);
				// }
				// else {
				// 	$('#provider_lock').val(true);
				// }

				var data;
				if($("#datepicker").val()!="") {
					data = {
						provider: event.target.getAttribute('value'),
						local: $('#selectedLocal').data('local').id,
						service: $('input[name="serviceRadio"]:checked').val(),
						date: $("#datepicker").val()
					}
				} else {
					data = {
						provider: event.target.getAttribute('value'),
						local: $('#selectedLocal').data('local').id,
						service: $('input[name="serviceRadio"]:checked').val()
					}
				}

				if ($(this).val() != staffSelected) {
					staffSelected = $(this).val();
					if (calendar) {
						calendar.rebuild('/get_available_time.json', data);
					}
					else {
						calendar = new Calendar('/get_available_time.json', data);
					}
				};

				$(document).on('hourClick', function (e) {
					addBooking(e);
				});

				$(function () {
					$('.prev-btn').click(function () {
						selected = false;
					});
					$('.next-bn').click(function () {
						selected = false;
					});
				});
			});



			if ($('#providerPreference').data('provider-preference') != 1) {
				$('[name="staffRadio"]').first().prop("checked", true);
				$('[name="staffRadio"]').first().closest('.list-group-item').addClass('selected-wf-option');
				$('.horario').show();
				// $('#provider_lock').val(false);

				var data;

				if($("#datepicker").val()!="") {
					data = {
						provider: $('[name="staffRadio"]').first().val(),
						local: $('#selectedLocal').data('local').id,
						service: $('input[name="serviceRadio"]:checked').val(),
						date: $("#datepicker").val()
					}
				} else {
					data = {
						provider: $('[name="staffRadio"]').first().val(),
						local: $('#selectedLocal').data('local').id,
						service: $('input[name="serviceRadio"]:checked').val()
					}
				}

				if (calendar) {
					calendar.rebuild('/get_available_time.json', data);
				}
				else {
					calendar = new Calendar('/get_available_time.json', data);
				}

				$('#foo4').trigger('updateSizes');

				$(document).on('hourClick', function (e) {
					addBooking(e);
				});

				$(function () {
					$('.prev-btn').click(function () {
						selected = false;
					});
					$('.next-btn').click(function () {
						selected = false;
					});
				});
			}

			var radios = $('input[name=staffRadio]');
			radios.on('change', function() {
				radios.each(function() {
					var radio = $(this);
					radio.closest('.list-group-item')[radio.is(':checked') ? 'addClass' : 'removeClass']('selected-wf-option');
				});
			});
		});

	}
}

function loadStep3 () {
	if ($('#clientExclusive').data('client-exclusive')) {
		$('#identificationNumber').show();
		$('#full_name').prop('disabled', true);
	}
	else {
		$('#identificationNumber').hide();
		$('#full_name').prop('disabled', false);
	}
	if ($('[name="staffRadio"]').is(':checked')){
		if (selected) {
			booking_buffer.push(actual_booking);
			$('#bookings').val(JSON.stringify(booking_buffer));

			// Summary
			$('#summary').empty();
			var service = '';
			var when = '';
			var provider = '';
			for (var i = 0; i < booking_buffer.length; i++) {
				service += '<p class="light-gray">' + booking_buffer[i].service_name + '</p>';
				provider += '<p class="light-gray">' + booking_buffer[i].provider_name + '</p>';
				when += '<p class="light-gray">' + formattedTime(booking_buffer[i].start) + '</p>';
			};

			$('#summary').append(
				'<tr style="border-top: 0px !important;">' +
					'<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
					'<td style="border-top: 0px !important;" class="light-gray">' + service + '</td>' +
				'</tr>' +
				'<tr>' +
					'<td class="dark-gray">¿Dónde?</td>' +
					'<td class="light-gray">' + $('#selectedLocal').data('local').address + ', ' + $('#selectedLocal').data('district') + '</td>' +
				'</tr>' +
				'<tr>' +
					'<td class="dark-gray">¿Con quién?</td>' +
					'<td class="light-gray">' + provider + '</td>' +
				'</tr>' +
				'<tr>' +
					'<td class="dark-gray">¿Cuándo?</th>' +
					'<td class="light-gray">' + when + '</td>' +
				'</tr>'
			);
			if(current_service.online_payable)
			{
				if(current_service.has_discount && current_service.discount > 0)
				{
					$("#summary").append(
						'<tr>' +
							'<td class="dark-gray">Descuento</th>' +
							'<td class="light-gray">Si prepagas tu reserva en línea, tienes un ' + current_service.discount + '% de descuento. <b>¡Te ahorras $' + current_service.price*current_service.discount/100 + '!</b></td>' +
						'</tr>'
					);
				}
				else
				{
					$("#summary").append(
						'<tr>' +
							'<td class="dark-gray">Precio</th>' +
							'<td class="light-gray"><b>$' + current_service.price + '.</b></td>' +
						'</tr>'
					);
				}
			}
			return true;
		}
		myAlert.showAlert(
		  '<h3>Selecciona un Horario</h3>' +
		  '<p>Debes elegir un horario antes de poder continuar.</p>'
		);
		return false;
	}
	myAlert.showAlert(
	  '<h3>Selecciona un Staff</h3>' +
	  '<p>Debes elegir un staff para poder reservar.</p>'
	);
	return false;
}

function checkUserCrossBookings () {
	$(".alert").alert('close');
	var user = $('#user_id').val();
	var booking_start = actual_booking.start;
	var booking_end = actual_booking.end;
	$.getJSON('/check_user_cross_bookings', {user_id: user, booking_start: booking_start, booking_end: booking_end}, function (result) {
		if (result.crossover) {
			var warning = '<div class="alert alert-warning alert-dismissable fade in" style="margin-bottom: 0px;">' +
				'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
				'<strong>¡Advertencia!</strong> Tienes agendado <em>' + result.booking.service + '</em> con <em>' + result.booking.service_provider + '</em> el <em>' + formattedTime(result.booking.start) + '</em>.' +
			'</div>';
			$('#warning').append(warning);
		};
	});
}

var step = 1;
function scrollEvents (direction) {
	if (direction == 'next') {
		if (step == 1) {
			if(!$('[name="serviceRadio"]').is(':checked')) {
				myAlert.showAlert(
				  '<h3>Selecciona un Servicio</h3>' +
				  '<p>Debes elegir un servicio antes de poder continuar.</p>'
				);
				return false;
			}
			else {
				loadStep2();

				step = 2;
				return true;
			}
		}
		else {
			if(!$('[name="staffRadio"]').is(':checked')) {
				myAlert.showAlert(
				  '<h3>Selecciona un Staff</h3>' +
				  '<p>Debes elegir un staff para poder reservar.</p>'
				);
				return false;
			}
			else {
				if(!selected) {
					myAlert.showAlert(
					  '<h3>Selecciona un Horario</h3>' +
					  '<p>Debes elegir un horario antes de poder continuar.</p>'
					);
					return false;
				}
				else {
					loadStep3();
					step = 3;
					return true;
				}
			}
		}
	}
	else if (direction == 'prev') {
		if (step == 3) {
			step = 2;
			booking_buffer.pop();
		};
		return true;
	}
}

//====== Load Info ======//
function loadDescription (serviceId) {
	$('#services-description').html('<tr><td class="text-center" style="color: #ccc;"><i class="fa fa-spinner fa-spin fa-lg"></i></td></tr>');
	$.getJSON('/service', {id: serviceId}, function (service) {
		current_service = service;
		$('#services-description').empty();
		$('#services-description').append(
			'<tr>' +
				'<td class="dark-gray">Nombre:</td>' +
				'<td class="light-gray">' + service.name + '</td>' +
			'</tr>'
		);
		if (service.show_price && service.price && service.price > 0) {
			$('#services-description').append(
				'<tr>' +
					'<td class="dark-gray">Precio:</td>' +
					'<td class="light-gray">$ ' + service.price.toLocaleString() + '</td>' +
				'</tr>'
			);
		}
		else if (service.show_price && service.price == 0) {
			$('#services-description').append(
				'<tr>' +
					'<td class="dark-gray">Precio:</td>' +
					'<td class="light-gray">¡Consultar en Local!</td>' +
				'</tr>'
			);
		}
		else{
			$('#services-description').append(
				'<tr>' +
					'<td class="dark-gray">Precio:</td>' +
					'<td class="light-gray">Consultar en Local</td>' +
				'</tr>'
			);
		};
		$('#services-description').append(
			'<tr>' +
				'<td class="dark-gray">Duración:</td>' +
				'<td class="light-gray">' + service.duration + ' minutos </td>' +
			'</tr>'
		);
		if(service.description) {
			$('#services-description').append(
				'<tr>' +
					'<td class="dark-gray">Descripción:</td>' +
					'<td class="light-gray">' + service.description + '</td>' +
				'</tr>'
			);
		}
		$("#discount").empty();
		$("#normal-book").empty();
		if(service.online_payable){
			$("#reservar1").hide();
			$("#reservar2").show();

			if(service.has_discount && current_service.discount > 0)
			{
				$("#discount").append(
					'Precio final: $' + (service.price-service.price*service.discount/100)
				);
				$("#normal-book").append(
					'Precio final: $' + service.price
				);
			}
		}
		else
		{
			$("#reservar2").hide();
			$("#reservar1").show();
		}
	});
}

//====== Manage Booking ======//
var pressed3 = false;

function addBooking (booking) {
	selected = true;
	actual_booking = {
		start: generateDate(booking.date, booking.start),
		end: generateDate(booking.date, booking.end),
		provider: booking.provider,
		provider_name: $('input[name="staffRadio"]:checked').next().html(),
		provider_lock: $('[name="staffRadio"]:checked').val() == 0 ? false : true,
		service: $('input[name=serviceRadio]:checked').val(),
		service_name: $('input[name=serviceRadio]:checked').next().html()
	};
	checkUserCrossBookings();
}

function generateDate(date, time) {
	var year = date.substring(0, date.indexOf('-'));
	var month = date.substring(date.indexOf('-') + 1, date.lastIndexOf('-'));
	var day = date.substring(date.lastIndexOf('-') + 1);

	time += ':00';

	return year + '-' + month + '-' + day + ' ' + time;
}

function formattedTime (timestamp) {
	var dateString = timestamp;

	var s = new Date(dateString.substring(0, 4), parseInt(dateString.substring(5, 7)) - 1, dateString.substring(8, 10), dateString.substring(11, 13), dateString.substring(14, 16), 0);

	var weekday = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"]

	var monthname = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]

	var day = weekday[s.getDay()];
	var month = monthname[s.getMonth()];

	var formattedStart = day + " " + parseInt(timestamp.substring(8,10)) + " de " + month + " a las " + timestamp.substring(11,16);

	return formattedStart;
}

function blockBookingBufferHour () {
	for (var i = 0; i < booking_buffer.length; i++) {
		var date = booking_buffer[i].start.split(' ')[0]
		var hourBlocks = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora.hora-disponible');
		$.each(hourBlocks, function (key, hourBlock) {
			var start = $(hourBlock).data('start');
			var end = $(hourBlock).data('end');

			var bookingStart = new Date(booking_buffer[i].start);
			var bookingEnd = new Date(booking_buffer[i].end);
			var blockStart = new Date(generateDate(date, start));
			var blockEnd = new Date(generateDate(date, end));

			if ((bookingStart - blockEnd) * (blockStart - bookingEnd) > 0) {
				$(hourBlock).removeClass('hora-disponible').addClass('hora-ocupada');
			};
		});
	};
}

function addNewService () {
	if(!$('[name="staffRadio"]').is(':checked')) {
		myAlert.showAlert(
		  '<h3>Selecciona un Staff</h3>' +
		  '<p>Debes elegir un staff para poder reservar.</p>'
		);
	}
	else {
		if(!selected) {
			myAlert.showAlert(
			  '<h3>Selecciona un Horario</h3>' +
			  '<p>Debes elegir un horario antes de poder continuar.</p>'
			);
		}
		else {
			booking_buffer.push(actual_booking);
			$('input[name=serviceRadio]:checked').prop('checked', false);
			$('#services-description').empty();
			$('#foo4').trigger('prev');
		}
	}
}

var myAlert;
$(function () {
	myAlert  = new Alert();
	$( document ).ajaxComplete(function() {
		var oldTop = $(document).scrollTop();
		$('#foo4').trigger('updateSizes');
		$(document).scrollTop(oldTop);
	});


	$(document).on('calendarBuilded', function (e) {
		blockBookingBufferHour();
		$('#foo4').trigger('updateSizes');
	});

});
