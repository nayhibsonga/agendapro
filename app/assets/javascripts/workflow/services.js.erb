	Date.isLeapYear = function (year) {
        return (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0));
    };

    Date.getDaysInMonth = function (year, month) {
        return [31, (Date.isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month];
    };

    Date.prototype.isLeapYear = function () {
        return Date.isLeapYear(this.getFullYear());
    };

    Date.prototype.getDaysInMonth = function () {
        return Date.getDaysInMonth(this.getFullYear(), this.getMonth());
    };

    Date.prototype.addMonths = function (value) {
        var n = this.getDate();
        this.setDate(1);
        this.setMonth(this.getMonth() + value);
        this.setDate(Math.min(n, this.getDaysInMonth()));
        return this;
    };

var booking_buffer = [];
var actual_booking = null;
var first_session = null;
var sessions_buffer = [];
var sessions_left = 0;
var added_services_count = 0;
var added_services = [];
var sessions_service = false;
var selected = false;
var block_discount = 0;
var reload_times = 0;

var now_date = new Date();
var after_date = now_date.addMonths(parseInt($("#after_booking").val()));

var current_service;

function currency(price)
{
	var amount = price.toString();

	var j = 0;
	var stack = new Array();
	for(i = amount.length-1; i>=0; i--)
	{
		j = j+1;
		stack.push(amount[i]);
		if(j == 3 && i>0)
		{
			stack.push('.');
			j = 0;
		}
	}
	var formatted_amount = "$ ";
	for(i = stack.length-1; i >=0 ; i--)
	{
		formatted_amount = formatted_amount + stack[i];
	}

	return formatted_amount;
}

function simple_currency(price)
{
	var amount = Math.round(price).toString();

	var j = 0;
	var stack = new Array();
	for(i = amount.length-1; i>=0; i--)
	{
		j = j+1;
		stack.push(amount[i]);
		if(j == 3 && i>0)
		{
			stack.push('.');
			j = 0;
		}
	}
	var formatted_amount = "$";
	for(i = stack.length-1; i >=0 ; i--)
	{
		formatted_amount = formatted_amount + stack[i];
	}

	return formatted_amount;
}

//====== Load Steps ======//
function loadStep1 (service_id) {
	$('#services-description').empty();
	$("#services-popovers-contents").empty();
	$('#services-selector').html('<p class="text-center" style="color: #ccc;"><i class="fa fa-spinner fa-spin fa-lg"></i></p>');
	var localId = $('#selectedLocal').data('local').id;
	var categoryCount = 0;
	$.getJSON('/local_services', {location: localId}, function (categorized_services) {
		// window.console.log(categorized_services);
		$('#services-selector').empty();
		$.each(categorized_services, function (key, service_hash) {
			// window.console.log(service_hash);
			if (service_hash.services.length > 0) {
				var servicesHTML = '';
				categoryCount = categoryCount + 1;
				$.each(service_hash.services, function (key, service) {
					// window.console.log(service);
					//====== Generando Radios
					serviceDiscount = "";
					servicePrice = '';

					if ($('#online_capabilities').data('online-payment-capable') && ((service.time_promo_active && service.has_time_discount && $('#online_capabilities').data('promo-offerer-capable')) || (service.has_discount && service.online_payable && service.discount > 0)))
					{
						serviceDiscount = '<div class="col-sm-2 open-promotion-popover" rel="popover" service_id="' + service.id + '" data-toggle="popover" data-placement="right" data-content="">' +
										'<%= image_tag("promociones/icono_promociones.png", class:"promotion-hour-icon", size: "18x18") %>&nbsp;' +
									'</div>';
					}
					else
					{
						serviceDiscount = '<div class="col-sm-2 open-promotion-popover">&nbsp;' +
									'</div>';
					}
					if(service.show_price && service.price > 0)
					{
						servicePrice = '<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %>&nbsp;' + simple_currency(service.price);
					}

					servicesHTML +=
						'<li class="list-group-item">' +
							'<div class="radio">' +
								'<div style="width: 95%"><div class="row">' +
									'<div class="col-sm-4">' +
										'<label>' +
											'<input type="radio" name="serviceRadio" value="' + service.id + '" data-outcall="'+service.outcall+'" data-bundle="'+service.bundle+'">' +
											'<p class="service-selector-text">' + service.name_with_small_outcall + '</p>' +
										'</label>' +
									'</div><div class="col-sm-3 service-selector-price service-selector-text">' +
										servicePrice +
									'</div><div class="col-sm-3 service-selector-text">' +
										'<%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %>&nbsp;' + service.duration + ' min' +
									'</div>' +
									serviceDiscount +
								'</div></div>' +
							'</div>' +
						'</li>';

						if ($('#online_capabilities').data('online-payment-capable') && ((service.time_promo_active && service.has_time_discount && $('#online_capabilities').data('promo-offerer-capable')) || (service.has_discount && service.online_payable && service.discount > 0)))
						{
							$.ajax({
								type: "get",
								url: "get_promotions_popover?service_id=" + service.id + "&location_id=" + localId,
								success: function(response){

									$("#services-popovers-contents").append(response);

									if ($(window).width() < 770)
									{
										$('.open-promotion-popover[service_id="' + service.id + '"]').popover({
											html: true,
											content: $('.service-popover-content[service_id="' + service.id + '"]').html(),
											placement: 'bottom',
											trigger: 'hover'
										});
									}
									else
									{
										$('.open-promotion-popover[service_id="' + service.id + '"]').popover({
											html: true,
											content: $('.service-popover-content[service_id="' + service.id + '"]').html(),
											placement: 'right',
											trigger: 'hover'
										});
									}

									$('.open-promotion-popover[service_id="' + service.id + '"]').css("cursor", "pointer");

									$('.open-promotion-popover').on('shown.bs.popover', function(e){
										if ($(window).width() > 770)
										{
											var oldTop = $(document).scrollTop();
											$('#box-step-1').height($("#box-step-1").height() + 10);
											// $("#foo4").trigger('updateSizes');
											sizeFix();
											$(document).scrollTop(oldTop);
										}
									});

									$('.open-promotion-popover').on('hidden.bs.popover', function(e){
										if ($(window).width() > 770)
										{

											var oldTop = $(document).scrollTop();
											$('#box-step-1').height($("#box-step-1").height() - 10);
											// $("#foo4").trigger('updateSizes');
											sizeFix();
											$(document).scrollTop(oldTop);

										}
									});

								}
							});
						}

				});

				//====== Insertando acordeon
				$('#services-selector').append(
					'<div class="panel panel-default services-selector-subdiv">' +
						'<div class="panel-heading dark-gray services-selector-subdiv">' +
							'<h3 class="panel-title minus collapsed" data-toggle="collapse" data-parent="#services-selector" href="#body' + service_hash.id + '">' +
								'<a >' + service_hash.category + '</a>' +
							'</h3>' +
						'</div>' +
						'<div id="body' + service_hash.id + '" class="panel-collapse collapse light-gray services-selector-subdiv">' +
							'<ul class="list-group" id="services-selector' + service_hash.id + '">' +
								servicesHTML +
							'</ul>' +
						'</div>' +
					'</div>'
				);

				//Reduce font-size if width is lower than 1100px
				if ($(window).width() < 1100)
				{
					$(".service-selector-text").css('font-size', '14px');
					$("promotion-hour-icon").css('height', '14px');
					$("promotion-hour-icon").css('width', '14px');
				}

			};
		});

		var radios = $('input[name=serviceRadio]');
		radios.on('change', function(e) {
			radios.each(function() {
				var radio = $(this);
				radio.closest('.list-group-item')[radio.is(':checked') ? 'addClass' : 'removeClass']('selected-wf-option');
			});
		});

		$('[name="serviceRadio"]').on('click', function(event) {
			//event.preventDefault();
			var serviceId = event.target.getAttribute('value');
			if ($(event.target).data('outcall') == true) {
				$('#outcallAddress').show();
        		var settings = $('#bookingForm').validate().settings;
        		settings.rules.address = {required: true}
			}
			else {
				$('#outcallAddress').hide();
        		var settings = $('#bookingForm').validate().settings;
        		delete settings.rules.address;
			}

			// console.log($(window).width());
			if ($(window).width() > 1200)
			{
				loadDescription(serviceId, $(event.target).data('bundle'));
			}
			else
			{
				loadDescription(serviceId, $(event.target).data('bundle'));
				$("#new-add-service").focus();
			}
		});

		$('.panel-group .panel-default').on('shown.bs.collapse', function (event) {
			var oldTop = $(document).scrollTop();
			sizeFix();
			//$('#foo4').trigger('updateSizes');
			$(document).scrollTop(oldTop);
		});
		$('.panel-group .panel-default').on('hidden.bs.collapse', function (event) {
			var oldTop = $(document).scrollTop();
			sizeFix();
			//$('#foo4').trigger('updateSizes');
			$(document).scrollTop(oldTop);
		});
	 	if (categoryCount == 1) {
	 		$('.panel-collapse').addClass('in');
	 	}

	 	if (service_id != 0) {
	 		$('input[name="serviceRadio"][value="' + service_id + '"]').click();
	 		//$('#foo4').trigger('next');
	 		$('input[name="serviceRadio"][value="' + service_id + '"]').closest('.panel-collapse').addClass('in');
	 		$('input[name="serviceRadio"][value="' + service_id + '"]').closest('.panel-collapse').prev().children('.panel-title').removeClass('collapsed');
	 	};
	});

}

function sizeFix () {
	var height = $('.bug-fix').height();
	$('.caroufredsel_wrapper').css('height', height + 100);
}

var calendar;
var promoCalendar;
var staffSelected;

/*
function loadStep2 () {
	if($('[name="serviceRadio"]').is(':checked')){
		$('#staff-selector-spinner').show();
		$('#staff-selector > .list-group-item').hide();
		$('.horario').hide();
		selected = false;
		var serviceId = $('input[name=serviceRadio]:checked').val();

		if (current_service.has_sessions == true)
		{
			if(booking_buffer.length > 0)
			{
				myAlert.showAlert(
				  '<h3>Este servicio tiene sesiones</h3>' +
				  '<p>No puedes agendar un servicio con sesiones además de otros servicios.</p>'
				);
				return false;
			}
			$(".btn-add-service").attr("disabled", "disabled");
			$(".btn-add-service").hide();
			$(".sessions-bar").show();
			$("#sessions-left").text(current_service.sessions_amount);
			sessions_left = current_service.sessions_amount;
			$("#sessions-explanation-total").html(sessions_left);

			$("#has_sessions").val("1");

			if(sessions_left < 2)
			{
				$(".btn-add-session").attr("disabled", "disabled");
			}
			else
			{
				$(".btn-add-session").attr("disabled", false);
			}

			//Show info modal
		}
		else
		{
			first_session = null;
			$("#has_sessions").val("0");
			$(".sessions-bar").hide();
			$(".btn-add-service").attr("disabled", false);
			$(".btn-add-service").show();
		}

		$.getJSON('/providers_services', {id: serviceId, local: $('#selectedLocal').data('local').id}, function (providers) {
			$('#staff-selector').empty();
			$('#staff-selector').append(
				'<li id="staff-selector-spinner" class="text-center" style="color: #ccc; display: none;"><i class="fa fa-spinner fa-spin fa-lg"></i></li>'
			);
			if ($('#providerPreference').data('provider-preference') != 1) {
				if (providers.length > 1 || $('#providerPreference').data('provider-preference') == 2) {
					$('#staff-selector').append(
						'<li class="list-group-item">' +
							'<div class="radio">' +
								'<label>' +
									'<input type="radio" name="staffRadio" value="0">' +
									'<p>Sin Preferencia</p>' +
								'</label>' +
							'</div>' +
						'</li>'
					);
				}
			}
			if ($('#providerPreference').data('provider-preference') != 2) {
				$.each(providers, function (key, provider) {
					$('#staff-selector').append(
						'<li class="list-group-item">' +
							'<div class="radio">' +
								'<label>' +
									'<input type="radio" name="staffRadio" value="' + provider.id + '">' +
									'<p>' + provider.public_name + '</p>' +
								'</label>' +
							'</div>' +
						'</li>'
					);
				});
			}




			$('[name="staffRadio"]').on('click', function(event) {

				$('.horario').show();

				// if (event.target.getAttribute('value') == 0) {
				// 	$('#provider_lock').val(false);
				// }
				// else {
				// 	$('#provider_lock').val(true);
				// }
				if ($(this).val() != staffSelected) {

					var data;
					if($("#datepicker").val()!="") {
						data = {
							provider: event.target.getAttribute('value'),
							local: $('#selectedLocal').data('local').id,
							service: $('input[name="serviceRadio"]:checked').val(),
							date: $("#datepicker").val()
						}
					} else {
						data = {
							provider: event.target.getAttribute('value'),
							local: $('#selectedLocal').data('local').id,
							service: $('input[name="serviceRadio"]:checked').val()
						}
					}

					staffSelected = $(this).val();
					if (calendar) {
						calendar.rebuild('/promotion_hours', data);
					}
					else {
						calendar = new Calendar('/available_hours_week_html', data);
					}

					// $("#calendar-loader").hide();

				};

				$(document).on('hourClick', function (e) {
					if(!current_service.has_sessions)
					{
						addBooking(e);
					}
					else
					{
						addSession(e);
					}
				});

				$(function () {
					$('.prev-btn').click(function () {
						selected = false;
					});
					$('.next-bn').click(function () {
						selected = false;
					});
				});
			});

			var radios = $('input[name=staffRadio]');
			radios.on('change', function() {
				$('#staff-selector-spinner').show();
				$('#staff-selector > .list-group-item').hide();
				radios.each(function() {
					var radio = $(this);
					radio.closest('.list-group-item')[radio.is(':checked') ? 'addClass' : 'removeClass']('selected-wf-option');
				});
			});


			if ($('#providerPreference').data('provider-preference') != 1) {
				$('[name="staffRadio"]').first().prop("checked", true);
				$('[name="staffRadio"]').first().closest('.list-group-item').addClass('selected-wf-option');
				$('.horario').show();
				// $('#provider_lock').val(false);

				staffSelected = $('[name="staffRadio"]').first().val();

				var data;
				if($("#datepicker").val()!="") {
					data = {
						provider: $('[name="staffRadio"]').first().val(),
						local: $('#selectedLocal').data('local').id,
						service: $('input[name="serviceRadio"]:checked').val(),
						date: $("#datepicker").val()
					}
				} else {
					data = {
						provider: $('[name="staffRadio"]').first().val(),
						local: $('#selectedLocal').data('local').id,
						service: $('input[name="serviceRadio"]:checked').val()
					}
				}

				// $("#calendar-loader").show();



				if (calendar) {
					calendar.rebuild('/available_hours_week_html', data);
				}
				else {
					calendar = new Calendar('/available_hours_week_html', data);
				}

				// $("#calendar-loader").hide();


				$('#foo4').trigger('updateSizes');

				$(document).on('hourClick', function (e) {
					if(!current_service.has_sessions)
					{
						addBooking(e);
					}
					else
					{
						addSession(e);
					}
				});

				$(function () {
					$('.prev-btn').click(function () {
						selected = false;
					});
					$('.next-btn').click(function () {
						selected = false;
					});
				});
			}

		});

	}

}
*/

function loadStep2() {

	var localId = $('#selectedLocal').data('local').id;
	var selects = [];
	var start_date = $("#optimizerDateSelector").val();

	sessions_left = 0;

	$("#selected-hour-body").empty();

	for(k = 0; k < added_services.length; k++)
	{
		if (added_services[k].has_sessions)
		{
			sessions_service = true;
			loadStaffForSessions(added_services[k].id, $(".selected-service .selected-service-provider").val());
			sessions_left = added_services[k].sessions_amount;
		}
		else
		{
			if(added_services.length < 2)
			{
				loadStaffForSessions(added_services[k].id, $(".selected-service .selected-service-provider").val());
			}
			sessions_service = false;
			sessions_left = 0;
		}
	}

	if(sessions_service)
	{
		$(".btn-add-session").show();
		$(".sessions-bar").show();
		$(".changeStaffPanel").show();
		$("#sessions-summary").show();
		$("#sessions-left").empty();
		$("#sessions-left").html("" + sessions_left);

		$("#has_sessions").val("1");
	}
	else
	{
		$(".btn-add-session").hide();
		$(".sessions-bar").hide();
		$(".changeStaffPanel").hide();
		$("#sessions-left").empty();
		$("#has_sessions").val("0");

		if (added_services.length < 2)
		{
			$(".changeStaffPanel").show();
		}

	}

	$(".selected-service").each(function() {
		var provider = $(this).find('.selected-service-provider').val();
		var service_id = $(this).attr("service_id");
		var bundle_id = $(this).attr("bundle_id");

		selects.push({
			service: service_id,
			provider: provider,
			bundle_id: bundle_id
		});
	});

	var data;

	if($("#datepicker").val()!="")
	{
		data = {local: localId, serviceStaff: JSON.stringify(selects), date: $("#datepicker").val()}
	}
	else
	{
		data = {local: localId, serviceStaff: JSON.stringify(selects)}
	}

	if (promoCalendar) {
		promoCalendar.rebuild('/promotion_hours', data);
	}
	else {
		promoCalendar = new PromoCalendar('/promotion_hours', data);
	}


	$(document).on('hourClick', function (e) {

		selected = true;

		bookSummary = bookSummaries[e.index];

		$("#selected-hour-body").empty();
		var book_discount = 0;
		var is_time_discount = false;
		var is_treatment_discount = false;
		booking_buffer = []

		for(k=0; k<bookSummary.bookings.length; k++)
		{
			bookDetails = bookSummary.bookings[k];

			bookDetailsStart = bookDetails.start.split("T")[1].split(":")[0] + ':' + bookDetails.start.split("T")[1].split(":")[1];
			bookDetailsEnd = bookDetails.end.split("T")[1].split(":")[0] + ':' + bookDetails.end.split("T")[1].split(":")[1];

			bookDetailsDiscountPrice = bookDetails.price;

			// console.log(bookDetails);

			if(bookDetails.show_price)
			{

				if(sessions_service)
				{
					if(bookDetails.has_discount && bookDetails.has_treatment_discount)
					{
						if(bookDetails.discount > bookDetails.treatment_discount)
						{
							book_discount = bookDetails.discount;
							bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.discount) / 100;
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %>  <strike>' + simple_currency(bookDetails.price) + '</strike>  <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.discount + ' % off) <br /></div>'
							);
						}
						else
						{
							book_discount = bookDetails.treatment_discount;
							is_treatment_discount = true;
							bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.treatment_discount) / 100;
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %>' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> ' + '<span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span>' + ' (' + bookDetails.treatment_discount + ' % off) <br /></div>'
							);
						}
					}
					else if(bookDetails.has_discount && !bookDetails.has_treatment_discount)
					{
						book_discount = bookDetails.discount;
						bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.discount) / 100;
						$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.discount + ' % off) <br /></div>'
							);
					}
					else if(!bookDetails.has_discount && bookDetails.has_treatment_discount)
					{
						book_discount = bookDetails.treatment_discount;
						is_treatment_discount = true;
						bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.treatment_discount) / 100;
						$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.treatment_discount + ' % off) <br /></div>'
							);
					}
					else
					{
						book_discount = 0;
						if(bookDetails.price > 0)
						{
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> ' + simple_currency(bookDetails.price) + '<br /></div>'
							);
						}
						else
						{
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd +
								'</div>'
							);
						}
					}
				}
				else
				{
					if(bookDetails.has_discount && bookDetails.has_time_discount)
					{
						if(bookDetails.discount > bookDetails.time_discount)
						{
							book_discount = bookDetails.discount;
							bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.discount) / 100;
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %>  <strike>' + simple_currency(bookDetails.price) + '</strike>  <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.discount + ' % off) <br /></div>'
							);
						}
						else
						{
							book_discount = bookDetails.time_discount;
							is_time_discount = true;
							bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.time_discount) / 100;
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %>' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> ' + '<span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span>' + ' (' + bookDetails.time_discount + ' % off) <br /></div>'
							);
						}
					}
					else if(bookDetails.has_discount && !bookDetails.has_time_discount)
					{
						book_discount = bookDetails.discount;
						bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.discount) / 100;
						$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.discount + ' % off) <br /></div>'
							);
					}
					else if(!bookDetails.has_discount && bookDetails.has_time_discount)
					{
						book_discount = bookDetails.time_discount;
						is_time_discount = true;
						bookDetailsDiscountPrice = bookDetails.price * (100 - bookDetails.time_discount) / 100;
						$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.time_discount + ' % off) <br /></div>'
							);
					}
					else
					{
						book_discount = 0;
						if(bookDetails.price > 0)
						{
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
								'<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> ' + simple_currency(bookDetails.price) + '<br /></div>'
							);
						}
						else
						{
							$("#selected-hour-body").append(
								'<b>' + bookDetails.service_name + '</b><br />' +
								'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd +
								'</div>'
							);
						}
					}
				}
			}
			else
			{
				book_discount = 0;
				is_time_discount = false;
				$("#selected-hour-body").append(
					'<b>' + bookDetails.service_name + '</b><br />' +
					'<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd +
					'</div>'
				);
			}


			if(!sessions_service)
			{
				addBooking(e, k, book_discount, is_time_discount);
				booking_buffer.push(actual_booking);
			}

		}

		if (sessions_service)
		{
			addSession(e, book_discount, is_treatment_discount);
		}
	});


}

function loadStep3 () {

	if(!selected)
	{
		swal({
			title: "Selecciona un horario",
			text: "Debes elegir un horario para continuar.",
			type: "error"
		});
		return false;
	}

	$("#booking-error").empty();
	$('#promo-bookings-policy').empty();
	$('#promo-policy').hide();

		if(sessions_buffer.length == 0)
		{
			if(actual_booking == null)
			{
				swal({
					title: "Selecciona un Horario",
					text: "Debes elegir un horario para continuar.",
					type: "error"
				});
				return false;
			}
			if(actual_booking.has_sessions)
	        {
	            $('#summary').empty();

	            sessions_buffer.push(actual_booking);

	            $('.bookings').val(JSON.stringify(sessions_buffer));

	            var times_str = "";
	            var price = actual_booking.price;
	            var min_discount = actual_booking.discount;
	            var must_pay = false;

	            for(i = 0; i < sessions_buffer.length; i++)
	            {
	              times_str = times_str + formattedTime(sessions_buffer[i].start) + ' con ' + sessions_buffer[i].provider_name + '.<br />';
	              if(sessions_buffer[i].discount < min_discount)
	              {
	                min_discount = sessions_buffer[i].discount;
	              }
	              if((sessions_buffer[i].is_time_discount && sessions_buffer[i].discount > 0) || (sessions_buffer[i].must_be_paid_online && sessions_buffer[i].discount > 0 ))
				  {
				  	must_pay = true;
				  }
				  if(sessions_buffer[i].is_time_discount && sessions_buffer[i].discount > 0)
				  {
					$('#promo-bookings-policy').append(formattedTime(sessions_buffer[i].start) + ' con ' + sessions_buffer[i].provider_name + '.<br />');
					$('#promo-policy').show();
				  }
	            }

	            $("#max_discount").val(min_discount);

	            var discount_price = Math.round(price*(100 - min_discount)/100);
	            sessions_str = "";

	            if(sessions_buffer.length == 1)
	            {
	              sessions_str = 'Agendaste 1 sesión de un total de ' + actual_booking.sessions_amount;
	            }
	            else
	            {
	              sessions_str = 'Agendaste ' + sessions_buffer.length + ' sesiones de un total de ' + actual_booking.sessions_amount;
	            }

	            $('#summary').append(
	              '<tr style="border-top: 0px !important;">' +
	                '<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
	                '<td style="border-top: 0px !important;" class="light-gray">' + actual_booking.service_name + '</td>' +
	              '</tr>' +
	              '<tr>' +
	                '<td class="dark-gray">¿Dónde?</td>' +
	                '<td class="light-gray">' + $('#selectedLocal').data('local').short_address + '</td>' +
	              '</tr>'
	            );

	            $('#summary').append(
	              '<tr>' +
	                '<td class="dark-gray">¿Cuándo?</td>' +
	                '<td class="light-gray">' + times_str + '</td>' +
	              '</tr>' +
	              '<tr>' +
	                '<td class="dark-gray">Sesiones</td>' +
	                '<td class="light-gray">' + sessions_str + '</td>' +
	              '</tr>'
	            );

	            if($('#online_capabilities').data('online-payment-capable') && actual_booking.show_price)
	            {
		            $('#summary').append(
		              '<tr>' +
		                '<td class="dark-gray">Precio normal</td><td class="light-gray">' + simple_currency(price) + '</td>' +
		              '</tr>' +
		              '<tr>' +
		                '<td class="dark-gray">Descuento</td><td class="light-gray">' + min_discount + '% </td>' +
		              '</tr>' +
		              '<tr>' +
		                '<td class="dark-gray">Precio final</td><td class="light-gray">' + simple_currency(discount_price) + '</td>' +
		              '</tr>'
		            );
		            if(must_pay)
		            {
		            	$("#reservar2").show();
						$(".payBtn").show();
						$("#open-online-policy").show();
						$("#discount").empty();
						$("#discount").append(
							'Precio final: ' +  currency(Math.round(discount_price))
						);
		            	$("#normal-book").empty();
						$(".submitBtn").hide();
		            }
	        	}
	        	else
	        	{
	        		if(actual_booking.show_price && actual_booking.price > 0)
	        		{
		        		$('#summary').append(
			              '<tr>' +
			                '<td class="dark-gray">Precio</td><td class="light-gray">' + simple_currency(price) + '</td>' +
			              '</tr>'
			            );
		        	}
		        	else
		        	{
		        		$('#summary').append(
			              '<tr>' +
			                '<td class="dark-gray">Precio</td><td class="light-gray">Preguntar en local</td>' +
			              '</tr>'
			            );
		        	}
		            $(".payBtn").hide();
					$("#open-online-policy").hide();
					$("#discount").empty();
	        	}

	        	if(!actual_booking.online_payable || !actual_booking.show_price)
	        	{
	        		$(".payBtn").hide();
					$("#open-online-policy").hide();
					$("#discount").empty();
	        	}
	        }
	        else
	        {
	        	if(booking_buffer.length == 0)
	        	{
	        		swal({
	        			title: "Selecciona un Horario",
	        			text: "Debes elegir un horario para continuar.",
	        			type: "error"
	        		});
					return false;
	        	}
	        	else
	        	{
	        		$('.bookings').val(JSON.stringify(booking_buffer));
	        		$('#summary').empty();


					var services_str = '';
					var times_str = '';
					var discounts_str = '';
					var max_discount = 0;
					var min_pay = '';
					var may_pay = false;
					var must_pay = false;
					var some_not_payable = false;
					var total_price = 0;
					var min_price = 0;
					var just_book_price = 0;
					var not_payable_price = 0;
					var prices_str = '';
					var ask_in_location = false;

					times_str = times_str + formattedTime(booking_buffer[0].start) + '.<br />';

					for(k = 0; k < booking_buffer.length; k++)
					{


						var booking = booking_buffer[k];
						var price = booking.price;
						var discount = booking.discount;
						var provider_str = $('#providerPreference').data('provider-preference') == 2 ? '' : ' con ' + booking.provider_name;


						services_str = services_str + booking.service_name + provider_str + '.<br />';

						if(booking.has_discount && discount > 0 && booking.online_payable && booking.show_price)
						{


							//may_pay = true;
							if(discount > max_discount)
							{
								max_discount = discount;
							}
							if(booking.is_time_discount || booking.must_be_paid_online)
							{
								min_price = min_price + Math.round(price * (100 - discount) / 100);
								prices_str = prices_str + '<strike>' + simple_currency(price) + '</strike> - ' + simple_currency(Math.round(price * (100 - discount) / 100)) + ' (' + discount + '% de descuento)<br />';
								if(discount > 0)
								{
									must_pay = true;
								}
								else
								{
									may_pay = true;
								}
								if(booking.is_time_discount)
								{

									var provider_str = $('#providerPreference').data('provider-preference') == 2 ? '' : ' con ' + booking.provider_name;
									$('#promo-bookings-policy').append(booking.service_name + provider_str + '.<br />');
									$('#promo-policy').show();
								}
							}
							else
							{
								may_pay = true;
								prices_str = prices_str + '<strike>' + simple_currency(price) + '</strike> - ' + simple_currency(Math.round( (price * (100 - discount))/100 )) + ' (' + discount + '% de descuento)<br />';

							}
							total_price = total_price + Math.round(price * (100 - discount) / 100);


						}
						else
						{

							if(booking.show_price && booking.price > 0)
							{
								prices_str = prices_str + simple_currency(price) + '<br />';

								if(!booking.online_payable)
								{
									some_not_payable = true;
									not_payable_price = not_payable_price + Math.round(price);
								}
								else
								{
									may_pay = true;
									total_price = total_price + Math.round(price);
								}
								just_book_price = just_book_price + price;
							}
							else
							{
								prices_str = prices_str + 'Preguntar en local<br />';
								ask_in_location = true;
								some_not_payable = true;
							}
						}

					}



					$('#summary').append(
						'<tr style="border-top: 0px !important;">' +
						  '<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
						  '<td style="border-top: 0px !important;" class="light-gray">' + services_str + '</td>' +
						'</tr>' +
						'<tr>' +
						  '<td class="dark-gray">¿Dónde?</td>' +
						  '<td class="light-gray">' + $('#selectedLocal').data('local').short_address + '</td>' +
						'</tr>'
					);

					$('#summary').append(
						'<tr>' +
						  '<td class="dark-gray">¿Cuándo?</td>' +
						  '<td class="light-gray">' + times_str + '</td>' +
						'</tr>'
					);

					$("#summary").append(
						'<tr>' +
						  '<td class="dark-gray">Precios</td>' +
						  '<td class="light-gray">' + prices_str + '</td>' +
						'</tr>'
					);

					/*$("#summary").append(
						'<tr>' +
							'<td class="dark-gray">Pago mínimo en línea</td>' +
							'<td class="light-gray">' + simple_currency(min_price) + '</td>' +
						'</tr>'
					);*/


					if(!must_pay && may_pay)
					{

						$("#summary").append(
							'<tr>' +
								'<td class="dark-gray">Precio pago en línea</td>' +
								'<td class="light-gray">' + simple_currency(total_price) + '</td>' +
							'</tr>'
						);

						if(some_not_payable)
						{
							$("#summary").append(
								'<tr>' +
									'<td class="dark-gray">Pago pendiente en local</td>' +
									'<td class="light-gray">' + simple_currency(not_payable_price) + '</td>' +
								'</tr>'
							);
						}

						$("#summary").append(
							'<tr>' +
								'<td class="dark-gray">Precio sólo pago en local</td>' +
								'<td class="light-gray">' + simple_currency(just_book_price) + '</td>' +
							'</tr>'
						);



						$("#open-online-policy").show();

						$(".payBtn").show();
						$("#discount").empty();
						$("#discount").append(
							'Precio final: ' +  currency(Math.round(total_price))
						);


						$(".submitBtn").show();
						$("#normal-book").empty();
						if(just_book_price > 0)
						{
							$("#normal-book").append(
								'Precio final: ' + currency(just_book_price)
							);
						}

						if(ask_in_location)
						{
							$("#summary").append(
							'<tr>' +
								'<td class="dark-gray">Otros</td>' +
								'<td class="light-gray">Pregunta en local por los servicios sin precio publicado.</td>' +
							'</tr>'
							);

							$("#discount").append(
								'<br/>Pregunta en local por los servicios sin precio publicado'
							);

							$("#normal-book").append(
								'<br/>Pregunta en local por los servicios sin precio publicado'
							);
						}
					}
					else if(!may_pay && !must_pay)
					{


						if(just_book_price > 0)
						{
							$("#summary").append(
								'<tr>' +
									'<td class="dark-gray">Precio en local</td>' +
									'<td class="light-gray">' + simple_currency(just_book_price) + '</td>' +
								'</tr>'
							);
						}

						$(".payBtn").hide();
						$("#open-online-policy").hide();
						$("#discount").empty();

						$(".submitBtn").show();
						$("#normal-book").empty();
						if(just_book_price > 0)
						{
							$("#normal-book").append(
								'Precio final: ' + currency(just_book_price)
							);
						}

						if(ask_in_location)
						{
							$("#summary").append(
							'<tr>' +
								'<td class="dark-gray">Otros</td>' +
								'<td class="light-gray">Pregunta en local por los servicios sin precio publicado.</td>' +
							'</tr>'
							);

							$("#normal-book").append(
								'<br/>Pregunta en local por los servicios sin precio publicado'
							);
						}
					}
					else if(must_pay)
					{

						$("#reservar2").show();
						$(".payBtn").show();
						$("#open-online-policy").show();
						$("#discount").empty();
						$("#discount").append(
							'Precio final: ' +  currency(Math.round(total_price))
						);

						$("#summary").append(
							'<tr>' +
								'<td class="dark-gray">Precio total&nbsp;' + '<span style="cursor: pointer; float: right;" data-toggle="tooltip" data-placement="right" title="El precio total considera el precio a prepagar en línea, más el precio que deberás pagar en el local por aquellos servicios que no pueden ser prepagados."><i class="fa fa-question-circle fa-lg"></i></span></td>' +
								'<td class="light-gray">' + simple_currency(not_payable_price + total_price) + '</td>' +
							'</tr>'
						);

						$("#summary").append(
							'<tr>' +
								'<td class="dark-gray">Pago en línea&nbsp;' + '<span style="cursor: pointer; float: right;" data-toggle="tooltip" data-placement="right" title="Existen servicios en promoción o que se deben prepagar en línea. Debes cancelar esta suma para poder reservarlos."><i class="fa fa-question-circle fa-lg"></i></span></td>' +
								'<td class="light-gray">' + simple_currency(total_price) + '</td>' +
							'</tr>'
						);


						if(some_not_payable)
						{
							if(not_payable_price > 0)
							{
								$("#summary").append(
									'<tr>' +
										'<td class="dark-gray">Pago pendiente en local&nbsp;' + '<span style="cursor: pointer; float: right;" data-toggle="tooltip" data-placement="right" title="Existen servicios que no pueden ser pagados en línea. Deberás cancelar su precio el día de la reserva en el local."><i class="fa fa-question-circle fa-lg"></i></span></td>' +
										'<td class="light-gray">' + simple_currency(not_payable_price) + '</td>' +
									'</tr>'
								);
							}
						}

						if(ask_in_location)
						{
							$("#summary").append(
							'<tr>' +
								'<td class="dark-gray">Otros</td>' +
								'<td class="light-gray">Pregunta en local por los servicios sin precio publicado.</td>' +
							'</tr>'
							);

							$("#discount").append(
								'<br/>Pregunta en local por los servicios sin precio publicado'
							);
						}

						$("#normal-book").empty();
						$(".submitBtn").hide();
					}

	        	}
	        }
	    }
	    else
	    {
	    	$('#summary').empty();

			sessions_buffer.push(actual_booking);

			$('.bookings').val(JSON.stringify(sessions_buffer));

			var times_str = "";
			var price = actual_booking.price;
			var min_discount = actual_booking.discount;
			var must_pay = false;
			var ask_in_location = false;

			for(i = 0; i < sessions_buffer.length; i++)
			{

				var provider_str = $('#providerPreference').data('provider-preference') == 2 ? '' : ' con ' + sessions_buffer[i].provider_name;
				times_str = times_str + formattedTime(sessions_buffer[i].start) + provider_str + '.<br />';
				if(sessions_buffer[i].discount < min_discount)
				{
				  	min_discount = sessions_buffer[i].discount;
				}
				if((sessions_buffer[i].is_time_discount || sessions_buffer[i].must_be_paid_online) && actual_booking.discount > 0)
				{
				  	must_pay = true;
				}
				if(sessions_buffer[i].is_time_discount && sessions_buffer[i].discount > 0)
				{
					var provider_str = $('#providerPreference').data('provider-preference') == 2 ? '' : ' con ' + sessions_buffer[i].provider_name;
					$('#promo-bookings-policy').append(formattedTime(sessions_buffer[i].start) + provider_str + '.<br />');
					$('#promo-policy').show();
				}
			}

			$("#max_discount").val(min_discount);

			var discount_price = Math.round(price*(100 - min_discount)/100);

			if(sessions_buffer.length == 1)
			{
				sessions_str = 'Agendaste 1 sesión de un total de ' + actual_booking.sessions_amount;
			}
			else
			{
				sessions_str = 'Agendaste ' + sessions_buffer.length + ' sesiones de un total de ' + actual_booking.sessions_amount;
			}

			$('#summary').append(
				'<tr style="border-top: 0px !important;">' +
				  '<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
				  '<td style="border-top: 0px !important;" class="light-gray">' + actual_booking.service_name + '</td>' +
				'</tr>' +
				'<tr>' +
				  '<td class="dark-gray">¿Dónde?</td>' +
				  '<td class="light-gray">' + $('#selectedLocal').data('local').short_address + '</td>' +
				'</tr>'
			);

			$('#summary').append(
				'<tr>' +
				  '<td class="dark-gray">¿Cuándo?</td>' +
				  '<td class="light-gray">' + times_str + '</td>' +
				'</tr>' +
				'<tr>' +
				  '<td class="dark-gray">Sesiones</td>' +
				  '<td class="light-gray">' + sessions_str + '</td>' +
				'</tr>'
			);

			if($('#online_capabilities').data('online-payment-capable') && actual_booking.show_price)
			{
				$('#summary').append(
					'<tr>' +
					  '<td class="dark-gray">Precio normal</td><td class="light-gray">' + simple_currency(price) + '</td>' +
					'</tr>' +
					'<tr>' +
					  '<td class="dark-gray">Descuento</td><td class="light-gray">' + min_discount + '% </td>' +
					'</tr>' +
					'<tr>' +
					  '<td class="dark-gray">Precio final</td><td class="light-gray">' + simple_currency(discount_price) + '</td>' +
					'</tr>'
				);
				if(must_pay)
	            {
	            	$("#reservar2").show();
					$(".payBtn").show();
					$("#open-online-policy").show();
					$("#discount").empty();
					$("#discount").append(
						'Precio final: ' +  currency(Math.round(discount_price))
					);
	            	$("#normal-book").empty();
					$(".submitBtn").hide();
	            }
			}
			else
			{
				if(actual_booking.show_price)
				{
					$('#summary').append(
						'<tr>' +
						  '<td class="dark-gray">Precio normal</td><td class="light-gray">' + simple_currency(price) + '</td>' +
						'</tr>'
					);
				}
				else
	        	{
	        		$('#summary').append(
		              '<tr>' +
		                '<td class="dark-gray">Precio</td><td class="light-gray">Preguntar en local</td>' +
		              '</tr>'
		            );
	        	}
				$(".payBtn").hide();
				$("#open-online-policy").hide();
				$("#discount").empty();
			}

			if(!actual_booking.online_payable || !actual_booking.show_price)
        	{
        		$(".payBtn").hide();
				$("#open-online-policy").hide();
				$("#discount").empty();
        	}
	    }


		if ($('#clientExclusive').data('client-exclusive')) {
			$('#identificationNumber').show();
			$('#full_name').prop('disabled', true);
		}
		else {
			$('#identificationNumber').hide();
			$('#full_name').prop('disabled', false);
		}

		$("#foo4").trigger("updateSizes");


	/*if ($('[name="staffRadio"]').is(':checked')){
		if (selected) {


			if(first_session == null)
			{
				booking_buffer.push(actual_booking);
				$('.bookings').val(JSON.stringify(booking_buffer));
				$("#has_sessions").val("0");
				// Summary
				$('#summary').empty();
				var service = '';
				var when = '';
				var provider = '';
				var prices = '';
				var payable_prices = '';
				var payable = true;
				var price = 0;
				var discounted_price = 0;
				var show_all = true;
				for (var i = 0; i < booking_buffer.length; i++) {
					console.log("Booking payable: " + booking_buffer[i].online_payable);
					service += '<p class="light-gray">' + booking_buffer[i].service_name + '</p>';
					provider += '<p class="light-gray">' + booking_buffer[i].provider_name + '</p>';
					when += '<p class="light-gray">' + formattedTime(booking_buffer[i].start) + '</p>';
					if(!booking_buffer[i].online_payable || !booking_buffer[i].show_price || booking_buffer[i].price == 0)
					{
						payable = false;
						if(!booking_buffer[i].show_price || booking_buffer[i].price == 0)
						{
							show_all = false;
						}
					}
					else
					{
						if (booking_buffer[i].has_discount)
						{
							payable_prices += '<p class="light-gray">Precio normal: ' + currency(booking_buffer[i].price) + ' - Descuento: ' + booking_buffer[i].discount + '%<br />Precio con descuento: ' +  currency(Math.round((100-booking_buffer[i].discount)*booking_buffer[i].price/100)) + '</p>';
							discounted_price = discounted_price + (100-booking_buffer[i].discount)*booking_buffer[i].price/100;
						}
						else
						{
							payable_prices += '<p class="light-gray">Precio normal: ' + currency(booking_buffer[i].price) + ' - (Sin descuento)</p>';
							discounted_price = discounted_price + booking_buffer[i].price;
						}
					}
					if(booking_buffer[i].show_price && booking_buffer[i].price > 0)
					{
						prices += '<p class="light-gray">' + currency(booking_buffer[i].price) + '</p>';
						price = price + booking_buffer[i].price;
					}
					else
					{
						prices += '<p class="light-gray">Preguntar en local.</p>';
					}
				};

				$('#summary').append(
					'<tr style="border-top: 0px !important;">' +
						'<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
						'<td style="border-top: 0px !important;" class="light-gray">' + service + '</td>' +
					'</tr>' +
					'<tr>' +
						'<td class="dark-gray">¿Dónde?</td>' +
						'<td class="light-gray">' + $('#selectedLocal').data('local').address + ', ' + $('#selectedLocal').data('district') + '</td>' +
					'</tr>' +
					'<tr>' +
						'<td class="dark-gray">¿Con quién?</td>' +
						'<td class="light-gray">' + provider + '</td>' +
					'</tr>' +
					'<tr>' +
						'<td class="dark-gray">¿Cuándo?</td>' +
						'<td class="light-gray">' + when + '</td>' +
					'</tr>'
				);
				if(payable)
				{
					$('#summary').append(
						'<tr>' +
							'<td class="dark-gray">Precios</td>' +
							'<td class="light-gray">' + payable_prices + '</td>' +
						'</tr>' +
						'<tr>' +
							'<td class="dark-gray">Precio normal:</td>' +
							'<td class="light-gray">' + currency(price) + '</td>' +
						'</tr>' +
						'<tr>' +
							'<td class="dark-gray">Precio pago en línea:</td>' +
							'<td class="light-gray">' + currency(Math.round(discounted_price)) + '</td>' +
						'</tr>'
					);

				}
				else
				{
					$('#summary').append(
						'<tr>' +
							'<td class="dark-gray">Precios</td>' +
							'<td class="light-gray">' + prices + '</td>' +
						'</tr>'
					);
				}
				$("#discount").empty();
				$("#normal-book").empty();
				if(payable){
					$("#reservar1").hide();
					$("#reservar2").show();
					$("#discount").append(
						'Precio final: ' +  currency(Math.round(discounted_price))
					);
					$("#normal-book").append(
						'Precio final: ' + currency(price)
					);
				}
				else
				{
					$("#reservar2").hide();
					$("#reservar1").show();
				}
				return true;
			}
			else
			{

				sessions_buffer.push(actual_booking);

				booking_buffer = [];

				for(i=0; i < sessions_buffer.length; i++)
				{
					booking_buffer.push(sessions_buffer[i]);
				}
				$('.bookings').val(JSON.stringify(booking_buffer));
				$("#has_sessions").val("1");
				$('#summary').empty();
				var service = first_session.service_name;
				var when = '<p class="light-gray">' + formattedTime(first_session.start) + '</p>';
				//var provider = first_session.provider_name;
				var prices = '';
				var payable_prices = '';
				var payable = true;
				var price = 0;
				var discounted_price = 0;
				var show_all = true;


				if(!first_session.online_payable || !first_session.show_price || first_session.price == 0)
				{
					payable = false;
					if(!first_session.show_price || first_session.price == 0)
					{
						show_all = false;
					}
				}
				else
				{
					if (first_session.has_discount)
					{
						payable_prices += '<p class="light-gray">Precio normal: ' + currency(first_session.price) + ' - Descuento: ' + first_session.discount + '%<br />Precio con descuento: ' +  currency(Math.round((100-first_session.discount)*first_session.price/100)) + '</p>';
						discounted_price = discounted_price + (100-first_session.discount)*first_session.price/100;
					}
					else
					{
						payable_prices += '<p class="light-gray">Precio normal: ' + currency(first_session.price) + ' - (Sin descuento)</p>';
						discounted_price = discounted_price + first_session.price;
					}
				}
				if(first_session.show_price && first_session.price > 0)
				{
					prices += '<p class="light-gray">' + currency(first_session.price) + '</p>';
					price = price + first_session.price;
				}
				else
				{
					prices += '<p class="light-gray">Preguntar en local.</p>';
				}


				$('#summary').append(
					'<tr style="border-top: 0px !important;">' +
						'<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
						'<td style="border-top: 0px !important;" class="light-gray">' + service + '</td>' +
					'</tr>' +
					'<tr>' +
						'<td class="dark-gray">¿Dónde?</td>' +
						'<td class="light-gray">' + $('#selectedLocal').data('local').address + ', ' + $('#selectedLocal').data('district') + '</td>' +
					'</tr>'

				);
				if(payable)
				{
					$('#summary').append(
						'<tr>' +
							'<td class="dark-gray">Precios</td>' +
							'<td class="light-gray">' + payable_prices + '</td>' +
						'</tr>' +
						'<tr>' +
							'<td class="dark-gray">Precio normal:</td>' +
							'<td class="light-gray">' + currency(price) + '</td>' +
						'</tr>' +
						'<tr>' +
							'<td class="dark-gray">Precio pago en línea:</td>' +
							'<td class="light-gray">' + currency(Math.round(discounted_price)) + '</td>' +
						'</tr>'
					);

				}
				else
				{
					$('#summary').append(
						'<tr>' +
							'<td class="dark-gray">Precios</td>' +
							'<td class="light-gray">' + prices + '</td>' +
						'</tr>'
					);
				}
				$("#discount").empty();
				$("#normal-book").empty();
				if(payable){
					$("#reservar1").hide();
					$("#reservar2").show();
					$("#discount").append(
						'Precio final: ' +  currency(Math.round(discounted_price))
					);
					$("#normal-book").append(
						'Precio final: ' + currency(price)
					);
				}
				else
				{
					$("#reservar2").hide();
					$("#reservar1").show();
				}

				$('#summary').append(
					'<tr>' +
						'<td class="dark-gray">Sesiones</td>' +
						'<td class="light-gray">' + (sessions_buffer.length) + ' agendadas de ' + first_session.sessions_amount + '</td>' +
					'</tr>'
				);

				if(sessions_buffer.length > 0)
				{

					for(i=0; i<sessions_buffer.length; i++)
					{
						$("#summary").append(
							'<tr><td></td><td class="light-gray">' + formattedTime(sessions_buffer[i].start) + ', con ' + sessions_buffer[i].provider_name + '</td></tr>'
						);
					}

				}

				return true;


			}
		}
		myAlert.showAlert(
		  '<h3>Selecciona un Horario</h3>' +
		  '<p>Debes elegir un horario antes de poder continuar.</p>'
		);
		return false;
	}*/
}

function checkUserCrossBookings () {
	$(".alert").alert('close');
	var user = $('#user_id').val();
	var booking_start = actual_booking.start;
	var booking_end = actual_booking.end;
	$.getJSON('/check_user_cross_bookings', {user_id: user, booking_start: booking_start, booking_end: booking_end}, function (result) {
		if (result.crossover) {
			$('#warning').empty();
			var warning = '<div class="alert alert-warning alert-dismissable fade in" style="margin-bottom: 0px;">' +
				'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
				'<strong>¡Advertencia!</strong> Tienes agendado <em>' + result.booking.service + '</em> con <em>' + result.booking.service_provider + '</em> el <em>' + formattedTime(result.booking.start) + '</em>.' +
			'</div>';
			$('#warning').append(warning);
		};
	});
}

//====== Load Info ======//
function loadDescription (serviceId, bundle) {
	var oldTop = $(document).scrollTop();
	$('#services-description').html('<tr><td class="text-center" style="color: #ccc;"><i class="fa fa-spinner fa-spin fa-lg"></i></td></tr>');
	bundle = bundle || false;
	$.getJSON('/service', {id: serviceId, bundle: bundle}, function (service) {
		current_service = service;

		$("#selectedServiceId").val(service.id);
		$("#selectedServiceId").data('bundle', bundle);

		$("#description-default").hide();

		$("#description-heading").empty();
		$("#description-heading").append(service.name);

		$('#services-description').empty();
		/*$('#services-description').append(
			'<tr>' +
				'<td class="dark-gray">Nombre:</td>' +
				'<td class="light-gray">' + service.name + '</td>' +
			'</tr>'
		);*/

		if (service.show_price && service.price && service.price > 0) {
			$('#services-description').append(
				'<tr>' +
					'<td><%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %></td>' +
					'<td class="light-gray">' + simple_currency(service.price) + '</td>' +
				'</tr>'
			);
			if(service.online_payable)
			{
				if(!service.has_sessions)
				{
					if(service.has_discount && service.discount > 0)
					{
						/*$('#services-description').append(
							'<tr>' +
								'<td class="dark-gray"><%= image_tag("promociones/tarjeta_de_credito.png", class:"promotion-hour-icon", size: "18x18") %></td>' +
								'<td class="light-gray"><b>' + simple_currency(Math.round(service.price*(100-service.discount)/100)) + ' (' + service.discount + '% de descuento)</b></td>' +
							'</tr>'
						);*/
						$('#services-description').append(
							'<tr>' +
								'<td class="dark-gray"><%= image_tag("promociones/tarjeta_de_credito.png", class:"promotion-hour-icon", size: "18x18") %></td>' +
								'<td class="light-gray"><span class="light-green"><b>' + simple_currency(Math.round(service.price*(100-service.discount)/100)) + '</b></span> (Pago online)</td>' +
							'</tr>'
						);
					}
				}
				else
				{
					/*
					* Check for treatment promo also.
					*/
					if(service.has_discount && !service.has_treatment_promo)
					{
						if(service.discount > 0)
						{
							$('#services-description').append(
								'<tr>' +
									'<td class="dark-gray"><%= image_tag("promociones/tarjeta_de_credito.png", class:"promotion-hour-icon", size: "18x18") %></td>' +
									'<td class="light-gray"><span class="light-green"><b>' + simple_currency(Math.round(service.price*(100-service.discount)/100)) + '</b></span> (Pago online)</td>' +
								'</tr>'
							);
						}
					}

				}
			}
		}
		else if (service.show_price && service.price == 0) {
			$('#services-description').append(
				'<tr>' +
					'<td class="dark-gray"><%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %></td>' +
					'<td class="light-gray">Consultar en Local</td>' +
				'</tr>'
			);
		}
		else{
			$('#services-description').append(
				'<tr>' +
					'<td class="dark-gray"><%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %></td>' +
					'<td class="light-gray">Consultar en Local</td>' +
				'</tr>'
			);
		};
		$('#services-description').append(
			'<tr>' +
				'<td class="dark-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %></td>' +
				'<td class="light-gray">' + service.duration + ' min </td>' +
			'</tr>'
		);

		$("#description-info").empty();

		$('#description-info').append("<b>Descripción:</b> ");
		var hasDescription = false;
		if(service.description) {
			$('#description-info').append(
				service.description + "<br />"
			);
			hasDescription = true;
		}
		if(service.has_sessions)
		{
			hasDescription = true;
			$("#description-info").append('Ese servicio consta de ' + service.sessions_amount + ' sesiones.');
			$(".optimizer-item").hide();
			$("#optimizerOpenBtn").attr("disabled", "disabled");
		}
		else
		{
			$(".optimizer-item").show();
			$("#optimizerOpenBtn").attr("disabled", false);
		}
		if (!hasDescription)
		{
			$("#description-info").empty();
		}
		$("#discount").empty();
		$("#normal-book").empty();

		/*if(service.online_payable){
			$("#reservar1").hide();
			$("#reservar2").show();

			if(service.has_discount && current_service.discount > 0)
			{
				$("#discount").append(
					'Precio final: ' + currency(Math.round((service.price-service.price*service.discount/100)))
				);
				$("#normal-book").append(
					'Precio final: ' + currency(service.price)
				);
			}
		}
		else
		{
			$("#reservar2").hide();
			$("#reservar1").show();
		}*/

		sizeFix();
		$(document).scrollTop(oldTop);
	});
}

var step = 1;
function scrollEvents (direction) {
	if (direction == 'next') {
		if (step == 1) {
			/*if(!$('[name="serviceRadio"]').is(':checked')) {
				myAlert.showAlert(
				  '<h3>Selecciona un Servicio</h3>' +
				  '<p>Debes elegir un servicio antes de poder continuar.</p>'
				);
				return false;
			}
			else if(current_servicecurrent_service.has_sessions && booking_buffer.length > 0)
			{
				myAlert.showAlert(
				  '<h3>Este servicio tiene sesiones</h3>' +
				  '<p>No puedes agendar un servicio con sesiones además de otros servicios.</p>'
				);
				return false;
			}*/
			if(added_services.length == 0)
			{
				swal({
					title: "Selecciona un Servicio",
					text: "Debes elegir un servicio antes de poder continuar.",
					type: "error"
				});
			}
			else {
				loadStep2();

				step = 2;
				return true;
			}
		}
		else {

			if(!selected) {
				swal({
					title: "Selecciona un Horario",
					text: "Debes elegir un horario antes de poder continuar.",
					type: "error"
				});
				return false;
			}
			else {
				loadStep3();
				step = 3;
				return true;
			}

		}
	}
	else if (direction == 'prev') {
		if (step == 3) {
			step = 2;
			//sessions_buffer = [];

			if (sessions_service)
			{
				sessions_left = actual_booking.sessions_amount;
				$("#sessions-left").html("" + actual_booking.sessions_amount);
			}
			else
			{
				sessions_left = 0;
				$("#sessions-left").html("0");
			}
			first_session = null;
			sessions_buffer = [];
			booking_buffer = [];
			actual_booking = null;
			selected = false;
			block_discount = 0;

			$("#booking-error").empty();

			$("#current-discount").empty();
			$("#current-discount-div").hide();
			$("#summary").empty();

			$("#sessions-summary-tr").empty();

      		$("#selected-hour-body").empty();


			//var active_hour = $(".hora-activo");
			//active_hour.removeClass("hora-activo");
			//active_hour.removeClass("hora-ocupado");

			blockBookingBufferHour();

			loadStep2();

		}
		else if(step == 2)
		{
			step = 1;

			sessions_buffer = [];
			booking_buffer = [];
			var active_hour = $(".hora-activo");
			active_hour.removeClass("hora-activo");
			active_hour.removeClass("hora-ocupado");

			blockBookingBufferHour();

		}
		return true;
	}
}



//====== Manage Booking ======//
var pressed3 = false;

function addSession(booking, discount, is_treatment_discount)
{

	bookSummary = bookSummaries[booking.index];
    bookDetails = bookSummary.bookings[0];

    var book_has_discount = false;
    if(discount > 0)
    {
    	book_has_discount = true;
    }

    actual_booking = {
		start: generateDate(booking.date, booking.start),
		end: generateDate(booking.date, booking.end),
		provider: bookDetails.provider,
		provider_name: bookDetails.provider_name,
		provider_lock: bookDetails.provider_lock,
		service: bookDetails.service,
		service_name: bookDetails.service_name,
		online_payable: bookDetails.online_payable,
		has_discount: book_has_discount,
		discount: discount,
		price: bookDetails.price,
		show_price: bookDetails.show_price,
		has_sessions: true,
		sessions_amount: bookDetails.sessions_amount,
		must_be_paid_online: bookDetails.must_be_paid_online,
		is_time_discount: bookDetails.has_time_discount,
		is_treatment_discount: true,
		service_promo_id: bookDetails.service_promo_id,
		bundled: bookDetails.bundled,
    bundle_id: bookDetails.bundle_id
    };



    checkUserCrossBookings();

	/*$.getJSON('/service', {id: serviceId}, function (service_response) {
		var service_online_payable = false;
		var service_has_discount = false;
		var service_discount = 0;
		var service_price = service_response.price;
		var show_price = service_response.show_price;
		if(service_response.online_payable)
		{
			service_online_payable = true;
			if(service_response.has_discount)
			{
				service_has_discount = true;
				service_discount = service_response.discount;
			}
		}

		actual_booking = {
			start: generateDate(booking.date, booking.start),
			end: generateDate(booking.date, booking.end),
			provider: booking.provider,
			provider_name: $('input[name="staffRadio"]:checked').next().html(),
			provider_lock: $('[name="staffRadio"]:checked').val() == 0 ? false : true,
			service: $('input[name=serviceRadio]:checked').val(),
			service_name: $('input[name=serviceRadio]:checked').next().html(),
			online_payable: service_online_payable,
			has_discount: service_has_discount,
			discount: service_discount,
			price: service_price,
			show_price: show_price,
			has_sessions: service_response.has_sessions,
			sessions_amount: service_response.sessions_amount
		};


		checkUserCrossBookings();

	});*/
}

function addBooking (booking, book_index, discount, is_time_discount) {

	//Add AJAX call to check if service accepts online payment

	bookSummary = bookSummaries[booking.index];
    bookDetails = bookSummary.bookings[book_index];
    var book_has_discount = false;
    if(discount > 0)
    {
    	book_has_discount = true;
    }

    actual_booking = {
		start: generateDate(booking.date, bookDetails.start.split("T")[1].split("+")[0]),
		end: generateDate(booking.date, bookDetails.end.split("T")[1].split("+")[0]),
		provider: bookDetails.provider,
		provider_name: bookDetails.provider_name,
		provider_lock: bookDetails.provider_lock,
		service: bookDetails.service,
		service_name: bookDetails.service_name,
		online_payable: bookDetails.online_payable,
		has_discount: book_has_discount,
		discount: discount,
		price: bookDetails.price,
		show_price: bookDetails.show_price,
		has_sessions: false,
		sessions_amount: bookDetails.sessions_amount,
		must_be_paid_online: bookDetails.must_be_paid_online,
		is_time_discount: bookDetails.has_time_discount,
		service_promo_id: bookDetails.service_promo_id,
		bundled: bookDetails.bundled,
    bundle_id: bookDetails.bundle_id
    };



    checkUserCrossBookings();

	/*var serviceId = $('input[name=serviceRadio]:checked').val();
	$.getJSON('/service', {id: serviceId}, function (service_response) {
		var service_online_payable = false;
		var service_has_discount = false;
		var service_discount = 0;
		var service_price = service_response.price;
		var show_price = service_response.show_price;
		if(service_response.online_payable)
		{
			service_online_payable = true;
			if(service_response.has_discount)
			{
				service_has_discount = true;
				service_discount = service_response.discount;
			}
		}
		selected = true;
		actual_booking = {
			start: generateDate(booking.date, booking.start),
			end: generateDate(booking.date, booking.end),
			provider: booking.provider,
			provider_name: $('input[name="staffRadio"]:checked').next().html(),
			provider_lock: $('[name="staffRadio"]:checked').val() == 0 ? false : true,
			service: $('input[name=serviceRadio]:checked').val(),
			service_name: $('input[name=serviceRadio]:checked').next().html(),
			online_payable: service_online_payable,
			has_discount: service_has_discount,
			discount: service_discount,
			price: service_price,
			show_price: show_price
		};
		checkUserCrossBookings();

	});*/

}


function blockService(service)
{
	if(service.has_sessions && added_services.length > 0)
	{
		swal({
			title: "No se puede agregar el servicio",
			text: "El servicio que quieres agregar tiene sesiones, no puede ser reservado junto a otros servicios.",
			type: "error"
		});
		return true;
	}
	for(i = 0; i < added_services.length; i++)
	{
		if(added_services[i].has_sessions)
		{
			swal({
        title: "No se puede agregar el servicio",
        text: "Ya existe un servicio con sesiones agregado, no puede ser reservado junto a otros servicios.",
        type: "error"
      });
			return true;
		}
	}

	return false;
}

function appendService(service, bundle_id) {
	if(blockService(service))
	{
		return;
	}

	bundle_id = bundle_id || null;

	$("#selected-services").append(
		'<div id="selected-service-' + added_services_count + '" class="selected-service" service_id="' + service.id + '" bundle_id="' + bundle_id + '" draggable="true" ondragstart="drag(event)">' +
			'<div class="selected-service-header row">' +
				'<div class="col-sm-1"><i class="fa fa-times remove-service"></i></div>' +
				'<div class="col-sm-9">' + service.name + '</div>' +
				'<div class="col-sm-1">' + (bundle_id > 0 ? '' : '<i class="fa fa-bars move-service"></i>') + '</div>' +
			'</div>' +
			'<div class="selected-service-providers" ' + ($('#providerPreference').data('provider-preference') == 2 ? 'style="display: none;"' : '' ) + '>' +
				'<div class="form-group">' +
			        '<label for="selected-service-provider" class="col-xs-3 control-label">Prestador</label>' +
			        '<div class="col-xs-9">' +
			          '<select class="form-control selected-service-provider"></select>' +
			        '</div>' +
			    '</div>' +
			'</div>' +
			'<div style="clear: both;">' +
			'</div>' +
		'</div>'
	);

	loadServiceStaff(service.id);

	added_services.push(service);
	added_services_count = added_services_count + 1;

	return;
}

function addService(service_id){


	if(service_id == "")
	{
		swal({
			title: "Selecciona un Servicio",
			text: "Selecciona un servicio antes de agregarlo.",
			type: "error"
		});
		return false;
	}

	$.getJSON('/service', {id: service_id, bundle: $("#selectedServiceId").data('bundle')}, function (service) {

		if($("#selectedServiceId").data('bundle') && service.services.length > 0) {
			$.each(service.services, function (key, service) {
        appendService(service, service_id);
      });
		}
		else {
			appendService(service);
		}

	});
}

$("body").on('click', '.remove-service', function(){

	var index = $(this).closest(".selected-service").attr("id").split("-")[2];
	var service_id = $(this).closest(".selected-service").attr("service_id");
	for(i=0; i<added_services.length; i++)
	{
		if (added_services[i].id == parseInt(service_id))
		{
			added_services.splice(i, 1);
		}
	}
	added_services_count = added_services_count-1;
	$(this).closest(".selected-service").remove();

});


function loadServiceStaff (service_id) {
  var serviceId = service_id;

  var localId = $('#selectedLocal').data('local').id;
  var providerPreference = $('#providerPreference').data('provider-preference');

  var providerSelector = $('.selected-service[service_id="' + serviceId + '"] .selected-service-provider');
  $.getJSON('/providers_services', {id: serviceId, local: localId}, function (providers) {

    providerSelector.attr('disabled', true);
    providerSelector.empty();

    if (providerPreference != 1) {
	    providerSelector.append(
	      '<option value="0">Sin Preferencia</option>'
	    );
    }
    if (providerPreference != 2) {
      $.each(providers, function (key, provider) {
        providerSelector.append(
          '<option value="' + provider.id + '">' + provider.public_name + '</option>'
        );
      });
    }

    providerSelector.attr('disabled', false);
  });
}

function loadStaffForSessions(service_id, given_provider)
{
	var serviceId = service_id;

  	var localId = $('#selectedLocal').data('local').id;
  	var providerPreference = $('#providerPreference').data('provider-preference');

  	$.getJSON('/providers_services', {id: serviceId, local: localId}, function (providers) {

	    //$(".changeStaff").empty();

	    $("#changeProviderSelect").empty();

	    if (providerPreference != 1) {
	      if (providers.length > 1) {

	      	if(given_provider == "0")
	      	{
	      		$("#changeProviderSelect").append('<option value="0" selected>Sin preferencia</option');
	      	}
	      	else
	      	{
	      		$("#changeProviderSelect").append('<option value="0">Sin preferencia</option');
	      	}

	        /*$(".changeStaff").append(
	          '<div class="radio">' +
                  '<label>' +
                    '<p><input type="radio" name="changeProvider" value="0" style="cursor: pointer;" />Sin preferencia</p>' +
                  '</label>' +
                '</div>'
	        );*/
	      }
	    }
	    if (providerPreference != 2) {
	      $.each(providers, function (key, provider) {

	      	if(given_provider == provider.id)
	      	{
	      		$("#changeProviderSelect").append('<option value="' + provider.id + '" selected>' + provider.public_name + '</option');
	      	}
	      	else
	      	{
	      		$("#changeProviderSelect").append('<option value="' + provider.id + '">' + provider.public_name + '</option');
	      	}

	        /*$(".changeStaff").append(
	          '<div class="radio">' +
                '<label>' +
                  '<p>' +
                    '<input type="radio" name="changeProvider" value="' + provider.id + '" style="cursor: pointer;" />' + provider.public_name +
                  '</p>' +
                '</label>' +
              '</div>'
	        );*/
	      });
	    }

	});

}

$('#changeProviderSelect').on('change', function(event){
	$("#loader-div").show();
	var localId = $('#selectedLocal').data('local').id;
	var selects = [];
	var start_date = $("#optimizerDateSelector").val();

	$("#selected-hour-body").empty();

	$(".selected-service").each(function() {
		var provider = $("#changeProviderSelect").val();
		var service_id = $(this).attr("service_id");
		var bundle_id = $(this).attr("bundle_id");

		selects.push({
			service: service_id,
			provider: provider,
			bundle_id: bundle_id
		});
	});

	var data;

  	if($("#pickerSelected").val()!="")
  	{
    	data = {local: localId, serviceStaff: JSON.stringify(selects), date: $("#pickerSelected").val()}
  	}
  	else
  	{
    	data = {local: localId, serviceStaff: JSON.stringify(selects)}
  	}

  	if (promoCalendar) {
    	promoCalendar.rebuild('/promotion_hours', data);
  	}
  	else {
    	promoCalendar = new PromoCalendar('/promotion_hours', data);
  	}

  	$("#loader-div").hide();

  	blockBookingBufferHour();

});

$('body').on('click', '[name="changeProvider"]', function(event){


  	$("#loader-div").show();

	var localId = $('#selectedLocal').data('local').id;
	var selects = [];
	var start_date = $("#optimizerDateSelector").val();

	$("#selected-hour-body").empty();

	$(".selected-service").each(function() {
		var provider = $('input[name="changeProvider"]:checked').val();
		var service_id = $(this).attr("service_id");
		var bundle_id = $(this).attr("bundle_id");

		selects.push({
			service: service_id,
			provider: provider,
			bundle_id: bundle_id
		});
	});



  	var data;

  	if($("#pickerSelected").val()!="")
  	{
    	data = {local: localId, serviceStaff: JSON.stringify(selects), date: $("#pickerSelected").val()}
  	}
  	else
  	{
    	data = {local: localId, serviceStaff: JSON.stringify(selects)}
  	}

  	if (promoCalendar) {
    	promoCalendar.rebuild('/promotion_hours', data);
  	}
  	else {
    	promoCalendar = new PromoCalendar('/promotion_hours', data);
  	}

  	$("#loader-div").hide();

  	blockBookingBufferHour();

});


$("#new-add-service").click(function(){
	addService($("#selectedServiceId").val());
	if ($(window).width() < 992)
	{
		var oldTop = $(document).scrollTop();
		$('#foo4').trigger('updateSizes');
		$(document).scrollTop(oldTop);
		$("html, body").animate({ scrollTop: $(document).height() }, 500);

		//$("#hour-select-div").focus();
	}
});


function generateDate(date, time) {
	var year = date.substring(0, date.indexOf('-'));
	var month = date.substring(date.indexOf('-') + 1, date.lastIndexOf('-'));
	var day = date.substring(date.lastIndexOf('-') + 1);

	time += ':00';

	return year + '-' + month + '-' + day + ' ' + time;
}

function formattedTime (timestamp) {
	var dateString = timestamp;

	var s = new Date(dateString.substring(0, 4), parseInt(dateString.substring(5, 7)) - 1, dateString.substring(8, 10), dateString.substring(11, 13), dateString.substring(14, 16), 0);

	var weekday = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"]

	var monthname = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]

	var day = weekday[s.getDay()];
	var month = monthname[s.getMonth()];

	var formattedStart = day + " " + parseInt(timestamp.substring(8,10)) + " de " + month + " a las " + timestamp.substring(11,16);

	return formattedStart;
}

function blockBookingBufferHour () {


	for (i = 0; i < booking_buffer.length; i++) {

		var start_arr = booking_buffer[i].start.split(" ");
		var start_date = start_arr[0].split("-");
		var start_time = start_arr[1].split(":");

		var end_arr = booking_buffer[i].end.split(" ");
		var end_date = end_arr[0].split("-");
		var end_time = end_arr[1].split(":");

		var bookingStart = new Date(start_date[0], start_date[1]-1, start_date[2], start_time[0], start_time[1], start_time[2], 0);
		var bookingEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end_time[0], end_time[1], end_time[2], 0);

		var date = booking_buffer[i].start.split(' ')[0];
		var hourBlocks = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora.hora-disponible');
		var promoBlocks = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora.hora-promocion');

		$.each(hourBlocks, function (key, hourBlock) {
			var start = $(hourBlock).data('start');
			var end = $(hourBlock).data('end');



			var blockStart = new Date(start_date[0], start_date[1]-1, start_date[2], start.split(":")[0], start.split(":")[1], 0, 0);
			var blockEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end.split(":")[0], end.split(":")[1], 0, 0);

			//Check for no overlap and negate it.
			if(!(bookingEnd <= blockStart || blockEnd <= bookingStart))
			{
				//$(hourBlock).removeClass('hora-disponible');
				//$(hourBlock).removeClass('hora-activo');
				$(hourBlock).addClass('hora-ocupada');
			}

		});

		$.each(promoBlocks, function (key, hourBlock) {
			var start = $(hourBlock).data('start');
			var end = $(hourBlock).data('end');



			var blockStart = new Date(start_date[0], start_date[1]-1, start_date[2], start.split(":")[0], start.split(":")[1], 0, 0);
			var blockEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end.split(":")[0], end.split(":")[1], 0, 0);

			//Check for no overlap and negate it.
			if(!(bookingEnd <= blockStart || blockEnd <= bookingStart))
			{
				//$(hourBlock).removeClass('hora-promocion');
				//$(hourBlock).removeClass('hora-activo');
				$(hourBlock).addClass('hora-ocupada');
			}

		});


		$("#foo4").trigger('updateSizes');

	}


	for(i=0; i < sessions_buffer.length; i++)
	{

		var date = sessions_buffer[i].start.split(' ')[0];
		var hourBlocks = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora.hora-disponible');
		var promoBlocks = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora.hora-promocion');

		var start_arr = sessions_buffer[i].start.split(" ");
		var start_date = start_arr[0].split("-");
		var start_time = start_arr[1].split(":");

		var end_arr = sessions_buffer[i].end.split(" ");
		var end_date = end_arr[0].split("-");
		var end_time = end_arr[1].split(":");

		var bookingStart = new Date(start_date[0], start_date[1]-1, start_date[2], start_time[0], start_time[1], start_time[2], 0);
		var bookingEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end_time[0], end_time[1], end_time[2], 0);

		$.each(hourBlocks, function (key, hourBlock) {

			var start = $(hourBlock).data('start');
			var end = $(hourBlock).data('end');

			var blockStart = new Date(start_date[0], start_date[1]-1, start_date[2], start.split(":")[0], start.split(":")[1], 0, 0);
			var blockEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end.split(":")[0], end.split(":")[1], 0, 0);

			//Check for no overlap and negate it.
			if(!(bookingEnd <= blockStart || blockEnd <= bookingStart))
			{
				//$(hourBlock).removeClass('hora-disponible');
				//$(hourBlock).removeClass('hora-activo');
				$(hourBlock).addClass('hora-ocupada');
			}

		});
		$.each(promoBlocks, function (key, hourBlock) {
			var start = $(hourBlock).data('start');
			var end = $(hourBlock).data('end');

			var blockStart = new Date(start_date[0], start_date[1]-1, start_date[2], start.split(":")[0], start.split(":")[1], 0, 0);
			var blockEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end.split(":")[0], end.split(":")[1], 0, 0);

			//Check for no overlap and negate it.
			if(!(bookingEnd <= blockStart || blockEnd <= bookingStart))
			{
				//$(hourBlock).removeClass('hora-promocion');
				//$(hourBlock).removeClass('hora-activo');
				$(hourBlock).addClass('hora-ocupada');
			}

		});
		$("#foo4").trigger('updateSizes');
	}
}

function addNewSession() {

		if(!selected) {
			swal({
        title: "Selecciona un Horario",
        text: "Debes elegir un horario antes de agregar otra sesión.",
        type: "error"
      });
		}
		else {


			if(first_session == null)
			{
				first_session = actual_booking;
			}

			sessions_buffer.push(actual_booking);

			var hourBlock = $(".hora-activo");
			//$(hourBlock).removeClass('hora-disponible');
			//$(hourBlock).removeClass('hora-activo');
			$(hourBlock).addClass('hora-ocupada');

			if(block_discount == 0)
			{
				block_discount = actual_booking.discount;
			}
			if (actual_booking.discount < block_discount)
			{
				block_discount = actual_booking.discount;
			}

			blockBookingBufferHour();

			sessions_left = sessions_left - 1;

			$("#sessions-left").empty();
			$("#sessions-left").html("" + sessions_left);
			selected = false;
			if(sessions_left < 2)
			{
				$(".btn-add-session").attr("disabled", "disabled");
			}
			else
			{
				$(".btn-add-session").attr("disabled", false);
			}

			$(hourBlock).removeClass("hora-activo");

			loadSessionsSummary();

		}

}


function loadSessionsSummary()
{
	$("#sessions-summary-tr").empty();
    $("#current-discount-div").show();
    $("#current-discount").empty();
    $("#current-discount").append(block_discount + "%");

	for(i = 0; i < sessions_buffer.length; i++)
	{
		var sessionStart = sessions_buffer[i].start.split(" ");
		var sessionStartDate = sessionStart[0].split("-")[2] + "/" + sessionStart[0].split("-")[1] + "/" + sessionStart[0].split("-")[0];
		var sessionStartTime = sessionStart[1].split(":")[0] + ":" + sessionStart[1].split(":")[1];

		var sessionEnd = sessions_buffer[i].end.split(" ");
		var sessionEndDate = sessionEnd[0].split("-")[2] + "/" + sessionEnd[0].split("-")[1] + "/" + sessionEnd[0].split("-")[0];
		var sessionEndTime = sessionEnd[1].split(":")[0] + ":" + sessionEnd[1].split(":")[1];

		$("#sessions-summary-tr").append(
			'<td class="session-summary"><span class="remove-session" index="' + i + '" style="cursor: pointer;"><div class="session-title"><i class="fa fa-times"></i></span>&nbsp;&nbsp;Sesión ' + (i+1) + '</div><div class="session-time"><i class="fa fa-calendar"></i>&nbsp;' + sessionStartDate + '<br /><i class="fa fa-clock-o"></i>&nbsp;' + sessionStartTime + " - " + sessionEndTime + '</div></td>'
		);
	}

	$(".remove-session").on('click', function(){

		var sessionIndex = $(this).attr("index");
		removeSession(sessionIndex);
	});

	var oldTop = $(document).scrollTop();
	$('#foo4').trigger('updateSizes');
	$(document).scrollTop(oldTop);
}

function removeSession(index)
{
	var sessions_aux = [];
	var removed_session;
	for(i = 0; i < sessions_buffer.length; i++)
	{
		if (i != index)
		{
			sessions_aux.push(sessions_buffer[i]);
		}
		else
		{
			removed_session = sessions_buffer[i];
		}
	}
	sessions_buffer = sessions_aux;

	var date = removed_session.start.split(' ')[0];
	var start_time = removed_session.start.split(" ")[1];
	var start_str = start_time.split(":")[0] + ":" + start_time.split(":")[1];
	var end_time = removed_session.end.split(" ")[1];
	var end_str = end_time.split(":")[0] + ":" + end_time.split(":")[1];
	var hourBlock = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora[data-start="' + start_str + '"][data-end="' + end_str + '"]');

	sessions_left = sessions_left + 1;
	$("#sessions-left").html(sessions_left);
	$(".btn-add-session").attr("disabled", false);

	$(hourBlock).removeClass('hora-ocupada');
	//$(hourBlock).addClass('hora-disponible');

	loadSessionsSummary();
}


function addNewService () {
	if(!$('[name="staffRadio"]').is(':checked')) {
		swal({
			title: "Selecciona un Staff",
			text: "Debes elegir un staff para poder reservar",
			type: "error"
		});
	}
	else {
		if(!selected) {
			swal({
        title: "Selecciona un Horario",
        text: "Debes elegir un horario antes de poder continuar.",
        type: "error"
      });
		}
		else {
			swal({
        title: "Servicio agregado",
        text: "Has agregado el servicio " + actual_booking.service_name + " con " + actual_booking.provider_name + ", el día " + formattedTime(actual_booking.start),
        type: "success"
      });
			booking_buffer.push(actual_booking);
			$('input[name=serviceRadio]:checked').prop('checked', false);
			$('#services-description').empty();
			$('#foo4').trigger('prev');
			blockBookingBufferHour();
		}
	}
}


$("#sessions-help").click(function(){
	$("#sessions-explanation").modal('show');
});

$("#staffCollapse").on("shown.bs.collapse", function(){
  $("#openStaffCollapseIcon").hide();
  $("#closeStaffCollapseIcon").show();
  $("#foo4").trigger('updateSizes');
});

$("#staffCollapse").on("hidden.bs.collapse", function(){
  $("#openStaffCollapseIcon").show();
  $("#closeStaffCollapseIcon").hide();
  $("#foo4").trigger('updateSizes');
});


$(function () {


	$(".attribute_datepicker").datepicker({
	    dateFormat: 'dd/mm/yy',
	    autoSize: true,
	    firstDay: 1,
	    changeMonth: true,
	    changeYear: true,
	    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
	        monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
	        prevText: 'Atrás',
	        nextText: 'Adelante',
	        dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
	        dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
	        dayNamesMin: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
	        today: 'Hoy',
	        clear: ''
	});

	if ($(window).width() <= 1100)
	{
		$("#new-add-service").css("font-size", "17px");
	}

	////////////////
	// IMPORTANTE //
	// Por un tema de confusión del calendario de horas del WF, se dejaron TODAS las consultas AJAX de esta página no-asíncronas.
	// Para hacer una consulta asíncrona, se debe hacer así (o por el estilo):
	// $.ajax({
	//     url: 'your url',
	//     global: false,
	//     type: 'GET',
	//     data: {},
	//     async: false,
	//     success: function() {
	//     	// código aquí
	//     }
	// });
	////////////////

	// $.ajaxSetup({
	// 	async: false
	// });

	$( document ).ajaxComplete(function() {
		var oldTop = $(document).scrollTop();
		$('#foo4').trigger('updateSizes');
		$(document).scrollTop(oldTop);
	});



	$(document).on('calendarBuilded', function (e) {

		/*
			If there are no hours for this week,
			go to next week.
		*/



		if (e.date < after_date)
		{
			if($(".bloque-hora").size() == 0)
			{
				//Check that resulting date wouldn't be greater than after_date

				var resulting_date = new Date(e.date.getFullYear(), e.date.getMonth(), e.date.getDate() + 7)

				if(resulting_date < after_date)
				{
					//$("#next").trigger("click");
					swal({
						title: "No hay horarios disponibles para la semana elegida",
						text: "Lo sentimos, no hay horarios disponibles para la semana del " + e.date.toLocaleDateString() + ".",
						type: "error"
					});
					reload_times =reload_times + 1;
					$("#next").attr("disabled", false);
				}
				else
				{
					swal({
						title: "No hay horarios disponibles",
						text: "Lo sentimos, no hay más horarios disponibles después de la semana del " + after_date.toLocaleDateString() + ".",
						type: "error"
					});
				}
			}
		}
		else
		{

			var day = new Date(after_date.getFullYear(), after_date.getMonth(), after_date.getDate());

		  	var localId = $('#selectedLocal').data('local').id;
			var selects = [];

			$(".selected-service").each(function() {
				var provider = $(this).find('.selected-service-provider').val();
				var service_id = $(this).attr("service_id");
				var bundle_id = $(this).attr("bundle_id");

				selects.push({
					service: service_id,
					provider: provider,
					bundle_id: bundle_id
				});
			});


			var data;


			day_str = after_date.getFullYear() + "-" + (parseInt(after_date.getMonth())+1) + "-" + after_date.getDate();

			data = {local: localId, serviceStaff: JSON.stringify(selects), date: day_str};

			if (promoCalendar) {
				promoCalendar.rebuild('/promotion_hours', data);
			}
			else {
				promoCalendar = new PromoCalendar('/promotion_hours', data);
			}


			swal({
		        title: "No hay horarios disponibles",
		        text: "Lo sentimos, no hay más horarios disponibles después de la semana del " + after_date.toLocaleDateString() + ".",
		        type: "error"
		    });
		}

		blockBookingBufferHour();
		var oldTop = $(document).scrollTop();
		$('#foo4').trigger('updateSizes');
		$(document).scrollTop(oldTop);
	});

});
