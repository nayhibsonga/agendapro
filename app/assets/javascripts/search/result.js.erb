//====== Result ======//

function loadSchedule(id) {
  $('#schedule-body' + id).html('<%= image_tag "ajax-loader.gif", :alt => "Loader" %>');
  $.getJSON('/schedule', {local: id}, function (schedule) {
    $('#schedule-body' + id).empty();
    $('#schedule-body' + id).append('<ul class="list-unstyled" id="list' + id + '"></ul>');
    $.each(schedule, function (day, hours) {
      if (hours.length) {
        $('#list' + id).append('<li id="' + day + '-' + id + '"><b>' + day + ' </b></li>');
        $.each(hours, function (pos, hour) {
          $('#' + day + '-' + id).append(getHour(hour.open) + '-' + getHour(hour.close) + ' ');
        })
      }
    })
  });
}

function getHour(str) {
  var index = str.indexOf('T'); //2000-1-1T08:00:00Z
  str = str.substring(index + 1, index + 6); //08:00
  return str;
}

//====== Search ======//
function changeLocation (district_id) {
  $.getJSON('/get_district', {id: district_id}, function (district) {
    $('#span-location').html(district.name + '<i class="glyphicon glyphicon-chevron-right"></i>');
    $('#district').val(district.id);

    //====== Session Storage
    if (typeof(Storage) !== "undefined") {
      sessionStorage.district = district.id;
    }
  });
}

//====== Geolocation ======//
function decode (position) {
  var geocoder = new google.maps.Geocoder();
  var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
  geocoder.geocode({'latLng': latlng}, function (results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      if (results[1]) {
        var address = results[1].formatted_address;
        var district = address.substring(0, address.indexOf(','));
        $.getJSON('/district_by_name', {name: district}, function (district) {
          $('#span-location').html(district.name + '<i class="glyphicon glyphicon-chevron-right"></i>');
          $('#district').val(district.id);

          //====== Session Storage
          if (typeof(Storage) !== "undefined") {
            sessionStorage.district = district.id;
          }
        });
      }
    }
  });
}

function locationError (error) {
  if (typeof(Storage) !== "undefined") {
    changeLocation(sessionStorage.district)
  }
  else {
    changeLocation(1);
  }
}

//====== Load ======//

$(function() {
  $('#save').on('click', function () {
    var district = $('#location_autocomplete').val();
    $.getJSON('/district_by_name', {name: district}, function (district) {
      changeLocation(district.id);
    });
    $('#modalLocation').modal('hide');

    //====== Session Storage
    if (typeof(Storage) !== "undefined") {
      sessionStorage.manual = true;
    }
  });

  $('#geo').on('click', function() {
    $('#modalLocation').modal('hide');

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(decode, locationError);
    }
    else {
      alert('Hubo un error localizandolo')
    }

    //====== Session Storage
    if (typeof(Storage) !== "undefined") {
      sessionStorage.manual = null;
    }
  });

  //Valor por defecto
  if (typeof(Storage) !== "undefined") {
    if (!sessionStorage.manual) {
      sessionStorage.district = 1;
    }
  }

  if (navigator.geolocation) {
    if (typeof(Storage) !== "undefined") {
      if (sessionStorage.manual) {
        changeLocation(sessionStorage.district);
      }
      else {
        navigator.geolocation.getCurrentPosition(decode, locationError);
      }
    }
    else {
      navigator.geolocation.getCurrentPosition(decode, locationError);
    }
  }
  else {
    if (typeof(Storage) !== "undefined") {
      changeLocation(sessionStorage.district)
    }
    else {
      changeLocation(1);
    }
  }
});