<div class="container-fluid">
  <div class="row">
    <div class="col-xs-12">
      <ul class="nav nav-pills">
        <li role="presentation" class="active"><a href="#booking" aria-controls="booking" role ="tab" data-toggle="tab">Reserva</a></li>
        <li role="presentation" style="left: 2px;"><a href="#client" aria-controls="client" role ="tab" data-toggle="tab">Datos Cliente</a></li>
      </ul>
    </div>
  </div>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-xs-12">
      <%= form_for @booking, html: {class: 'form-horizontal', style: 'margin-top: 10px; margin-bottom: 10px;'} do |f| %>
        <%= f.hidden_field :client, value: @booking.client.id %>
        <%= f.hidden_field :location, value: @booking.location.id %>
        <div class="tab-content">
          <div class="tab-pane fade in active" id="booking">
            <div class="form-group">
              <%= label_tag :date, 'Fecha', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= date_field_tag :date, @booking.start.to_date, class: 'form-control' %>
              </div>
            </div>
            <div class="form-group">
              <%= label_tag :start, 'Hora Inicio', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= time_field_tag :start, @booking.start.strftime('%H:%M'), class: 'form-control' %>
              </div>
            </div>
            <div class="form-group">
              <%= label_tag :end, 'Hora Termino', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= time_field_tag :end, @booking.end.strftime('%H:%M'), class: 'form-control' %>
              </div>
            </div>
            <div class="form-group">
              <%= f.label :service_provider, 'Prestador', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= f.collection_select :service_provider, ServiceProvider.where(location: @booking.location).where(active: true), :id, :public_name, {selected: @booking.service_provider_id}, {class: 'form-control'} %>
              </div>
            </div>
            <div class="form-group">
              <%= f.label :service, 'Servicio', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= f.collection_select :service, @booking.service_provider.services.where(:active => true).order(:name), :id, :name, {selected: @booking.service_id}, {class: 'form-control'} %>
              </div>
            </div>
            <div class="form-group">
              <%= f.label :price, 'Precio', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= f.number_field :price, class: 'form-control', min: 0 %>
              </div>
            </div>
            <div class="form-group">
              <%= f.label :status, 'Estado', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= f.collection_select :status, Status.all, :id, :name, {selected: @booking.status_id}, {class: 'form-control'} %>
              </div>
            </div>
            <% if Company.find(current_user.company_id).company_setting.staff_code %>
            <div class="form-group">
              <%= label_tag :booking_staff_code, "Código de Empleado", class: "control-label col-xs-3" %>
              <div class="col-xs-9">
                <%= text_field_tag :booking_staff_code, '',{class: "form-control", required: true} %>
              </div>
            </div>
            <% end %>
          </div>
          <div class="tab-pane fade" id="client">
            <div class="form-group">
              <%= hidden_field_tag :first_name, @booking.client.first_name %>
              <%= hidden_field_tag :last_name, @booking.client.last_name %>
              <%= label_tag :name, 'Nombre', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= text_field_tag :name, @booking.client.first_name + ' ' + @booking.client.last_name, class: 'form-control' %>
              </div>
            </div>
            <div class="form-group">
              <%= label_tag :email, 'E-mail', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= text_field_tag :email, @booking.client.email, class: 'form-control' %>
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="send_mail" name="send_mail"> Notificar cliente por e-mail
                  </label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <%= label_tag :phone, 'Teléfono', class: 'control-label col-xs-3' %>
              <div class="col-xs-9">
                <%= text_field_tag :phone, @booking.client.phone, class: 'form-control' %>
              </div>
            </div>
            <% if Company.find(current_user.company_id).company_setting.client_exclusive %>
            <div class="form-group">
              <%= label_tag :identification_number, "RUT", class: "control-label col-xs-3" %>
              <div class="col-xs-9">
                <%= text_field_tag :identification_number, class: "form-control" %>
              </div>
            </div>
            <% end %>
          </div>
          <button type="submit" class="btn btn-block btn-orange" data-id="<%= @booking.id %>" data-loading-text="Guardando <i class='fa fa-spinner fa-spin'></i>" autocomplete="off">Guardar</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% content_for :scripts do %>
<%= javascript_include_tag "split-name" %>
<script type="text/javascript">
function loadServices (provider) {
  $('#booking_service').prop('disabled', true);
  $.getJSON('/provider_services', {id: provider}, function (services) {
    $('#booking_service').empty();
    $.each(services, function (key, service) {
      $('#booking_service').append(
        '<option value="' + service.id + '">' + service.name + '</option>'
      );
    });
  }).always(function () {
    $('#booking_service').prop('disabled', false);
  });
}

function loadServiceData (service_id) {
  $.getJSON('/services/' + service_id, function (service) {
    // Price
    $('#booking_price').val(service.price);

    //End time
    var date = $('#date').val().split('-');
    var time = $('#start').val().split(':');
    var d = new Date(date[0], date[1], date[2], time[0], time[1]);
    d.setMinutes(d.getMinutes() + service.duration);
    var hour = d.getHours(), min = d.getMinutes();
    if (hour < 10) {
      hour = '0' + hour;
    };
    if (min < 10) {
      min = '0' + min;
    };
    $('#end').val(hour + ':' + min);
  });
}

function saveBooking (typeURL, booking_id) {
  var date = $('#date').val().split('-');
  var JSONData = {
    'start': date[2] + '/' + date[1] + '/' + date[0] + 'T' + $('#start').val() + ':00Z',
    'end': date[2] + '/' + date[1] + '/' + date[0] + 'T' + $('#end').val() + ':00Z',
    'service_provider_id': $('#booking_service_provider').val(),
    'service_id': $('#booking_service').val(),
    'status_id': $('#booking_status').val(),
    'client_id': $('#booking_client').val(),
    'price': $('#booking_price').val(),
    'client_first_name': $('#first_name').val(),
    'client_last_name': $('#last_name').val(),
    'client_email': $('#email').val(),
    'client_phone': $('#phone').val(),
    'send_mail': $('#send_mail').prop('checked'),
    "client_identification_number": $('#identification_number').val(),
    "staff_code": $('#booking_staff_code').val()
  }
  $.ajax({
    type: typeURL,
    url: '/bookings' + booking_id + '.json',
    data: {
      "booking": JSONData
    },
    dataType: 'json',
    success: function(booking){
      window.location.href = "/bookings/"
    },
    error: function(xhr){
      var errors = $.parseJSON(xhr.responseText).errors;
      var errores = 'Error\n';
      for (i in errors) {
        errores += '*' + errors[i] + '\n';
      }
      $('button[type="submit"]').button('reset');
      alert(errores);
    }
  });
}

$(function () {
  split_name ('#name', '#first_name', '#last_name');

  $('#booking_service_provider').change(function (event) {
    var provider_id = $(this).val();
    loadServices(provider_id);
  });

  $('#booking_service').change(function (event) {
    var service_id = $(this).val();
    loadServiceData(service_id);
  })

  $('button[type="submit"]').click(function (event) {
    event.preventDefault();
    $(this).button('loading');
    var booking = '';
    if ($(this).data('id')) {
      booking = '/' + $(this).data('id');
    };
    saveBooking('PATCH', booking);
  });
});
</script>
<% end %>
