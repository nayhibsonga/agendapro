<%= stylesheet_link_tag "search/show-promo" %>

<div class="overview-main">
  <div class="container">

    <div class="row">
      <div class="col-sm-12" style="text-align: center;">
        <%= image_tag "promociones/header_image.png", :alt => "Header", :class => "img-responsive" %>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12" style="text-align: right;">
        <%= link_to "Volver a Promociones", get_promotions_path %>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-6 col-md-6">
        <div class="promo-title">
          <%= @service.name %>
        </div>
        <div class="promo-description">
          <%= @service.description %>
        </div>
        <div class="google-maps-empresa">
          <h3><%= @service.company.name %></h3>
          <div id="map"></div>
          <div style="margin-top: 5px; margin-bottom: 5px;">
            <%= image_tag "promociones/pin.png", :alt => "Dirección", :size => "18x26" %>
            <%= if !@location.outcall then @location.address+', '+@location.district.name else "A Domicilio" end %>
          </div>
          <div>
            <%= image_tag "promociones/phone.png", :alt => "Teléfono", :size => "18x18" %>
            <%= @location.phone %>
          </div>
        </div>
      </div>
      <div class="col-xs-6 col-md-6">
        <div class="promo-price">
          <div class="col-sm-2">
          </div>
          <div class="col-sm-8" style="text-align: right;">
            <table style="width: 100%;">
              <tr>
                <td style="vertical-align: bottom; text-align: right; width: 20%;">
                  <%= image_tag("promociones/flecha.png", :class => "flecha-icon", :size => "60x120") %>
                </td>
                <td style="text-align: right; width: 80%;">
                  <span style="color: #b5b5b5; font-size: 40px;"><strike><%= number_to_currency(@service.price, unit: "$", delimiter: ".") %></strike></span><br />
                  <%= image_tag "promociones/price_doble.png", :alt => "Promoción", :size => "46x60", :class => "price-icon" %>&nbsp;<span style="color: #22c488; font-size: 65px;"><%= number_to_currency(@service.price*(100-@service.get_max_time_discount)/100, unit: "", delimiter: ".") %></span><br />
                  <span style="color: #22c488; font-size: 22px;">Desde <%= @service.get_max_time_discount %>% de descuento</span><br />
                  <span>
                    <button class="btnBook" id="btnPayBook" data-toggle="modal" data-target="#selectProviderModal">Comprar y reservar</button>
                  </span>
                </td>
              </tr>
            </table>
          </div>
          <div class="col-sm-2">
          </div>
          <div style="clear: both;"></div>
        </div>
        <div class="social-links">
          <% 
            share_text = "Promoción de " + @service.name + " con " + @service.get_max_time_discount.to_s + "% de descuento en AgendaPro"
            share_text = url_encode(share_text)
          %>
          <a href="http://twitter.com/intent/tweet?status=<%= share_text %>+<%= url_encode(request.original_url) %>" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><%= image_tag "promociones/twitter_doble.png", :size => "32x32" %></a> &nbsp;&nbsp; <a href="http://www.facebook.com/sharer.php?u=<%= url_encode(request.original_url) %>
&t=<%= share_text %>" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><%= image_tag "promociones/facebook_doble.png", :size => "32x32" %></a>
        </div>
        <div class="details-accordions">



          <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="headingOne">

                <h4 class="panel-title minus">

                  <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">

                    <%= image_tag "promociones/reloj_doble.png", :size => "30x30" %> &nbsp;&nbsp; Horarios de reserva
                    
                  </a>
                </h4>
              </div>
              <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                <div class="panel-body">
                  <%

                      promo_time = @service.company.company_setting.promo_time

                      promos = Promo.where(:service_promo_id => @service.active_service_promo_id, :location_id => @location.id)


                    %>

                    <p style="color: #949292;">Revisa los descuentos para cada horario y elige la opción que más te convenga.</p>
                      
                  <table class="discounts-table">
                    <tr>
                      <th class="first-cell">

                      </th>
                      <th>
                        Lun
                      </th>
                      <th>
                        Mar
                      </th>
                      <th>
                        Mié
                      </th>
                      <th>
                        Jue
                      </th>
                      <th>
                        Vie
                      </th>
                      <th>
                        Sáb
                      </th>
                      <th>
                        Dom
                      </th>
                    </tr>
                    <tr>

                      <td class="first-cell">
                        <span>Mañana</span><br />
                        <span class="hours"><%= promo_time.morning_start.strftime "%H:%M" %> - <%= promo_time.morning_end.strftime "%H:%M" %></span>
                      </td>

                      <%
                        for i in 1..7
                        promo = Promo.where(:service_promo_id => @service.active_service_promo_id, :location_id => @location.id, :day_id => i).first
                      %>

                        <td>
                          <% if promo.morning_discount > 0 %>
                            <% if @service.discount < promo.morning_discount || !@service.has_discount %>
                              <%= promo.morning_discount %>%
                            <% else %>
                              <%= @service.discount.round.to_s %>%
                            <% end %>
                          <% else %>
                            <% if @service.has_discount && @service.discount > 0 %>
                              <%= @service.discount.round.to_s %>%
                            <% else %>
                              -
                            <% end %>
                          <% end %>
                        </td>

                      <% end %>               

                    </tr>
                    <tr>
                      <td class="first-cell">
                        <span>Tarde</span><br />
                        <span class="hours"><%= promo_time.afternoon_start.strftime "%H:%M" %> - <%= promo_time.afternoon_end.strftime "%H:%M" %></span>
                      </td>

                      <%
                        for i in 1..7
                        promo = Promo.where(:service_promo_id => @service.active_service_promo_id, :day_id => i).first
                      %>

                        <td>
                          <% if promo.afternoon_discount > 0 %>
                            <% if @service.discount < promo.afternoon_discount || !@service.has_discount %>
                              <%= promo.afternoon_discount %>%
                            <% else %>
                              <%= @service.discount.round.to_s %>%
                            <% end %>
                          <% else %>
                            <% if @service.has_discount && @service.discount > 0 %>
                              <%= @service.discount.round.to_s %>%
                            <% else %>
                              -
                            <% end %>
                          <% end %>
                        </td>

                      <% end %>

                    </tr>
                    <tr>
                      <td class="first-cell">
                        <span>Noche</span><br />
                        <span class="hours"><%= promo_time.night_start.strftime "%H:%M" %> - <%= promo_time.night_end.strftime "%H:%M" %></span>
                      </td>
                      
                      <%
                        for i in 1..7
                        promo = Promo.where(:service_promo_id => @service.active_service_promo_id, :day_id => i).first
                      %>

                        <td>
                          <% if promo.night_discount > 0 %>
                            <% if @service.discount < promo.night_discount || !@service.has_discount %>
                              <%= promo.night_discount %>%
                            <% else %>
                              <%= @service.discount.round.to_s %>%
                            <% end %>
                          <% else %>
                            <% if @service.has_discount && @service.discount > 0 %>
                              <%= @service.discount.round.to_s %>%
                            <% else %>
                              -
                            <% end %>
                          <% end %>
                        </td>

                      <% end %>

                    </tr>
                  </table>

                  <% if @service.has_discount %>
                    <br />
                    <p style="color: #949292;">Además, este servicio tiene un descuento por defecto por pago en línea de un <%= @service.discount.round.to_s %>% para reservas en cualquier horario.</p>
                  <% end %>

                </div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="headingTwo">
                <h4 class="panel-title minus">
                  <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    <%= image_tag "promociones/tarjeta_doble.png", :size => "30x30" %> &nbsp;&nbsp;Máximo de compras
                  </a>
                </h4>
              </div>
              <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                <div class="panel-body">
                  <p style="color: #949292;">Quedan <%= @service.active_promo_left_bookings %> reservas disponibles para esta promoción.</p>
                  <% if @service.active_promo_left_bookings <= 20 %>
                    <p style="color: #949292;">
                      ¡Apúrate y reserva antes que se acaben!
                    </p>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="headingThree">
                <h4 class="panel-title minus">
                  <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    <%= image_tag "promociones/agendapro_doble.png", :size => "30x30" %> &nbsp;&nbsp;Políticas de la empresa
                  </a>
                </h4>
              </div>
              <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                <div class="panel-body">
                  <h3 style="color: #949292;">Modificación:</h3>
                  <% if !@location.company.company_setting.online_cancelation_policy.modifiable %>
                    <p style="color: #949292;">La empresa no permite modificar reservas pagadas en línea.</p>
                  <% else %>
                    <p style="color: #949292;">La reserva se puede modificar:</p>
                    <p style="color: #949292;">- Hasta <%= @location.company.company_setting.online_cancelation_policy.min_hours.to_s %> horas antes del servicio contratado.<br />
                    - Hasta <%= @location.company.company_setting.online_cancelation_policy.modification_max.to_s %> <%= TimeUnit.find(@location.company.company_setting.online_cancelation_policy.modification_unit).unit.to_s.downcase %> desde la fecha en que se efectuó el pago.</p>
                    <p style="color: #949292;">
                      Si no cumple con alguna de las dos restricciones, no podrá modificar su reserva.
                      <br />
                      Además, la empresa permite modificar la reserva un máximo de <%= @location.company.company_setting.max_changes.to_s %> veces.
                    </p>
                  <% end %>

                  <h3 style="color: #949292;">Cancelación:</h3>
                  <% if !@location.company.company_setting.online_cancelation_policy.cancelable %>
                    <p style="color: #949292;">La empresa no permite cancelar reservas pagadas en línea.</p>
                  <% else %>
                    <p style="color: #949292;">La reserva se puede cancelar:</p>
                    <p style="color: #949292;">- Hasta <%= @location.company.company_setting.online_cancelation_policy.min_hours.to_s %> horas antes del servicio contratado.<br />
                    - Hasta <%= @location.company.company_setting.online_cancelation_policy.cancel_max.to_s %> <%= TimeUnit.find(@location.company.company_setting.online_cancelation_policy.cancel_unit).unit.to_s.downcase %> desde la fecha en que se efectuó el pago.</p>
                    <p style="color: #949292;">Si no cumple con alguna de las dos restricciones, no podrá cancelar su reserva.</p>
                    <br />
                    <p style="color: #949292;">
                      Si cancela su reserva, se le devolverá un 90% del monto cancelado debido a los costos de transacción.
                    </p>
                  <% end %>
                </div>
              </div>
            </div>
          </div>



        </div>
      </div>
    </div>

    <% if @relatedPromos.count > 0 %>
      <div class="row">
        <div class="col-sm-12">
          <div class="promo-title">
            Ofertas relacionadas
          </div>

          <% i = 1 %>
          <div class="row">
          <% @relatedPromos.each do |promo_detail| %>
            <div class="col-md-4">
              <%= render :partial => 'searchs/service_panel', :locals => { :service => promo_detail[0], :location => promo_detail[1], :i => i} %>
            </div>
            <% if i%3 == 0 %>
              </div>
              <div class="row">
            <% end %>
            <% i = i + 1 %>
          <% end %>
          </div>

        </div>
      </div>
    <% end %>

  </div>
</div>

<div class="modal" id="selectProviderModal" tabindex="-1" role="basic" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
          <button type="button" class="close closeBookModal" data-dismiss="modal">&times;</button>
          <h3 class="modal-title" id="optimizerTitle" style="line-height: 1.1;">Reservar</h3>
      </div>
      <div class="modal-body">

        <div id="optimizerFirst">
          <div id="pickerSelectDate">
            <div class="row">
              <div class="col-xs-3" style="text-align: right; font-weight: bold;">
                Inicio
              </div>
              <div class="col-xs-9">
                <input id="initialPickerDate" value="<%= I18n.l(DateTime.now.to_date) %>" hidden />
                <span id="pickerSelected" style="color: #949292;"><%= I18n.l(DateTime.now.to_date) %></span>&nbsp;&nbsp;
                <span class="optimizer-date-span" id="openDatepicker" style="float: right;">
                  Seleccionar nuevo inicio&nbsp;<i class="fa fa-calendar-o"></i>
                  <input type="text" class="form-control" name="optimizerDateSelector" id="optimizerDateSelector" class="datepicker" />
                  <input type="hidden" name="selectedLocal" id="selectedLocal" value="<%= @location.id %>" />
                  <input type="hidden" name="selectedService" id="selectedService" value="<%= @service.id %>" />
                </span>
              </div>
            </div>
          </div>
          <form class="form-horizontal" id="serviceOptimizer">
              <div class="form-group">
                <label for="providerOptimizerSelector" class="col-xs-3 control-label">Prestador</label>
                <div class="col-xs-9">
                  <select class="form-control" name="providerOptimizerSelector" id="providerOptimizerSelector">
                    <% if @service.service_providers.where(:active => true, online_booking: true).where('location_id = ?', @location.id).count > 1 %>
                        <% if @location.company.company_setting.provider_preference != 0 %>
                            <option value="0">Sin Preferencia</option>
                        <% end %>
                    <% end %>
                    <% @service.service_providers.where(:active => true, online_booking: true).where('location_id = ?', @location.id).order(order: :asc).each do |provider| %>

                      <option value="<%= provider.id %>">
                          <%= provider.public_name %>
                      </option>

                    <% end %>
                  </select>
                </div>
              </div>
              <input type="hidden" name="service" value="<%= @service.id %>" />
          </form>
          <div id="selectHour"></div>
          <%= form_tag '/optimizer_data', method: 'post', role: 'form', class: 'hidden', id: 'userData' do %>
            <input type="hidden" id="local" name="local" value="<%= @location.id %>">
          <% end %>
        </div>


        <div id="calendar-div" hidden>
          <div class="row staff">
            <div class="col-md-9" id="staff-calendar">
              <div class="panel panel-info <%= 'full-margin' if @location.company.company_setting.provider_preference == 2 %>">
                <div class="calendar-head">
                  <div class="panel-title">
                    <div class="row">
                      <div class="col-xs-1">
                        <button type="button" class="btn btn-default" id="prev"><i class="fa fa-chevron-left"></i></button>
                      </div>
                      <div class="col-xs-8">
                        <span class="tittle"></span>
                      </div>
                      <div class="col-xs-2">
                        <span class="date-span">
                          Ir a fecha&nbsp;<i class="fa fa-calendar-o"></i>
                          <input type="text" id="datepicker" name="date" />
                        </span>
                      </div>
                      <div class="col-xs-1">
                        <button type="button" class="btn btn-default pull-right" id="next"><i class="fa fa-chevron-right"></i></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="days-row">
                </div>
                <div class="panel-body">
                  <div class="horario">
                    <!-- <%= image_tag "ajax-loader.gif", :alt => "Loader", :id => "calendar-loader" %> -->
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">

              <div class="changeStaffPanel" style="margin-bottom: 10px;">
                <button class="btn" type="button" data-toggle="collapse" data-target="#staffCollapse" aria-expanded="false" aria-controls="staffCollapse">
                  Cambiar prestador
                </button>
                <div class="collapse" id="staffCollapse">
                  <div class="changeStaff" style="margin-top: 5px;">

                    <% if @location.company.company_setting.provider_preference != 0 %>
                      <div class="radio">
                        <label>
                          <p><input type="radio" name="changeProvider" value="0" style="cursor: pointer;" />Sin preferencia</p>
                        </label>
                      </div>
                    <% end %>
                    <% @service.service_providers.where(:active => true, online_booking: true).where('location_id = ?', @location.id).order(order: :asc).each do |provider| %>
                        <div class="radio">
                          <label>
                            <p>
                              <input type="radio" name="changeProvider" value="<%= provider.id %>" style="cursor: pointer;" />
                            <%= provider.public_name %>
                            </p>
                          </label>
                        </div>

                     <% end %>
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div id="selected-hour-heading">
                  Detalle Reserva
                </div>
                <div id="selected-hour-body">

                </div>
                
              </div>
            </div>
          </div>
          <% if @service.has_sessions %>
            <div class="row sessions-bar">
              <div class="col-xs-12 col-md-2">
                <a class="btn btn-large btn-green btn-add-session" style="padding: 5px 12px; margin-right: 10px; font-size: 20px;" onclick="addNewSession()"><i class="fa fa-plus"></i> Agregar Sesión</a>
              </div>
              <div class="col-md-7 col-xs-12">
                <div id="sessions-summary">
                  <div id="sessions-summary-title">
                    Detalle de reserva&nbsp;&nbsp;
                    <span id="sessions-summary-subtitle">
                      Puedes agendar hasta <span id="sessions-left"><%= @service.sessions_amount %></span> sesiones más. &nbsp;&nbsp; <span id="sessions-help"><i class="fa fa-question-circle"></i>
                    </span>
                  </div>
                  <div id="sessions-summary-body">
                    <table>
                      <tr id="sessions-summary-tr">
                      <tr>
                    </table>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-xs-12" id="current-discount-div" style="bottom: 0px !important; color: #949292;" hidden>
                  Descuento a aplicar: <span id="current-discount" style="color: #22c488;">0%</span>
                  <div><label id="booking-error" style="color: #fd633f;"></label></div>
              </div>
            </div>
          <% end %>
        </div>


        <div id="payment-form-div" hidden>
          <div class="row" style="margin-left: 0px !important;">
            <div class="col-md-6">
              <div class="subtitulos-workflow">Ingresa tus datos &nbsp;<i class="fa fa-file-text-o gray-icon"></i></div>
            </div>
          </div>
          <%= form_tag("book", method: "post", role: "form", class: "form-horizontal", id: "bookingForm" ) do %>
            <div class="row" style="margin-left: 0px !important;">
              

                <div class="col-md-6">
                  <!-- INICIO FORM -->
                  <div id="form-datos">
                    <div class="datos-heading">
                      Datos de la reserva
                    </div>
                    <div class="panel-body">
                      <input type="hidden" name="bookings" class="bookings" value="" />
                      <input type="hidden" name="location" id="location" value="<%= @location.id %>" />
                      <input type="hidden" name="origin" id="origin" value="true" />
                      <input type="hidden" name="payment" id="payment" value="1" />
                      <input type="hidden" name="is_promo" id="is_promo" value="1" />
                      <% if @service.has_sessions %>
                        <input type="hidden" name="has_sessions" id ="has_sessions" value="1" />
                      <% else %>
                        <input type="hidden" name="has_sessions" id ="has_sessions" value="0" />
                      <% end %>

                      <% if user_signed_in? %>
                      <div id="user-data">
                        <%= hidden_field_tag :user_id, current_user.id %>
                        <%= hidden_field_tag :firstName, current_user.first_name %>
                        <%= hidden_field_tag :lastName, current_user.last_name %>
                        <div class="row">
                          <div class="col-md-12 dark-gray">
                            Nombre
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group has-feedback">
                              <input type="text" id="full_name" name="user[full_name]" class="form-control light-gray" placeholder="Nombre completo (requerido)" value="<%= current_user.first_name %> <%= current_user.last_name %>">
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6 dark-gray">
                            Email
                          </div>
                          <div class="col-md-6 dark-gray">
                            Teléfono
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group has-feedback">
                              <%= email_field_tag(:email, current_user.email, :class => "form-control light-gray", :placeholder => "ejemplo@dominio.com (requerido)", :required => true) %>
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group has-feedback">
                              <%= telephone_field_tag(:phone, current_user.phone, :class => "form-control light-gray", :placeholder => "1122334455 (requerido)", :required => true) %>
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <% else %>
                        <%= hidden_field_tag :firstName %>
                        <%= hidden_field_tag :lastName %>
                        <div class="row">
                          <div class="col-md-12 dark-gray">
                            Nombre
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group has-feedback">
                              <input type="text" id="full_name" name="user[full_name]" class="form-control light-gray" placeholder="Nombre completo (requerido)">
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm-6 dark-gray">
                            Email
                          </div>
                          <div class="col-sm-6 dark-gray">
                            Teléfono
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm-6">
                            <div class="form-group has-feedback">
                              <%= email_field_tag(:email, nil, :class => "form-control light-gray", :placeholder => "ejemplo@dominio.com (requerido)", :required => true) %>
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                          <div class="col-sm-6">
                            <div class="form-group has-feedback">
                              <%= telephone_field_tag(:phone, nil, :class => "form-control light-gray", :placeholder => "1122334455 (requerido)", :required => true) %>
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                        </div>
                      <% end %>
                      <% if @location.company.company_setting.client_exclusive %>
                        <div class="row">
                          <div class="col-md-12 dark-gray">
                            RUT
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group has-feedback">
                              <%= text_field_tag(:identification_number, nil, :class => "form-control light-gray", :placeholder => "Escriba su RUT, debe estar autorizado como cliente" ) %>
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                        </div>
                      <% end %>
                      <% if @location.company.company_setting.deal_activate %>
                        <div class="row">
                          <div class="col-md-12 dark-gray">
                            <%= !@location.company.company_setting.deal_name.blank? ? @location.company.company_setting.deal_name : "Convenio" %>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group has-feedback">
                              <%= text_field_tag(:deal_code, nil, :class => "form-control light-gray" ) %>
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                        </div>
                      <% end %>
                      <% if @service.outcall %>
                      <div id="outcallAddress" class="row form-group has-feedback">
                        <div class="row">
                          <div class="col-md-12 dark-gray">
                            Dirección
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group has-feedback">
                              <%= text_field_tag(:address, nil, :class => "form-control light-gray", :placeholder => "Escribe la dirección donde se debe realizar el servicio" ) %>
                              <span class="help-block"></span>
                              <span class="form-control-feedback"></span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <% end %>
                      <% if @location.company.company_setting.activate_notes %>
                      <div class="row">
                        <div class="col-md-12 dark-gray">
                          Comentario
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <div class="form-group">
                            <%= text_area_tag(:comment, nil, :class => "form-control light-gray", :placeholder => "Agrega algún comentario a tu reserva en caso de ser necesario", :rows => 4) %>
                          </div>
                        </div>
                      </div>
                      <% end %>
                      <% if !user_signed_in? %>
                      <div class="row">
                        <div class="col-md-12">
                          <div class="checkbox">
                            <label>
                              <%= check_box_tag :mailing_option, true, class: 'checkbox' %> Quiero recibir promociones a mi email
                            </label>
                          </div>
                        </div>
                      </div>
                      <% end %>

                      <!-- MEDIO DE PAGO -->

                        <div class="row">
                          <div class="col-sm-12 dark-gray" id="payment-way">
                              <div class="form-group has-feedback">
                                <span id="payment_title" name="payment_title">Elige el medio de pago</span>
                                <span class="help-block"></span>
                                <span class="form-control-feedback"></span>
                              </div>
                          </div>
                        </div>
                        <div class="row">

                            <div class="col-md-6">
                              <input type="radio" name="mp" value="04" class="mp_radio" id="mp_radio_04" />
                              <label for="mp_radio_04"><image src="https://www.puntopagos.com/content/mp4.gif" alt="Banco Chile" class="mp_link" mp = "04" /></label>
                            </div>
                            <div class="col-md-6">
                              <input type="radio" name="mp" value="10" class="mp_radio" id="mp_radio_10" />
                              <label for="mp_radio_10"><image src="https://www.puntopagos.com/content/mp10.gif" alt="Banco Ripley" class="mp_link" mp = "10" /></label>
                            </div>

                        </div>
                        <div class="row">

                          <div class="col-md-6">
                            <input type="radio" name="mp" value="07" class="mp_radio" id="mp_radio_07" />
                            <label for="mp_radio_07"><image src="https://www.puntopagos.com/content/mp7.gif" alt="Banco Estado" class="mp_link" mp = "07" /></label>
                          </div>
                          <div class="col-md-6">
                            <input type="radio" name="mp" value="03" class="mp_radio" id="mp_radio_03" />
                            <label for="mp_radio_03"><image src="https://www.puntopagos.com/content/mp3.gif" alt="Webpay Transbank" class="mp_link" mp = "03" /></label>
                          </div>

                        </div>

                      <!-- FIN MEDIO DE PAGO -->

                    </div>

                  </div>
                  <!-- FIN FORM -->

                </div>
                <div class="col-md-6">
                  <div id="resumen-reserva">
                    <div class="resumen-heading">
                      Resumen de tu Reserva
                    </div>
                    <div class="panel-body">
                      <table class="table">
                        <tbody id="summary">
                        </tbody>
                      </table>
                    </div>
                  </div>
                  
                </div>
            
          </div>

        <% end %>


        <div class="row" id="loader-div" hidden>
          <p style="text-align: center; margin-top: 40px;">
            <%= image_tag "ajax-loader.gif", :alt => "Loader" %>
          </p>
        </div>
      </div>



      <div class="modal-footer">          
          <a type="button" class="btn open-calendar-btn" id="openCalendarBtn"><i class="fa fa-calendar-o"></i>&nbsp;Ver calendario</a>
          <a type="button" class="btn promo-back-btn" id="backBtn1" style="display: none;" disabled="true">Atrás</a>
          <a type="button" class="btn promo-back-btn" id="backBtn2" style="display: none;" disabled="true">Atrás</a>
          <a type="button" class="btn hour-selected-btn" id="openPayFormBtn" style="display: none;" disabled="true">Siguiente</a>
          <a type="button" class="btn hour-selected-btn" id="payBtn" style="display: none;" disabled="true">Reservar y Pagar</a>
          <!--<button type="button" class="btn session-btn" id="openOptimizerBtn"><i class="fa fa-calendar-o"></i>&nbsp;Sugerir hora</button>-->
          <a href="#" class="btn btn-white" class="closeBookModal" data-dismiss="modal">Cerrar</a>
      </div>
    </div>
  </div>
</div>

<input type="hidden" id="locationId" value="<%= @location.id %>" />
<input type="hidden" id="serviceId" value="<%= @service.id %>" />
<input type="hidden" id="locationAddress" value="<%= @location.address %>" />
<input type="hidden" id="locationDistrict" value="<%= @location.district.name %>" />

<% if user_signed_in? %>
  <input type="hidden" id="user_id" value="<%= current_user.id %>" />
<% end %>


<%= content_tag "div", id: "clientExclusive", data: {client_exclusive: @location.company.company_setting.client_exclusive} do %>
<% end %>
<%= content_tag "div", id: "providerPreference", data: {provider_preference: @location.company.company_setting.provider_preference } do %>
<% end %>
<%= content_tag "div", id: "dealCode", data: {deal_identification_number: @location.company.company_setting.deal_identification_number, deal_required: @location.company.company_setting.deal_required } do %>
<% end %>

<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "calendar" %>
<% end %>

<% content_for :scripts do %>
  
  <%= javascript_include_tag 'workflow/promotions-calendar' %>
  <%= javascript_include_tag 'validations/home/promo' %>
    
  <script type="text/javascript">

    
    var currMarker;

    $(document).ready(function(){
      $("#optimizerDateSelector").datepicker({
          autoSize: true,
          firstDay: 1,
          changeMonth: true,
          changeYear: true,
          monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
          monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
          prevText: 'Atrás',
          nextText: 'Adelante',
          dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
          dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
          dayNamesMin: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
          today: 'Hoy',
          clear: '',
          dateFormat: 'yy-mm-dd',
          onSelect: function(newDate){
              $("#pickerSelected").empty();
              var prettyDate = newDate.split("-")[2] + "/" + newDate.split("-")[1] + "/" + newDate.split("-")[0];
              $("#pickerSelected").append(prettyDate);
          }
      });

      $("#openDatepicker").click(function(){
          $("#optimizerDateSelector").datepicker("show");
      });
    });

    
    //====== Google Map ======//
    function initializeMap(lat, lng, mapDiv) {
        var properties = {
            center: new google.maps.LatLng(lat, lng),
            zoom:   15,
            panControl: false,
            zoomControl: true,
            zoomControlOptions: {
                style: google.maps.ZoomControlStyle.SMALL
            },
            mapTypeControl: true,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
            },
            scaleControl: false,
            streetViewControl: false,
            overviewMapControl: false,
            mapTypeId:  google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById(mapDiv), properties);
    }

    function setMarker(latlng, local) {

      if(currMarker!=null)
      {
        currMarker.setMap(null);
      }

      var image = '<%= asset_path("pin_googlemap.png") %>';

      var marker = new google.maps.Marker({
                    position: latlng,
                    icon: image
                    /*new google.maps.MarkerImage(
                "http://chart.googleapis.com/chart?chst=d_map_pin_letter_withshadow&chld=|01e19d|FFFFFF",
                null, null, new google.maps.Point(0, 42))*/
                  });
      currMarker = marker;
      marker.setMap(map);

      var infowindow = new google.maps.InfoWindow({
          content: local
        });
      google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map,marker);
      });
    }

    function localMap(id) {
      $.getJSON('/local', {id: id}, function (local) {
        var latLng = new google.maps.LatLng(local.latitude, local.longitude);
        map.setCenter(latLng);
        setMarker(latLng, local.name);
      });
    }


    $(document).ready(function(){
      var map;
      initializeMap(-33.413084, -70.592161, 'map');
      
      if ($("#locationId").val() != "") {
        var localId = $("#locationId").val();

        //loadSchedule(localId);
        localMap(localId);
      }
    });

    $(".promo-service-box").click(function(){
      console.log($(this).attr("service_id"));
      $('.show-promo-link[service_id="' + $(this).attr("service_id") + '"][location_id="' + $(this).attr("location_id") + '"]')[0].click();
    });



    var promoCalendar;

    function simple_currency(price)
    {
      var amount = price.toString();
      //console.log(amount);
      //console.log(amount.length);
      var j = 0;
      var stack = new Array();
      for(i = amount.length-1; i>=0; i--)
      {
        j = j+1;
        stack.push(amount[i]);
        if(j == 3 && i>0)
        {
          stack.push('.');
          j = 0;
        }
      }
      var formatted_amount = "$";
      for(i = stack.length-1; i >=0 ; i--)
      {
        formatted_amount = formatted_amount + stack[i];
      }

      return formatted_amount;
    }


    /*function checkUserCrossBookings () {
      $(".alert").alert('close');
      var user = $('#user_id').val();
      var booking_start = actual_booking.start;
      var booking_end = actual_booking.end;
      $.getJSON('/check_user_cross_bookings', {user_id: user, booking_start: booking_start, booking_end: booking_end}, function (result) {
        if (result.crossover) {
          $('#warning').empty();
          var warning = '<div class="alert alert-warning alert-dismissable fade in" style="margin-bottom: 0px;">' +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '<strong>¡Advertencia!</strong> Tienes agendado <em>' + result.booking.service + '</em> con <em>' + result.booking.service_provider + '</em> el <em>' + formattedTime(result.booking.start) + '</em>.' +
          '</div>';
          $('#warning').append(warning);
        };
      });
    }*/

    $('body').on('hidden.bs.modal', '#selectProviderModal', function () {

      resetModal();
    });

    var first_session;
    var sessions_buffer = [];
    var selected = false;
    var sessions_left = parseInt("<%= @service.sessions_amount %>");
    var actual_booking;
    var booking_buffer = [];
    var block_discount = 0;

    function addNewSession() {

        if(!selected) {
          myAlert.showAlert(
            '<h3>Selecciona un Horario</h3>' +
            '<p>Debes elegir un horario antes de agregar otra sesión.</p>'
          );
        }
        else {

          if(first_session == null)
          {
            first_session = actual_booking;
          }

          sessions_buffer.push(actual_booking);

          var hourBlock = $(".hora-activo");
          $(hourBlock).removeClass('hora-disponible');
          $(hourBlock).removeClass('hora-activo');
          $(hourBlock).addClass('hora-ocupada');


          if(block_discount == 0)
          {
            block_discount = actual_booking.discount;
          }
          if (actual_booking.discount < block_discount)
          {
            block_discount = actual_booking.discount;
          }

          blockDiscounts();

          blockBookingBufferHour();

          sessions_left = sessions_left - 1;

          $("#sessions-left").empty();
          $("#sessions-left").text("" + sessions_left);
          selected = false;
          if(sessions_left < 2)
          {
            $(".btn-add-session").attr("disabled", "disabled");
          }
          else
          {
            $(".btn-add-session").attr("disabled", false);
          }
          
          loadSessionsSummary();

        }

        selected = false;
      
    }



    function loadSessionsSummary()
    {
      $("#sessions-summary-tr").empty();
      $("#current-discount-div").show();
      $("#current-discount").empty();
      $("#current-discount").append(block_discount + "%");

      for(i = 0; i < sessions_buffer.length; i++)
      {
        var sessionStart = sessions_buffer[i].start.split(" ");
        var sessionStartDate = sessionStart[0].split("-")[2] + "/" + sessionStart[0].split("-")[1] + "/" + sessionStart[0].split("-")[0];
        var sessionStartTime = sessionStart[1].split(":")[0] + ":" + sessionStart[1].split(":")[1];

        var sessionEnd = sessions_buffer[i].end.split(" ");
        var sessionEndDate = sessionEnd[0].split("-")[2] + "/" + sessionEnd[0].split("-")[1] + "/" + sessionEnd[0].split("-")[0];
        var sessionEndTime = sessionEnd[1].split(":")[0] + ":" + sessionEnd[1].split(":")[1];

        $("#sessions-summary-tr").append(
          '<td class="session-summary"><span class="remove-session" index="' + i + '" style="cursor: pointer;"><div class="session-title"><i class="fa fa-times"></i></span>&nbsp;&nbsp;Sesión ' + (i+1) + '</div><div class="session-time"><i class="fa fa-calendar"></i>&nbsp;' + sessionStartDate + '<br /><i class="fa fa-clock-o"></i>&nbsp;' + sessionStartTime + " - " + sessionEndTime + '</div></td>'
        );
      }

      $(".remove-session").on('click', function(){
        console.log("Remove");
        var sessionIndex = $(this).attr("index");
        removeSession(sessionIndex);
      });

      var oldTop = $(document).scrollTop();
      $('#foo4').trigger('updateSizes');
      $(document).scrollTop(oldTop);
    }

    function removeSession(index)
    {
      var sessions_aux = [];
      var removed_session;
      for(i = 0; i < sessions_buffer.length; i++)
      {
        if (i != index)
        {
          sessions_aux.push(sessions_buffer[i]);
        }
        else
        {
          removed_session = sessions_buffer[i];
        }
      }
      sessions_buffer = sessions_aux;
      
      var date = removed_session.start.split(' ')[0];
      var start_time = removed_session.start.split(" ")[1];
      var start_str = start_time.split(":")[0] + ":" + start_time.split(":")[1];
      var end_time = removed_session.end.split(" ")[1];
      var end_str = end_time.split(":")[0] + ":" + end_time.split(":")[1];
      var hourBlock = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora[data-start="' + start_str + '"][data-end="' + end_str + '"]');

      sessions_left = sessions_left + 1;
      $("#sessions-left").html(sessions_left);
      $(".btn-add-session").attr("disabled", false);

      $(hourBlock).removeClass('hora-ocupada');
      $(hourBlock).addClass('hora-disponible');

      if(sessions_buffer.length == 0)
      {
        block_discount = 0;
      }
      else
      {
        new_min = 0;
        for(i = 0; i < sessions_buffer.length; i++)
        {
          if(new_min == 0)
          {
            new_min = sessions_buffer[i].discount;
          }
          else
          {
            if(sessions_buffer[i].discount < new_min)
            {
              new_min = sessions_buffer[i].discount;
            }
          }
        }
        block_discount = new_min;
      }

      blockDiscounts();

      loadSessionsSummary();

    }



    function loadCalendar() {

      var localId = $("#locationId").val();
      
      var start_date = $("#optimizerDateSelector").val();

      $("#optimizerFirst").hide();
      $("#loader-div").show();
      $("#openCalendarBtn").hide();
      $("#backBtn2").attr("disabled", true);
      $("#backBtn2").hide();
      $("#backBtn1").attr("disabled", false);
      $("#backBtn1").show();

      var selects = [];

      selects.push({
        service: $("#serviceId").val(),
        provider: $("#providerOptimizerSelector").val()
      });

      var data;

      if($("#pickerSelected").val()!="")
      {
        data = {local: localId, serviceStaff: JSON.stringify(selects), date: $("#pickerSelected").val(), mandatory_discount: true}
      }
      else
      {
        data = {local: localId, serviceStaff: JSON.stringify(selects), mandatory_discount: true}
      }

      if (promoCalendar) {
        promoCalendar.rebuild('/promotion_hours', data);
      }
      else {
        promoCalendar = new PromoCalendar('/promotion_hours', data);
      }

      $(document).on('hourClick', function (e) {
        
        bookSummary = bookSummaries[e.index];
        selected = true;

        $("#selected-hour-body").empty();

        var book_discount = 0;

        for(k=0; k<bookSummary.bookings.length; k++)
        {
          bookDetails = bookSummary.bookings[k];
          console.log(bookDetails);
          bookDetailsStart = bookDetails.start.split("T")[1].split(":")[0] + ':' + bookDetails.start.split("T")[1].split(":")[1];
          bookDetailsEnd = bookDetails.end.split("T")[1].split(":")[0] + ':' + bookDetails.end.split("T")[1].split(":")[1];

          bookDetailsDiscountPrice = Math.round(bookDetails.price);

          
          if(bookDetails.has_discount && bookDetails.has_time_discount)
          {
            if(bookDetails.discount > bookDetails.time_discount)
            {
              book_discount = bookDetails.discount;
              bookDetailsDiscountPrice = Math.round(bookDetails.price * (100 - bookDetails.discount) / 100);
              $("#selected-hour-body").append(
                '<b>' + bookDetails.service_name + '</b><br />' +
                '<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
                '<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %>  <strike>' + simple_currency(bookDetails.price) + '</strike>  <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.discount + ' % off) <br /></div>'
              );
            }
            else
            {
              book_discount = bookDetails.time_discount;
              bookDetailsDiscountPrice = Math.round(bookDetails.price * (100 - bookDetails.time_discount) / 100);
              $("#selected-hour-body").append(
                '<b>' + bookDetails.service_name + '</b><br />' +
                '<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %>' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
                '<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike>  <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span>' + ' (' + bookDetails.time_discount + ' % off) <br /></div>'
              );
            }
          }
          else if(bookDetails.has_discount && !bookDetails.has_time_discount)
          {
            book_discount = bookDetails.discount;
            bookDetailsDiscountPrice = Math.round(bookDetails.price * (100 - bookDetails.discount) / 100);
            $("#selected-hour-body").append(
                '<b>' + bookDetails.service_name + '</b><br />' +
                '<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
                '<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.discount + ' % off) <br /></div>'
              );
          }
          else if(!bookDetails.has_discount && bookDetails.has_time_discount)
          {
            book_discount = bookDetails.time_discount
            bookDetailsDiscountPrice = Math.round(bookDetails.price * (100 - bookDetails.time_discount) / 100);
            $("#selected-hour-body").append(
                '<b>' + bookDetails.service_name + '</b><br />' +
                '<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
                '<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> <strike>' + simple_currency(bookDetails.price) + '</strike> <span class="light-green"><b>' + simple_currency(bookDetailsDiscountPrice) + '</b></span> (' + bookDetails.time_discount + ' % off) <br /></div>'
              );
          }
          else
          {
            book_discount = 0;
            $("#selected-hour-body").append(
              '<b>' + bookDetails.service_name + '</b><br />' +
              '<div class="light-gray"><%= image_tag("promociones/reloj.png", class:"promotion-hour-icon", size: "18x18") %> ' + bookDetailsStart + ' - ' + bookDetailsEnd + '<br />' +
              '<%= image_tag("promociones/etiqueta.png", class:"promotion-hour-icon", size: "18x18") %> ' + simple_currency(bookDetails.price) + '<br /></div>'
            );
          }
          //blockDiscounts(block_discount);

        }

        if($("#has_sessions").val() == "1")
        {
          addSession(e, book_discount);
        }
        else
        {
          addBooking(e, book_discount);
        }

        $("#openPayFormBtn").attr("disabled", false);

      });
  
      $("#selectProviderModal .modal-dialog").addClass("calendar-modal");

      $("#openPayFormBtn").show();
      $("#calendar-div").show();
      $("#payment-form-div").hide();
      $("#loader-div").hide();

      blockDiscounts();

    }

    function blockDiscounts()
    {

      /*if (block_discount == 0)
      {
        var hourBlocks = $('.columna-dia').children('.bloque-hora');
        $.each(hourBlocks, function (key, hourBlock) {

            $(hourBlock).removeClass('hora-ocupada');
            $(hourBlock).addClass('hora-promocion');
            $(hourBlock).addClass('hora-disponible');

        });
      }
      var hourBlocks = $('.columna-dia').children('.bloque-hora');
      $.each(hourBlocks, function (key, hourBlock) {
        
        var index = $(hourBlock).data('index');
        
        bookSummary = bookSummaries[index].bookings[0];

        bookDiscount = bookSummary.discount;
        if (bookSummary.time_discount > bookSummary.discount)
        {
          bookDiscount = bookSummary.time_discount;
        }

        console.log(bookDiscount + " - " + block_discount);

        if(bookDiscount < block_discount)
        {
          $(hourBlock).removeClass('hora-disponible');
          $(hourBlock).removeClass('hora-activo');
          $(hourBlock).removeClass('hora-promocion');
          $(hourBlock).addClass('hora-ocupada');
        }
        else
        {
          $(hourBlock).removeClass('hora-ocupada');
          $(hourBlock).addClass('hora-promocion');
          $(hourBlock).addClass('hora-disponible');
        }

      });*/
    }

    function addSession(booking, discount)
    {

        console.log("Booking: ");
        console.log(booking);
        selected = true;
        var b_discount = <%= @service.discount %>;

        bookSummary = bookSummaries[booking.index];
        bookDetails = bookSummary.bookings[0];

        actual_booking = {
          start: generateDate(booking.date, booking.start),
          end: generateDate(booking.date, booking.end),
          provider: bookDetails.provider,
          provider_name: bookDetails.provider_name,
          provider_lock: bookDetails.provider_lock,
          service: $('#serviceId').val(),
          service_name: "<%= @service.name %>",
          online_payable: true,
          has_discount: true,
          discount: discount,
          price: <%= @service.price %>,
          show_price: true,
          has_sessions: true,
          sessions_amount: parseInt("<%= @service.sessions_amount %>")
        };

        checkUserCrossBookings();

    }

    function addBooking(booking, discount)
    {

        console.log("Booking: ");
        console.log(booking);
        selected = true;
        var b_discount = <%= @service.discount %>;

        bookSummary = bookSummaries[booking.index];
        bookDetails = bookSummary.bookings[0];

        actual_booking = {
          start: generateDate(booking.date, booking.start),
          end: generateDate(booking.date, booking.end),
          provider: bookDetails.provider,
          provider_name: bookDetails.provider_name,
          provider_lock: bookDetails.provider_lock,
          service: $('#serviceId').val(),
          service_name: "<%= @service.name %>",
          online_payable: true,
          has_discount: true,
          discount: discount,
          price: <%= @service.price %>,
          show_price: true,
          has_sessions: false,
          sessions_amount: 0
        };

        checkUserCrossBookings();

    }

    function checkUserCrossBookings () {
      $(".alert").alert('close');
      var user = $('#user_id').val();
      var booking_start = actual_booking.start;
      var booking_end = actual_booking.end;
      $.getJSON('/check_user_cross_bookings', {user_id: user, booking_start: booking_start, booking_end: booking_end}, function (result) {
        if (result.crossover) {
          $('#warning').empty();
          var warning = '<div class="alert alert-warning alert-dismissable fade in" style="margin-bottom: 0px;">' +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '<strong>¡Advertencia!</strong> Tienes agendado <em>' + result.booking.service + '</em> con <em>' + result.booking.service_provider + '</em> el <em>' + formattedTime(result.booking.start) + '</em>.' +
          '</div>';
          $('#warning').append(warning);
        };
      });
    }

    function blockBookingBufferHour () {

      for(i=0; i < sessions_buffer.length; i++)
      {

        var date = sessions_buffer[i].start.split(' ')[0];
        var hourBlocks = $('.columna-dia[data-date="' + date + '"]').children('.bloque-hora.hora-promocion');
        $.each(hourBlocks, function (key, hourBlock) {
          var start = $(hourBlock).data('start');
          var end = $(hourBlock).data('end');

          var start_arr = sessions_buffer[i].start.split(" ");
          var start_date = start_arr[0].split("-");
          var start_time = start_arr[1].split(":");

          var end_arr = sessions_buffer[i].end.split(" ");
          var end_date = end_arr[0].split("-");
          var end_time = end_arr[1].split(":");

          var bookingStart = new Date(start_date[0], start_date[1]-1, start_date[2], start_time[0], start_time[1], start_time[2], 0);
          var bookingEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end_time[0], end_time[1], end_time[2], 0);

          var blockStart = new Date(start_date[0], start_date[1]-1, start_date[2], start.split(":")[0], start.split(":")[1], 0, 0);
          var blockEnd = new Date(end_date[0], end_date[1]-1, end_date[2], end.split(":")[0], end.split(":")[1], 0, 0);
          
          //Check for no overlap and negate it.
          if(!(bookingEnd <= blockStart || blockEnd <= bookingStart))
          {
            $(hourBlock).removeClass('hora-disponible');
            $(hourBlock).removeClass('hora-activo');
            $(hourBlock).removeClass('hora-promocion');
            $(hourBlock).addClass('hora-ocupada');
          }

        });    
      }

    }

    function generateDate(date, time) {
      var year = date.substring(0, date.indexOf('-'));
      var month = date.substring(date.indexOf('-') + 1, date.lastIndexOf('-'));
      var day = date.substring(date.lastIndexOf('-') + 1);

      time += ':00';

      return year + '-' + month + '-' + day + ' ' + time;
    }

    function formattedTime (timestamp) {
      var dateString = timestamp;

      var s = new Date(dateString.substring(0, 4), parseInt(dateString.substring(5, 7)) - 1, dateString.substring(8, 10), dateString.substring(11, 13), dateString.substring(14, 16), 0);

      var weekday = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"]

      var monthname = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]

      var day = weekday[s.getDay()];
      var month = monthname[s.getMonth()];

      var formattedStart = day + " " + parseInt(timestamp.substring(8,10)) + " de " + month + " a las " + timestamp.substring(11,16);

      return formattedStart;
    }

    function loadPaymentForm(){

      if(!selected)
      {
        $("#booking-error").append("Debes elegir un horario antes de ir al siguiente paso.");
        return;
      }

      $("#booking-error").empty();

      if(sessions_buffer.length == 0)
      {
        if(actual_booking == null)
        {
          $("#booking-error").append("Debes elegir un horario antes de ir al siguiente paso.");
          return;
        }
        else
        {
          if(actual_booking.has_sessions)
          {
            $('#summary').empty();

            sessions_buffer.push(actual_booking);

            $('.bookings').val(JSON.stringify(sessions_buffer));

            var times_str = "";
            var price = actual_booking.price;
            var min_discount = actual_booking.discount; 

            for(i = 0; i < sessions_buffer.length; i++)
            {
              times_str = times_str + formattedTime(sessions_buffer[i].start) + ' con ' + sessions_buffer[i].provider_name + '.<br />';
              if(sessions_buffer[i].discount < min_discount)
              {
                min_discount = sessions_buffer[i].discount;
              }
            }

            var discount_price = Math.round(price*(100 - min_discount)/100);
            sessions_str = "";

            if(sessions_buffer.length == 1)
            {
              sessions_str = 'Agendaste 1 sesión de un total de ' + actual_booking.sessions_amount;
            }
            else
            {
              sessions_str = 'Agendaste ' + sessions_buffer.length + ' sesiones de un total de ' + actual_booking.sessions_amount;
            }

            $('#summary').append(
              '<tr style="border-top: 0px !important;">' +
                '<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
                '<td style="border-top: 0px !important;" class="light-gray">' + actual_booking.service_name + '</td>' +
              '</tr>' +
              '<tr>' +
                '<td class="dark-gray">¿Dónde?</td>' +
                '<td class="light-gray">' + $('#locationAddress').val() + ', ' + $('#locationDistrict').val() + '</td>' +
              '</tr>'
            );

            $('#summary').append(
              '<tr>' +
                '<td class="dark-gray">¿Cuándo?</td>' +
                '<td class="light-gray">' + times_str + '</td>' +
              '</tr>' +
              '<tr>' +
                '<td class="dark-gray">Sesiones</td>' +
                '<td class="light-gray">' + sessions_str + '</td>' +
              '</tr>'
            );

            $('#summary').append(
              '<tr>' + 
                '<td class="dark-gray">Precio normal</td><td class="light-gray">' + simple_currency(price) + '</td>' +
              '</tr>' +
              '<tr>' +
                '<td class="dark-gray">Descuento</td><td class="light-gray">' + min_discount + '% </td>' +
              '</tr>' +
              '<tr>' +
                '<td class="dark-gray">Precio final</td><td class="light-gray">' + simple_currency(discount_price) + '</td>' +
              '</tr>'
            );  
          }
          else
          {
            $('#summary').empty();

            booking_buffer.push(actual_booking);

            var discount_price = Math.round(actual_booking.price*(100 - actual_booking.discount)/100);

            $('.bookings').val(JSON.stringify(booking_buffer));

            $('#summary').append(
              '<tr style="border-top: 0px !important;">' +
                '<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
                '<td style="border-top: 0px !important;" class="light-gray">' + actual_booking.service_name + '</td>' +
              '</tr>' +
              '<tr>' +
                '<td class="dark-gray">¿Dónde?</td>' +
                '<td class="light-gray">' + $('#locationAddress').val() + ', ' + $('#locationDistrict').val() + '</td>' +
              '</tr>'
            );

            $('#summary').append(
              '<tr>' +
                '<td class="dark-gray">¿Cuándo?</td>' +
                '<td class="light-gray">' + formattedTime(actual_booking.start) + ' con ' + actual_booking.provider_name + '</td>' +
              '</tr>'
            );

            $('#summary').append(
              '<tr>' + 
                '<td class="dark-gray">Precio normal</td><td class="light-gray">' + simple_currency(actual_booking.price) + '</td>' +
              '</tr>' +
              '<tr>' +
                '<td class="dark-gray">Descuento</td><td class="light-gray">' + actual_booking.discount + '% </td>' +
              '</tr>' +
              '<tr>' +
                '<td class="dark-gray">Precio final</td><td class="light-gray">' + simple_currency(discount_price) + '</td>' +
              '</tr>'
            );

          }
        }
      }
      else
      {


          $('#summary').empty();

          sessions_buffer.push(actual_booking);

          $('.bookings').val(JSON.stringify(sessions_buffer));

          var times_str = "";
          var price = actual_booking.price;
          var min_discount = actual_booking.discount; 

          for(i = 0; i < sessions_buffer.length; i++)
          {
            times_str = times_str + formattedTime(sessions_buffer[i].start) + ' con ' + sessions_buffer[i].provider_name + '.<br />';
            if(sessions_buffer[i].discount < min_discount)
            {
              min_discount = sessions_buffer[i].discount;
            }
          }

          var discount_price = Math.round(price*(100 - min_discount)/100);

          if(sessions_buffer.length == 1)
          {
            sessions_str = 'Agendaste 1 sesión de un total de ' + actual_booking.sessions_amount;
          }
          else
          {
            sessions_str = 'Agendaste ' + sessions_buffer.length + ' sesiones de un total de ' + actual_booking.sessions_amount;
          }

          $('#summary').append(
            '<tr style="border-top: 0px !important;">' +
              '<td style="border-top: 0px !important;" class="dark-gray">¿Qué estoy reservando?</td>' +
              '<td style="border-top: 0px !important;" class="light-gray">' + actual_booking.service_name + '</td>' +
            '</tr>' +
            '<tr>' +
              '<td class="dark-gray">¿Dónde?</td>' +
              '<td class="light-gray">' + $('#locationAddress').val() + ', ' + $('#locationDistrict').val() + '</td>' +
            '</tr>'
          );

          $('#summary').append(
            '<tr>' +
              '<td class="dark-gray">¿Cuándo?</td>' +
              '<td class="light-gray">' + times_str + '</td>' +
            '</tr>' +
            '<tr>' +
              '<td class="dark-gray">Sesiones</td>' +
              '<td class="light-gray">' + sessions_str + '</td>' +
            '</tr>'
          );

          $('#summary').append(
            '<tr>' + 
              '<td class="dark-gray">Precio normal</td><td class="light-gray">' + simple_currency(price) + '</td>' +
            '</tr>' +
            '<tr>' +
              '<td class="dark-gray">Descuento</td><td class="light-gray">' + min_discount + '% </td>' +
            '</tr>' +
            '<tr>' +
              '<td class="dark-gray">Precio final</td><td class="light-gray">' + simple_currency(discount_price) + '</td>' +
            '</tr>'
          );  


      }

      $("#calendar-div").hide();
      $("#payment-form-div").show();
      $("#optimizerFirst").hide();
      $("#openCalendarBtn").hide();
      $("#openPayFormBtn").hide();
      $("#payBtn").show();

      $("#backBtn1").attr("disabled", true);
      $("#backBtn1").hide();
      $("#backBtn2").attr("disabled", false);
      $("#backBtn2").show();

      $("#payBtn").attr("disabled", false);
      $("#openPayFormBtn").attr("disabled", true);

    }

    $("#openPayFormBtn").click(function(){
      loadPaymentForm();
    });

    $("#openCalendarBtn").click(function(){
      loadCalendar();
    });

    $("#payBtn").click(function(){


      $("#bookingForm").submit();
      
    });

    $("#backBtn1").click(function(){
      resetModal();
    });

    $("#backBtn2").click(function(){
      back2();
    });

    $('[name="changeProvider"]').on('click', function(event){

      var localId = $("#locationId").val();
      
      var start_date = $("#optimizerDateSelector").val();


      $("#loader-div").show();


      var selects = [];

      selects.push({
        service: $("#serviceId").val(),
        provider: $('input[name="changeProvider"]:checked').val()
      });

      $('#providerOptimizerSelector[value="' + $('input[name="changeProvider"]:checked').val() + '"]').attr("selected", true);

      var data;

      if($("#pickerSelected").val()!="")
      {
        data = {local: localId, serviceStaff: JSON.stringify(selects), date: $("#pickerSelected").val(), mandatory_discount: true}
      }
      else
      {
        data = {local: localId, serviceStaff: JSON.stringify(selects), mandatory_discount: true}
      }

      if (promoCalendar) {
        promoCalendar.rebuild('/promotion_hours', data);
      }
      else {
        promoCalendar = new PromoCalendar('/promotion_hours', data);
      }

      $("#loader-div").hide();

      blockBookingBufferHour();

    });

    $(document).on('calendarBuilded', function (e) {

      blockBookingBufferHour();
  
    });

    function resetModal()
    {

      first_session = null;
      sessions_buffer = [];
      booking_buffer = [];
      actual_booking = null;
      sessions_left = parseInt("<%= @service.sessions_amount %>");
      selected = false;
      block_discount = 0;
      $("#booking-error").empty();

      $("#selectProviderModal .modal-dialog").removeClass("calendar-modal");
      $("#calendar-div").hide();
      $("#payment-form-div").hide();
      $("#optimizerFirst").show();
      $("#openCalendarBtn").show();
      $("#openPayFormBtn").hide();
      $("#payBtn").hide();
      $(".btn-add-session").attr("disabled", false);

      $("#backBtn2").attr("disabled", true);
      $("#backBtn2").hide();
      $("#backBtn1").attr("disabled", true);
      $("#backBtn1").hide();

      $("#payBtn").attr("disabled", true);
      $("#openPayFormBtn").attr("disabled", true);

      block_discount = 0;
      $("#current-discount").empty();
      $("#current-discount-div").hide();


      $("#sessions-summary-tr").empty();
      $("#sessions-left").html("<%= @service.sessions_amount %>");
      $("#selected-hour-body").empty();
    }

    function back2()
    {

      first_session = null;
      sessions_buffer = [];
      booking_buffer = [];
      actual_booking = null;
      sessions_left = parseInt("<%= @service.sessions_amount %>");
      selected = false;
      block_discount = 0;

      $("#booking-error").empty();

      $("#current-discount").empty();
      $("#current-discount-div").hide();
      $("#optimizerFirst").hide();
      $("#loader-div").show();
      $("#openCalendarBtn").hide();
      $("#backBtn2").attr("disabled", true);
      $("#backBtn2").hide();
      $("#backBtn1").attr("disabled", false);
      $("#backBtn1").show();

      $("#payment-form-div").hide();
      $("#summary").empty();
      $("#payBtn").hide();
      $(".btn-add-session").attr("disabled", false);

      $("#sessions-summary-tr").empty();
      $("#sessions-left").html("<%= @service.sessions_amount %>");
      $("#selected-hour-body").empty();
      
      loadCalendar();
      blockBookingBufferHour();
      blockDiscounts();
      
    }

  </script>

<% end %>