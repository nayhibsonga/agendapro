<!-- Chartkick se usa antes de q se carge la pagina -->
<script type="text/javascript">
  var Chartkick = {"language": "es"};
</script>
<%= javascript_include_tag "//www.google.com/jsapi", "chartkick" %>

<%= content_tag "div", id: "products_data", data: { products: Product.where(company_id: current_user.company_id).to_json } do %>
<% end %>

<div class="container-fluid">
  <div class="row report-control-row" style="margin-top: 20px;">
    <div class="col-sm-10">
      <div class="form-group">
        <label for="from" class="col-sm-1 control-label">Desde:</label>
        <div class="col-sm-5">
          <input type="text" id="from" name="from" class="form-control payments_select" value="<%= Time.now.strftime("%Y-%m-%d") %>">
        </div>
        <label for="from" class="col-sm-1 control-label">Hasta:</label>
        <div class="col-sm-5">
          <input type="text" id="to" name="to" class="form-control payments_select" value="<%= Time.now.strftime("%Y-%m-%d") %>">
        </div>
      </div>
      <div class="form-group">
        <label for="location_ids[]" class="col-sm-1 control-label" style="margin-top: 20px;">Locales:</label>
        <div class="col-sm-4">
          <% for location in Location.where(company_id: current_user.company_id, active: true).accessible_by(current_ability) do %>
            <label class="checkbox-inline" style="margin-top: 20px;">
              <%= check_box_tag 'location_ids[]', location.id, params[:location_ids].blank? ? true : params[:location_ids] && params[:location_ids].includes(location.id), {class: "payments_select payment_location"} %>
              <%= location.name.humanize %>
            </label>
          <% end %>
        </div>
        <label for="payment_method_ids[]" class="col-sm-1 control-label" style="margin-top: 20px;">Tipo:</label>
        <div class="col-sm-6">
          <% for payment_method in PaymentMethod.all do %>
            <label class="checkbox-inline" style="margin-top: 20px;">
              <%= check_box_tag 'payment_method_ids[]', payment_method.id, params[:payment_method_ids].blank? ? true : params[:payment_method_ids] && params[:payment_method_ids].includes(payment_method.id), {class: "payments_select payment_method"} %>
              <%= payment_method.name.humanize %>
            </label>
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-sm-2">
      <div class="form-group">
        <a class='btn btn-green' id="new_payment_button" onclick="loadPayment(0);"><i class="fa fa-plus"> </i> Nuevo Pago</a>
      </div>
    </div>
  </div>
  <div class="row" style="border-top: 1px solid #e3e3e3; margin-top: 10px;">
    <div class="col-sm-12">
      <div id='render_content'>
      </div>
    </div>
  </div>
</div>

<% content_for :modals do %>
  <div class="modal fade" id="newPaymentModal" role="dialog" aria-labelledby="newPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title booking-modal-title" id="newPaymentModalLabel">Pago</h4>
        </div>
        <div class="modal-body payment-modal-body">
          <%= form_for @payment, html: {class: "form-horizontal"} do |f| %>
          <div class="row" id="client_location_row">
            <div class="col-sm-6">
              <div class="form-group has-feedback">
                <label for="full_name" class="col-sm-4 control-label">Nombre Cliente</label>
                <div class="col-sm-8">
                  <div class="input-group">
                    <input type="text" id="full_name" class="form-control" placeholder="Buscar clientes..." name="full_name">
                    <span class="input-group-btn">
                      <button class="btn btn-red" type="button" id="xButton"><i class="fa fa-times-circle"></i></button>
                    </span>
                  </div>
                  <span class="help-block"></span>
                  <ul id="full_name_suggestions"></ul>
                </div>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group has-feedback">
                <label for="payment_location_id" class="col-sm-4 control-label">Local</label>
                <div class="col-sm-8">
                  <%= collection_select(:payment, :location_id, Location.where(company_id: current_user.company_id, active: true).accessible_by(current_ability), :id, :name, {}, {class: "form-control"} ) %>
                </div>
              </div>
            </div>
          </div>
          <div class="row" id="payment_bookings_row">
            <div class="col-sm-12">
              <table class="table table-bordered table-white-rows">
                <thead>
                  <tr>
                    <th><a id="payment_past_bookings_button" class="btn btn-green btn-xs"><i class="fa fa-plus"></i></a></th>
                    <th>Servicio</th>
                    <th>Prestador</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th style="width: 15%;">Precio Normal</th>
                    <th style="width: 15%;">Descuento</th>
                    <th style="width: 15%;">Precio</th>
                  </tr>
                </thead>
                <tbody id="payment-bookings-table">
                  <tr class="tr-strong">
                    <td colspan="4"></td>
                    <td>Total:</td>
                    <td id="booking_total_normal_price">$ 0</td>
                    <td id="booking_total_discount">0 %</td>
                    <td id="booking_total_price">$ 0</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <% if Service.where(company_id: current_user.company_id, has_sessions: true).count > 0 %>
          <div class="row" id="payment_sessions_row">
            <div class="col-sm-12">
              <table class="table table-bordered table-white-rows">
                <thead>
                  <tr>
                    <th><a id="payment_past_sessions_button" class="btn btn-green btn-xs"><i class="fa fa-plus"></i></a></th>
                    <th>Servicio</th>
                    <th>Sesiones</th>
                    <th style="width: 15%;">Precio Normal</th>
                    <th style="width: 15%;">Descuento</th>
                    <th style="width: 15%;">Precio</th>
                  </tr>
                </thead>
                <tbody id="payment-sessions-table">
                  <tr class="tr-strong">
                    <td colspan="2"></td>
                    <td>Total:</td>
                    <td id="session_total_normal_price">$ 0</td>
                    <td id="session_total_discount">0 %</td>
                    <td id="session_total_price">$ 0</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <% end %>
          <% if Product.where(company_id: current_user.company_id).count > 0 %>
          <div class="row" id="payment_products_row">
            <div class="col-sm-12">
              <table class="table table-bordered table-white-rows">
                <thead>
                  <tr>
                    <th><a id="payment_products_button" class="btn btn-green btn-xs"><i class="fa fa-plus"></i></a></th>
                    <th>Producto</th>
                    <th>Detalles</th>
                    <th style="width: 15%;">Precio Normal</th>
                    <th style="width: 15%;">Cantidad</th>
                    <th style="width: 15%;">Descuento</th>
                    <th style="width: 15%;">Precio</th>
                  </tr>
                </thead>
                <tbody id="payment-products-table">
                  <tr class="tr-strong">
                    <td colspan="2"></td>
                    <td>Total:</td>
                    <td id="product_total_normal_price">$ 0</td>
                    <td id="product_total_quantity">0</td>
                    <td id="product_total_discount">0 %</td>
                    <td id="product_total_price">$ 0</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <% end %>
          <div class="row">
            <div class="col-sm-6">
              <%= f.hidden_field :id %>
              <%= f.hidden_field :client_id %>
              <div class="form-group">
                <%= f.label :receipt_type_id, "Comprobante de Pago", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.collection_select :receipt_type_id, ReceiptType.all.order(:name), :id, :name, {selected: ReceiptType.find_by_name("Boleta").id}, { class: "form-control" }%>
                </div>
              </div>
              <div class="form-group">
                <%= f.label :payment_date, "Fecha de Pago", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.text_field :payment_date, class: "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                <%= f.label :payment_method_id, "Tipo de Pago", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.select :payment_method_id, options_for_select(PaymentMethod.where(id: @company_setting.payment_method_settings.where(active: true).pluck(:payment_method_id)).order(:name).map{ |c| [c.name, c.id, {'data-installments'=> c.name == "Tarjeta de Crédito" ? true : false, 'data-number'=> c.name == "Efectivo" ? false : true, 'data-bank'=> c.name == "Cheque" ? true : false, 'data-number-required'=> @company_setting.payment_method_settings.where(number_required: true).pluck(:payment_method_id).include?(c.id) ? true : false, 'data-custom-method'=> c.name == "Otro" ? true : false }] }), {}, {class: "form-control"} %>
                </div>
              </div>
              <div id="payment_method_type_group" class="form-group">
                <%= f.label :payment_method_type_id, "Tipo de Tarjeta", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.collection_select :payment_method_type_id, PaymentMethodType.all.order(:name), :id, :name, {include_blank: true}, { class: "form-control" }%>
                </div>
              </div>
              <div id="company_payment_method_group" class="form-group">
                <%= f.label :company_payment_method_id, "Otros Medios de Pago", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.select :company_payment_method_id, options_for_select(CompanyPaymentMethod.where(company_id: current_user.company_id).where(active: true).order(:name).map{ |c| [c.name, c.id, { 'data-number-required'=> c.number_required ? true : false}] }), {}, {class: "form-control"} %>
                </div>
              </div>
              <div id="bank_id_group" class="form-group">
                <%= f.label :bank_id, "Banco", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.collection_select :bank_id, Bank.all.order(:name), :id, :name, {include_blank: true}, { class: "form-control" }%>
                </div>
              </div>
              <div id="payment_method_number_group" class="form-group">
                <%= f.label :payment_method_number, "Código de Autorización", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.text_field :payment_method_number, class: "form-control" %>
                </div>
              </div>
              <div id="installments_group" class="form-group">
                <%= f.label :installments, "Cuotas", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.number_field :installments, class: "form-control" %>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-6">
              <div class="form-group has-feedback">
                <%= f.label :notes, "Notas", class: "col-sm-4 control-label" %>
                <div class="col-sm-8">
                  <%= f.text_area :notes, class: "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-sm-6">
              <% if @company_setting.staff_code %>
                  <div class="form-group has-feedback">
                    <%= label_tag :payment_staff_code, "Código de Empleado", class: "col-sm-4 control-label" %>
                    <div class="col-sm-8">
                      <%= text_field_tag :payments_staff_code, '',{class: "form-control", required: true} %>
                      <span class="help-block"></span>
                      <span class="form-control-feedback"></span>
                    </div>
                  </div>
              <% end %>
              <div class="form-group">
                <div class="col-sm-4 col-sm-offset-4">
                  <a class="btn btn-red btn-block" id="delete_payment_button">Eliminar Pago</a>
                </div>
                <div class="col-sm-4">
                  <%= f.submit "Guardar Pago", class: "btn btn-green btn-block", id: "save_payment_button" %>
                </div>
              </div>
            </div>
          </div>
          <% end %>
        </div>
        <div class="modal-footer booking-modal-footer">
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade modalOverModal" id="paymentBookingModal" tabindex="-1" role="dialog" aria-labelledby="Agregar Reserva al Pago" aria-hidden="true">
    <div class="modal-dialog" style="width: auto;">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar"><i class="fa fa-times" aria-hidden="true"></i></button>
          <h3 class="modal-title" id="paymentBookingModalTitle" style="line-height: 1.1;">Agregar Reserva al Pago</h3>
        </div>
        <div class="modal-body" id="paymentBookingModalBody">
          <div class="row">
            <div class="col-sm-12">
              <div class="fixed-table">
                <h4>Modificaciones a la Reserva:</h4>
                <table class="table">
                  <thead>
                    <tr>
                      <th></th>
                      <th>Servicio</th>
                      <th>Prestador</th>
                      <th>Fecha</th>
                      <th>Hora</th>
                      <th>Precio Normal</th>
                      <th>Descuento</th>
                      <th>Precio</th>
                    </tr>
                  </thead>
                  <tbody id="payment-past-bookings-table">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal" aria-label="Cerrar">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "payments" %>
<% end %>

<% content_for :scripts do %>
  <%= javascript_include_tag "payment_index" %>
  <script type="text/javascript">
  $(function() {
    $('#new_payment').validate({
      errorPlacement: function(error, element) {
        error.appendTo(element.next());
      },
      rules: {
        'payment[payment_date]': {
          required: true
        }
      },
      highlight: function(element) {
        $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
        $(element).parent().children('.form-control-feedback').removeClass('fa fa-check').addClass('fa fa-times');
      },
      success: function(element) {
        $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
        $(element).parent().parent().children('.form-control-feedback').removeClass('fa fa-times').addClass('fa fa-check');
        $(element).parent().empty()
      },
      submitHandler: function(form) {
        $('#save_payment_button').attr('disabled', true);
        $("#save_payment_button").html('<i class="fa fa-spinner fa-spin"></i>');
        savePayment();

        return false;
      }
    });
  });
  </script>
<% end %>