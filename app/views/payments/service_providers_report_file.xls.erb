<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:x="urn:schemas-microsoft-com:office:excel"
  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:html="http://www.w3.org/TR/REC-html40">

    <% @service_providers.each do |service_provider| %>

      <Worksheet ss:Name="Reporte de <%= service_provider.public_name %>">

        <Table>

            <ss:Column ss:Width="100"/>
            <ss:Column ss:Width="100"/>
            <ss:Column ss:Width="100"/>
            <ss:Column ss:Width="100"/>
            <ss:Column ss:Width="100"/>
            <ss:Column ss:Width="100"/>
            <ss:Column ss:Width="100"/>
            <ss:Column ss:Width="100"/>

            <%
              payment_products = PaymentProduct.where(seller_id: service_provider.id, seller_type: 0, payment_id: Payment.where(payment_date: @from..@to).pluck(:id))
              mock_bookings = MockBooking.where(service_provider_id: service_provider.id, payment_id: Payment.where(payment_date: @from..@to).pluck(:id))
              bookings = Booking.where.not(status_id: Status.find_by_name("Cancelado").id).where('payment_id is not null').where(service_provider_id: service_provider.id, start: @from.beginning_of_day..@to.end_of_day)
            %>

            <Row>
              <Cell><Data ss:Type="String">Productos</Data></Cell>
            </Row>

            <Row>
              <Cell><Data ss:Type="String">Fecha de pago</Data></Cell>
              <Cell><Data ss:Type="String">Sku</Data></Cell>
              <Cell><Data ss:Type="String">Categoría</Data></Cell>
              <Cell><Data ss:Type="String">Marca</Data></Cell>
              <Cell><Data ss:Type="String">Nombre</Data></Cell>
              <Cell><Data ss:Type="String">Cantidad/Unidad</Data></Cell>
              <Cell><Data ss:Type="String">Precio</Data></Cell>
              <Cell><Data ss:Type="String">Cantidad</Data></Cell>
              <Cell><Data ss:Type="String">Comisión</Data></Cell>
            </Row>

            <% payment_products.each do |payment_product| %>

              <Row>
                <Cell><Data ss:Type="String"><%= payment_product.payment.payment_date.to_s %></Data></Cell>
                <Cell><Data ss:Type="String"><%= payment_product.product.sku %></Data></Cell>
                <Cell><Data ss:Type="String"><%= payment_product.product.product_category.name %></Data></Cell>
                <Cell><Data ss:Type="String"><%= payment_product.product.product_brand.name %></Data></Cell>
                <Cell><Data ss:Type="String"><%= payment_product.product.name %></Data></Cell>
                <Cell><Data ss:Type="String"><%= payment_product.product.product_display.name %></Data></Cell>
                <Cell><Data ss:Type="Number"><%= payment_product.price %></Data></Cell>
                <Cell><Data ss:Type="Number"><%= payment_product.quantity %></Data></Cell>
                <Cell><Data ss:Type="Number"><%= payment_product.product.get_commission * payment_product.quantity %></Data></Cell>
              </Row>
            <% end %>

            <Row>
              <Cell><Data ss:Type="String"></Data></Cell>
            </Row>

            <Row>
              <Cell><Data ss:Type="String">Servicios</Data></Cell>
            </Row>

            <Row>
              <Cell><Data ss:Type="String">Fecha de pago</Data></Cell>
              <Cell><Data ss:Type="String">Servicio</Data></Cell>
              <Cell><Data ss:Type="String">Precio</Data></Cell>
              <Cell><Data ss:Type="String">Comisión</Data></Cell>
            </Row>

            <% mock_bookings.each do |mock_booking| %>

              <Row>
                <Cell><Data ss:Type="String"><%= mock_booking.payment.payment_date.to_s %></Data></Cell>
                <Cell><Data ss:Type="String">
                  <% if mock_booking.service_id.nil? %>
                    Sin información
                  <% else %>
                    <%= mock_booking.service.name %>
                  <% end %>
                </Data></Cell>
                <Cell><Data ss:Type="Number"><%= mock_booking.price %></Data></Cell>
                <Cell><Data ss:Type="Number"><%= mock_booking.get_commission %></Data></Cell>
              </Row>
            <% end %>

            <Row>
              <Cell><Data ss:Type="String"></Data></Cell>
            </Row>

            <Row>
              <Cell><Data ss:Type="String">Reservas</Data></Cell>
            </Row>

            <Row>
              <Cell><Data ss:Type="String">Fecha de pago</Data></Cell>
              <Cell><Data ss:Type="String">Fecha de reserva</Data></Cell>
              <Cell><Data ss:Type="String">Servicio</Data></Cell>
              <Cell><Data ss:Type="String">Precio</Data></Cell>
              <Cell><Data ss:Type="String">Comisión</Data></Cell>
            </Row>

            <% bookings.each do |booking| %>

              <Row>
                <Cell><Data ss:Type="String"><%= booking.payment.payment_date.to_s %></Data></Cell>
                <Cell><Data ss:Type="String"><%= booking.start.to_s %></Data></Cell>
                <Cell><Data ss:Type="String"><%= booking.service.name %></Data></Cell>
                <Cell><Data ss:Type="Number"><%= booking.price %></Data></Cell>
                <Cell><Data ss:Type="Number"><%= booking.get_commission %></Data></Cell>
              </Row>
            <% end %>


        </Table>

      </Worksheet>

    <% end %>

</Workbook>