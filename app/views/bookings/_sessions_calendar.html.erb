<div class="modal-dialog calendar-modal">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h3 class="modal-title" id="optimizerTitle" style="line-height: 1.1;">Reservar</h3>
        </div>
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row staff">
              <div class="col-md-3 step2-left-col" style="max-height: 346px; overflow-y: hidden;<%= 'display:none;' if @booking.location.company.company_setting.provider_preference == 2 %>">
                <div class="staff-wrapper">
                  <span class="subtitulos-workflow">Elige Staff<br /> y Horario &nbsp;</span><span><i class="fa fa-clock-o gray-icon"></i>&nbsp;<i class="fa fa-user gray-icon"></i></span>
                  <div class="sub-workflow dark-gray">Selecciona un staff para ver su horario</div>
                    <div class="panel panel-default light-gray">
                      <ul class="list-group" id="staff-selector">
                      </ul>
                    </div>
                </div>
                <div style="clear: both;">
                </div>
                <div style="clear: both;">
                </div>
              </div>
              <div class="col-md-<%= @booking.location.company.company_setting.provider_preference == 2 ? '12' : '9' %>" id="staff-calendar">
                <div class="panel panel-info <%= 'full-margin' if @booking.location.company.company_setting.provider_preference == 2 %>">
                  <div class="calendar-head">
                    <div class="panel-title">
                      <div class="row">
                        <div class="col-xs-1">
                          <button type="button" class="btn btn-default" id="prev"><i class="fa fa-chevron-left"></i></button>
                        </div>
                        <div class="col-xs-8">
                          <span class="tittle"></span>
                        </div>
                        <div class="col-xs-2">
                          <span class="date-span">
                            Ir a fecha&nbsp;<i class="fa fa-calendar-o"></i>
                            <input type="text" id="datepicker" name="date" />
                          </span>
                        </div>
                        <div class="col-xs-1">
                          <button type="button" class="btn btn-default pull-right" id="next"><i class="fa fa-chevron-right"></i></button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="days-row">
                  </div>
                  <div class="panel-body">
                    <div class="horario">
                      <!-- <%= image_tag "ajax-loader.gif", :alt => "Loader", :id => "calendar-loader" %> -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row change-bar">
              <div class="col-xs-12 col-md-5 col-md-push-2">
                <p class="p-label"><span class="wf-label label-available">&nbsp;</span> Disponible<span class="wf-label label-past">&nbsp;</span> No Disponible<span class="wf-label label-unavailable">&nbsp;</span> Ocupado</p>
              </div>
              <div class="col-xs-4 col-md-2 col-md-pull-5">
                <div class="btn-change btn-prev">
                  <a class="prev2 prev-btn"><i class="fa fa-chevron-left prev-arrow"></i> Anterior</a>
                </div>
              </div>
              <div class="col-xs-8 col-md-5">
                <a class="btn btn-large btn-green btn-add-service" style="padding: 5px 12px; margin-right: 10px; font-size: 20px;" onclick="addNewService()"><i class="fa fa-plus"></i> Agregar Otro Servicio</a>
                <div class="btn-change btn-next">
                  <a class="next2 next-btn">Siguiente <i class="fa fa-chevron-right next-arrow"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn session-btn btn-orange" id="optimizerBackBtn" style="display: none;"><i class="fa fa-chevron-left"></i>&nbsp;Atr√°s</button>
            <button type="button" class="btn session-btn btn-orange" id="nextButton" style="display: none;">Siguiente&nbsp;<i class="fa fa-chevron-right"></i></button>
            <button type="button" class="btn session-btn" id="openCalendarBtn"><i class="fa fa-calendar-o"></i>&nbsp;Ver calendario</button>
            <button type="button" class="btn session-btn" id="openOptimizerBtn"><i class="fa fa-calendar-o"></i>&nbsp;Sugerir hora</button>
            <!--<button href="#" class="btn btn-red" data-dismiss="modal">Cerrar</button>-->
        </div>
    </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->


<input type="hidden" id="service_id" value="<%= @booking.service_id %>" />
<input type="hidden" id="selectedLocal" value="<%= @booking.location_id %>" />
<input type="hidden" id="selectedProvider" value="<%= @selectedProvider %>" />


<script type="text/javascript">

var calendar;
var staffSelected;

function loadCalendar () {
  if($("#service_id").val() != ""){
    $('#staff-selector-spinner').show();
    $('#staff-selector > .list-group-item').hide();
    $('.horario').hide();
    selected = false;
    var serviceId = $("#service_id").val();

    $.getJSON('/providers_services', {id: serviceId, local: $('#selectedLocal').val()}, function (providers) {
      $('#staff-selector').empty();
      $('#staff-selector').append(
        '<li id="staff-selector-spinner" class="text-center" style="color: #ccc; display: none;"><i class="fa fa-spinner fa-spin fa-lg"></i></li>'
      );
      if ($('#providerPreference').data('provider-preference') != 1) {
        if (providers.length > 1 || $('#providerPreference').data('provider-preference') == 2) {
          $('#staff-selector').append(
            '<li class="list-group-item">' +
              '<div class="radio">' +
                '<label>' +
                  '<input type="radio" name="staffRadio" value="0">' +
                  '<p>Sin Preferencia</p>' +
                '</label>' +
              '</div>' +
            '</li>'
          );
        }
      }
      if ($('#providerPreference').data('provider-preference') != 2) {
        $.each(providers, function (key, provider) {
          $('#staff-selector').append(
            '<li class="list-group-item">' +
              '<div class="radio">' +
                '<label>' +
                  '<input type="radio" name="staffRadio" value="' + provider.id + '">' +
                  '<p>' + provider.public_name + '</p>' +
                '</label>' +
              '</div>' +
            '</li>'
          );
        });
      }


      $('[name="staffRadio"]').on('click', function(event) {

        $('.horario').show();
        
        // if (event.target.getAttribute('value') == 0) {
        //  $('#provider_lock').val(false);
        // }
        // else {
        //  $('#provider_lock').val(true);
        // }
        if ($(this).val() != staffSelected) {

          var data;
          if($("#datepicker").val()!="") {
            data = {
              provider: event.target.getAttribute('value'),
              local: $('#selectedLocal').val(),
              service: $("#service_id").val(),
              date: $("#datepicker").val()
            }
          } else {
            data = {
              provider: event.target.getAttribute('value'),
              local: $('#selectedLocal').val(),
              service: $("#service_id").val()
            }
          }

          staffSelected = $(this).val();
          if (calendar) {
            calendar.rebuild('/available_hours_week_html', data);
          }
          else {
            calendar = new Calendar('/available_hours_week_html', data);
          }

          // $("#calendar-loader").hide();

        };

        $(document).on('hourClick', function (e) {
          addBooking(e);
        });

        $(function () {
          $('.prev-btn').click(function () {
            selected = false;
          });
          $('.next-bn').click(function () {
            selected = false;
          });
        });
      });

      var radios = $('input[name=staffRadio]');
      radios.on('change', function() {
        $('#staff-selector-spinner').show();
        $('#staff-selector > .list-group-item').hide();
        radios.each(function() {
          var radio = $(this);
          radio.closest('.list-group-item')[radio.is(':checked') ? 'addClass' : 'removeClass']('selected-wf-option');
        });
      });


      if ($('#providerPreference').data('provider-preference') != 1) {
        $('[name="staffRadio"]').first().prop("checked", true);
        $('[name="staffRadio"]').first().closest('.list-group-item').addClass('selected-wf-option');
        $('.horario').show();
        // $('#provider_lock').val(false);

        staffSelected = $('[name="staffRadio"]').first().val();

        var data;
        if($("#datepicker").val()!="") {
          data = {
            provider: $('[name="staffRadio"]').first().val(),
            local: $('#selectedLocal').val(),
            service: $("#service_id").val(),
            date: $("#datepicker").val()
          }
        } else {
          data = {
            provider: $('[name="staffRadio"]').first().val(),
            local: $('#selectedLocal').val(),
            service: $("#service_id").val()
          }
        }

        // $("#calendar-loader").show();
        
          

        if (calendar) {
          calendar.rebuild('/available_hours_week_html', data);
        }
        else {
          calendar = new Calendar('/available_hours_week_html', data);
        }

        // $("#calendar-loader").hide();


        $('#foo4').trigger('updateSizes');

        $(document).on('hourClick', function (e) {
          addBooking(e);
        });

        $(function () {
          $('.prev-btn').click(function () {
            selected = false;
          });
          $('.next-btn').click(function () {
            selected = false;
          });
        });
      }

    });

  }
  
}

$(document).ready(function(){
  loadCalendar();
});

</script>